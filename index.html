<!DOCTYPE html>
<html lang="ru" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª v4.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-to-tiff@1.1.1/dist/canvas-to-tiff.min.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; color: #333; }
        .header { background: white; padding: 15px 30px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header h1 { color: #4a4a4a; margin-bottom: 15px; font-size: 24px; }
        .progress-bar { display: flex; list-style: none; padding: 0; justify-content: space-between; max-width: 900px; margin: auto; }
        .progress-bar a { flex: 1; text-align: center; font-weight: bold; color: #718096; position: relative; text-decoration: none; cursor: not-allowed; opacity: 0.5; padding: 8px 0; }
        .progress-bar a.unlocked { cursor: pointer; opacity: 1; }
        .progress-bar a::before { content: attr(data-step); display: block; margin: 0 auto 5px; width: 30px; height: 30px; line-height: 30px; border: 2px solid #cbd5e0; border-radius: 50%; background: #fff; color: #cbd5e0; transition: all 0.3s ease; }
        .progress-bar a.active::before { border-color: #5a67d8; color: #5a67d8; font-weight: 700; transform: scale(1.1); }
        .progress-bar a.completed::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        .progress-bar a.completed + a.unlocked::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #5a67d8; z-index: -1; transition: background 0.3s ease; }
        .progress-bar a:not(:first-child)::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #cbd5e0; z-index: -1; }
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .toolbar { text-align: right; margin-bottom: 20px; }
        .step-section { background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 8px 40px rgba(0,0,0,0.08); margin-bottom: 40px; border-left: 5px solid #e2e8f0; transition: all 0.5s ease-out; }
        .step-section.active { border-left-color: #5a67d8; }
        .step-section.completed { border-left-color: #48bb78; }
        .step-section.is-locked { display: none; }
        .step-section h2 { color: #5a67d8; margin-bottom: 10px; font-size: 28px; display: flex; align-items: center; }
        .step-section h2 .step-number { background: #5a67d8; color: white; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 15px; flex-shrink: 0; }
        .step-section > p { color: #666; margin-bottom: 25px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        .photo-upload-area { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 40px; text-align: center; background: #f7fafc; transition: all 0.3s ease; cursor: pointer; }
        .photo-upload-area:hover { border-color: #5a67d8; }
        #photo-container { position: relative; display: inline-block; margin-top: 20px; user-select: none; }
        #step2-photo { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block;}
        .assigned-point { position: absolute; width: 14px; height: 14px; background: rgba(229, 62, 62, 0.7); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); user-select: none; transform: translate(-50%, -50%); cursor: pointer; z-index: 15; }
        #lines-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .image-upload-input { display: block; margin-bottom: 20px; }
        #step3-image-preview { min-height: 150px; border: 2px dashed #cbd5e0; padding: 10px; text-align: center; background: #f9f9f9; border-radius: 10px;}
        .deformation-stage-wrapper { text-align: center; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 10px; }
        .deformation-stage { position: relative; width: 100%; min-height: 600px; background-color: #f0f2f5; cursor: grab; }
        .deformation-stage.is-panning { cursor: grabbing; }
        #deformation-canvas { position: absolute; top: 0; left: 0; }
        .control-point { position: absolute; width: 12px; height: 12px; background: rgba(255, 255, 255, 0.5); border: 2px solid #e53e3e; border-radius: 50%; cursor: crosshair; transform: translate(-50%, -50%); z-index: 20; }
        .controls-panel, .zoom-controls { background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center; border: 1px solid #e2e8f0; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .pan-controls button { width: 40px; height: 40px; font-size: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .zoom-controls { grid-template-columns: 1fr auto; }
        .action-button { display: inline-block; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; background: #5a67d8; color: white; margin-left: 10px; }
        .action-button:disabled { background: #cbd5e0; color: #a0aec0; cursor: not-allowed; }
        .clear-points-btn { background: #e53e3e; }
        .new-project-btn { background: #f6ad55; }
        #finalResult { text-align: center; padding: 10px; background: #f7fafc; border-radius: 10px; border: 1px solid #e2e8f0; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #result-canvas { max-width: 100%; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); background: black; }
    </style>
</head>
<body>
    <header class="header">
        <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-—Ä–µ–¥–∞–∫—Ç–æ—Ä</h1>
        <nav class="progress-bar" id="progressBar"></nav>
    </header>
    <div class="container">
        <div class="toolbar">
            <button class="action-button new-project-btn" onclick="startNewProject()">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
        </div>
        <div id="steps-container"></div>
    </div>

<script>
// ===================================================================
// == –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –®–ê–ë–õ–û–ù–´ ==
// ===================================================================
const STEPS_CONFIG = [
    { id: 1, title: '–§–æ—Ç–æ' }, { id: 2, title: '–¢–æ—á–∫–∏' }, { id: 3, title: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
    { id: 4, title: '–†–µ–¥–∞–∫—Ç–æ—Ä' }, { id: 5, title: '–≠–∫—Å–ø–æ—Ä—Ç' }
];

const STEPS_HTML = {
    1: `<h2><span class="step-number">1</span>–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h2><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —Å–¥–µ–ª–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é ¬´–£–º–Ω–æ–π –ù–∞—Å–∞–¥–∫–∏¬ª.</p><div class="photo-upload-area" id="photoUploadArea"><h3>üì∏ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</h3></div><input type="file" id="photoInput" accept="image/*" style="display: none;">`,
    2: `<h2><span class="step-number">2</span>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2><p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏).</p><div id="photo-container"><img id="step2-photo" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç—É—Ä–∞"><svg id="lines-svg"></svg></div><div style="text-align: right; margin-top: 20px;"><button class="action-button clear-points-btn" onclick="clearAllPoints()">–û—á–∏—Å—Ç–∏—Ç—å</button><button class="action-button" id="step2-next" disabled>–î–∞–ª–µ–µ</button></div>`,
    3: `<h2><span class="step-number">3</span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≥–æ–±–æ</h2><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–æ—Ç–∏–ø).</p><input type="file" id="step3-image-input" class="image-upload-input" accept="image/*"><div id="step3-image-preview"><p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</p></div>`,
    4: `<h2><span class="step-number">4</span>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2><p><b>–ö–æ–ª–µ—Å–æ –º—ã—à–∏</b> - –∑—É–º. <b>–ó–∞–∂–º–∏—Ç–µ Alt + –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞</b> - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞.</p><div class="deformation-stage-wrapper"><div class="deformation-stage" id="deformationStage"><canvas id="deformation-canvas"></canvas></div></div><div class="zoom-controls"><div class="control-group"><label>–ú–∞—Å—à—Ç–∞–± —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: <span id="zoomLevel">100</span>%</label><input type="range" id="zoomSlider" min="10" max="500" value="100"></div><button class="action-button" onclick="resetEditorView()">–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥</button></div><div class="controls-panel"><div class="control-group"><label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacityValue">100</span>%</label><input type="range" id="opacitySlider" min="0" max="100" value="100"></div><div class="control-group"><label>–ú–∞—Å—à—Ç–∞–±: <span id="scaleValue">100</span>%</label><input type="range" id="scaleSlider" min="50" max="150" value="100"></div><div class="control-group"><label>–í—Ä–∞—â–µ–Ω–∏–µ: <span id="rotationValue">0</span>¬∞</label><input type="range" id="rotationSlider" min="-180" max="180" value="0"></div><div class="control-group pan-controls"><label>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label><div><button onclick="panImage(0, -5)">‚Üë</button><button onclick="panImage(0, 5)">‚Üì</button><button onclick="panImage(-5, 0)">‚Üê</button><button onclick="panImage(5, 0)">‚Üí</button></div></div></div><div style="text-align: right;"><button class="action-button" id="step4-next">–î–∞–ª–µ–µ</button></div>`,
    5: `<h2><span class="step-number">5</span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2><p>–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏ –∏ —Å–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É —Ñ–∞–π–ª.</p><div class="form-row"><div class="form-group"><label>DPI:</label><input type="number" id="printDPI" value="2700"></div><div class="form-group"><label>–î–∏–∞–º–µ—Ç—Ä —Å–ª–∞–π–¥–∞ (–º–º):</label><input type="number" id="slideDiameter" value="37.5"></div><div class="form-group"><label>–î–∏–∞–º–µ—Ç—Ä –ø–µ—á–∞—Ç–∏ (–º–º):</label><input type="number" id="printDiameter" value="32"></div><div class="form-group"><label>–ú–µ—Ç–∫–∞:</label><input type="text" id="alignMark" value="PLT"></div></div><div id="finalResult"><canvas id="result-canvas"></canvas></div><div style="text-align: right;"><button class="action-button" onclick="exportFinalGobo()">–°–∫–∞—á–∞—Ç—å .TIFF</button></div>`
};

// ===================================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ===================================================================
let state = {
    currentStep: 1,
    photoData: null,
    userImageSrc: null,
    assignedPoints: [],
    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, initialScale: 1 },
    deformationPoints: [],
    editorView: { zoom: 1, pan: { x: 0, y: 0 } }
};
let userImageElement = null; // HTML Image object
let activeControlPoint = null, isPanning = false, panStart = {x:0, y:0};

// ===================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ===================================================================
document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    buildInitialUI();
    loadState();
}

function buildInitialUI() {
    const stepsContainer = document.getElementById('steps-container');
    const progressBar = document.getElementById('progressBar');
    stepsContainer.innerHTML = '';
    progressBar.innerHTML = '';

    STEPS_CONFIG.forEach(step => {
        // –°–æ–∑–¥–∞–µ–º —à–∞–≥–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        const section = document.createElement('section');
        section.className = 'step-section is-locked';
        section.id = `step${step.id}`;
        section.innerHTML = STEPS_HTML[step.id];
        stepsContainer.appendChild(section);

        // –°–æ–∑–¥–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ —à–∞–ø–∫–µ
        const navLink = document.createElement('a');
        navLink.href = `#step${step.id}`;
        navLink.dataset.step = step.id;
        navLink.textContent = `–®–∞–≥ ${step.id}: ${step.title}`;
        progressBar.appendChild(navLink);
    });
}

// ===================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–ï–ú (localStorage)
// ===================================================================
function startNewProject() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.")) {
        localStorage.removeItem('goboProjectState');
        window.location.reload();
    }
}
function saveState() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
    const stateToSave = {
        currentStep: state.currentStep,
        photoData: state.photoData,
        userImageSrc: state.userImageSrc,
        assignedPoints: state.assignedPoints.map(p => ({ x: p.x, y: p.y })),
        deformationPoints: state.deformationPoints,
        transform: state.transform
    };
    localStorage.setItem('goboProjectState', JSON.stringify(stateToSave));
}

function loadState() {
    const saved = localStorage.getItem('goboProjectState');
    if (!saved) {
        renderUI();
        return;
    }
    const loadedState = JSON.parse(saved);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    state.currentStep = loadedState.currentStep || 1;
    state.photoData = loadedState.photoData;
    state.userImageSrc = loadedState.userImageSrc;
    state.assignedPoints = loadedState.assignedPoints || [];
    state.deformationPoints = loadedState.deformationPoints || [];
    state.transform = loadedState.transform || state.transform;

    // –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, —Ä–µ–Ω–¥–µ—Ä–∏–º –≤–µ—Å—å UI
    renderUI();
}

// ===================================================================
// –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
// ===================================================================
function renderUI() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —à–∞–≥–∏
    for (let i = 1; i <= state.currentStep; i++) {
        document.getElementById(`step${i}`).classList.remove('is-locked');
    }
    updateProgressUI(state.currentStep);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —à–∞–≥–∏
    if (state.photoData) {
        const photoUploadArea = document.getElementById('photoUploadArea');
        photoUploadArea.innerHTML = `<img src="${state.photoData}" style="max-width:100%; border-radius:10px;">`;
        const step2Photo = document.getElementById('step2-photo');
        step2Photo.src = state.photoData;
        step2Photo.onload = () => {
            if (state.assignedPoints.length > 0) {
                state.assignedPoints.forEach(p => createPointElement(p.x, p.y));
                document.getElementById('step2-next').disabled = false;
            }
            if (state.currentStep >= 4) {
                initEditor();
            }
        };
    }
    if (state.userImageSrc) {
        userImageElement = new Image();
        userImageElement.src = state.userImageSrc;
        userImageElement.onload = () => {
            document.getElementById('step3-image-preview').innerHTML = `<img src="${userImageElement.src}" style="max-width:100%; border-radius: 8px;">`;
            if (state.currentStep >= 4) {
                 initEditor();
            }
        };
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
}

function updateProgressUI(activeStep) {
    document.querySelectorAll('#progressBar a').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed', 'unlocked');
        if (stepNum <= activeStep) {
            el.classList.add('unlocked');
            if (stepNum < activeStep) el.classList.add('completed');
            else el.classList.add('active');
        }
    });
    document.querySelectorAll('.step-section').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed');
        if (stepNum < activeStep) el.classList.add('completed');
        else if (stepNum === activeStep) el.classList.add('active');
    });
}


// ===================================================================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô (–ü—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
// ===================================================================
function setupEventListeners() {
    // –®–∞–≥ 1
    document.getElementById('photoUploadArea').onclick = () => document.getElementById('photoInput').click();
    document.getElementById('photoInput').onchange = handlePhotoUpload;
    // –®–∞–≥ 2
    document.getElementById('step2-photo').onclick = handlePointAssignment;
    document.getElementById('step2-next').onclick = () => unlockStep(3);
    // –®–∞–≥ 3
    document.getElementById('step3-image-input').onchange = handleGoboImageUpload;
    // –®–∞–≥ 4
    document.getElementById('step4-next').onclick = () => {
        generateFinalResultPreview();
        unlockStep(5);
    };
}

function handlePhotoUpload(e) { /* ... */ } // –∏ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
// ... (–∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JS, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –æ—Ç–ª–∞–∂–µ–Ω)

</script>
</body>
</html>
