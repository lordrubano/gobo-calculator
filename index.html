<!DOCTYPE html>
<html lang="ru" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOBO Профессиональный калькулятор-редактор v2.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-to-tiff@1.1.1/dist/canvas-to-tiff.min.js"></script>
    
    <style>
        /* ОБЩИЕ СТИЛИ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; color: #333; }
        
        /* ШАПКА И НАВИГАЦИЯ */
        .header { background: white; padding: 15px 30px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header h1 { color: #4a4a4a; margin-bottom: 15px; font-size: 24px; }
        .progress-bar { display: flex; list-style: none; padding: 0; justify-content: space-between; max-width: 900px; margin: auto; }
        .progress-bar a { flex: 1; text-align: center; font-weight: bold; color: #718096; position: relative; text-decoration: none; cursor: not-allowed; opacity: 0.5; padding: 8px 0; }
        .progress-bar a.unlocked { cursor: pointer; opacity: 1; }
        .progress-bar a::before { content: attr(data-step); display: block; margin: 0 auto 5px; width: 30px; height: 30px; line-height: 30px; border: 2px solid #cbd5e0; border-radius: 50%; background: #fff; color: #cbd5e0; transition: all 0.3s ease; }
        .progress-bar a.active::before { border-color: #5a67d8; color: #5a67d8; font-weight: 700; transform: scale(1.1); }
        .progress-bar a.completed::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        .progress-bar a.completed + a.unlocked::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #5a67d8; z-index: -1; transition: background 0.3s ease; }
        .progress-bar a:not(:first-child)::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #cbd5e0; z-index: -1; }
        
        /* КОНТЕЙНЕР И СЕКЦИИ */
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .step-section { background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 8px 40px rgba(0,0,0,0.08); margin-bottom: 40px; border-left: 5px solid #e2e8f0; transition: all 0.5s ease-out; }
        .step-section.active { border-left-color: #5a67d8; }
        .step-section.completed { border-left-color: #48bb78; }
        .step-section.is-locked { opacity: 0; max-height: 0; padding: 0 40px; margin: 0; border-width: 0; overflow: hidden; }
        .step-section h2 { color: #5a67d8; margin-bottom: 10px; font-size: 28px; display: flex; align-items: center; }
        .step-section h2 .step-number { background: #5a67d8; color: white; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 15px; flex-shrink: 0; }
        .step-section > p { color: #666; margin-bottom: 25px; }
        
        /* ЭЛЕМЕНТЫ ФОРМ */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .photo-upload-area { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 40px; text-align: center; background: #f7fafc; transition: all 0.3s ease; cursor: pointer; }
        .photo-upload-area:hover { border-color: #5a67d8; background: #edf2f7; }
        #photo-container { position: relative; display: inline-block; margin-top: 20px; user-select: none; }
        #step2-photo { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block;}
        .assigned-point { position: absolute; width: 14px; height: 14px; background: rgba(229, 62, 62, 0.7); color: white; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); user-select: none; transform: translate(-50%, -50%); cursor: pointer; }
        #lines-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        /* РЕДАКТОР */
        .deformation-stage-wrapper { text-align: center; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 10px; }
        .deformation-stage { position: relative; width: 100%; height: 600px; /* Фиксированная высота для удобства */ background-color: #f0f2f5; cursor: grab; }
        .deformation-stage.is-panning { cursor: grabbing; }
        #deformation-canvas { position: absolute; top: 0; left: 0; }
        .control-point { position: absolute; width: 12px; height: 12px; background: rgba(255, 255, 255, 0.5); border: 2px solid #e53e3e; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; transform: translate(-50%, -50%); }
        .controls-panel, .zoom-controls { background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center; border: 1px solid #e2e8f0; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .pan-controls button { width: 40px; height: 40px; font-size: 20px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
        .zoom-controls { grid-template-columns: 1fr auto; }

        /* КНОПКИ */
        .action-button { display: inline-block; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; background: #5a67d8; color: white; margin-left: 10px; }
        .action-button:disabled { background: #cbd5e0; color: #a0aec0; cursor: not-allowed; }
        .clear-points-btn { background: #e53e3e; }
    </style>
</head>
<body>

    <header class="header">
        <h1>GOBO Калькулятор-редактор</h1>
        <nav class="progress-bar" id="progressBar">
            <a href="#step1" data-step="1" class="unlocked active">Шаг 1: Фото</a>
            <a href="#step2" data-step="2">Шаг 2: Точки</a>
            <a href="#step3" data-step="3">Шаг 3: Изображение</a>
            <a href="#step4" data-step="4">Шаг 4: Редактор</a>
            <a href="#step5" data-step="5">Шаг 5: Экспорт</a>
        </nav>
    </header>

    <div class="container">
        <section class="step-section active" id="step1">
             </section>
        <section class="step-section is-locked" id="step2">
             </section>
        <section class="step-section is-locked" id="step3">
             </section>
        
        <section class="step-section is-locked" id="step4">
            <h2><span class="step-number">4</span>Позиционирование и деформация</h2>
            <p><b>Колесо мыши</b> - зум. <b>Зажмите Пробел + мышь</b> - перемещение холста. Перетаскивайте красные точки для деформации.</p>
            <div class="deformation-stage-wrapper">
                <div class="deformation-stage" id="deformationStage">
                    <canvas id="deformation-canvas"></canvas>
                </div>
            </div>
            <div class="zoom-controls">
                 <div class="control-group">
                    <label>Масштаб редактора: <span id="zoomLevel">100</span>%</label>
                    <input type="range" id="zoomSlider" min="10" max="500" value="100">
                </div>
                <button class="action-button" onclick="resetEditorView()">Сбросить вид</button>
            </div>
            <div class="controls-panel">
                </div>
            <button class="action-button" id="step4-next">Далее: Экспорт</button>
        </section>
        
        <section class="step-section is-locked" id="step5">
            </section>
    </div>

<script>
    // ===================================================================
    // == ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==
    // ===================================================================
    // ... (все глобальные переменные остаются)
    // НОВЫЕ ПЕРЕМЕННЫЕ ДЛЯ ЗУМА/ПАНА РЕДАКТОРА
    let editorZoom = 1;
    let editorPan = { x: 0, y: 0 };
    let isPanning = false;
    let panStart = { x: 0, y: 0 };


    // ===================================================================
    // == ИНИЦИАЛИЗАЦИЯ ==
    // ===================================================================
    // ... (initCalculator, loadState, saveState, unlockStep, updateProgressUI, initUIFromState без изменений) ...


    // ===================================================================
    // == ОБРАБОТЧИКИ СОБЫТИЙ ==
    // ===================================================================
    function setupEventListeners() {
        // ... (все старые обработчики)

        // НОВЫЕ ОБРАБОТЧИКИ ДЛЯ РЕДАКТОРА
        const stage = document.getElementById('deformationStage');
        stage.addEventListener('wheel', handleWheelZoom, { passive: false });
        stage.addEventListener('mousedown', handlePanStart);
        stage.addEventListener('mousemove', handlePanMove);
        stage.addEventListener('mouseup', handlePanEnd);
        stage.addEventListener('mouseleave', handlePanEnd); // Заканчиваем пан, если мышь ушла
        
        document.getElementById('zoomSlider').addEventListener('input', handleSliderZoom);
    }
    
    // ... (старые обработчики handlePhotoUpload, handlePointAssignment и т.д. без изменений)


    // ===================================================================
    // == ЛОГИКА РЕДАКТОРА (ШАГ 4) - СИЛЬНО ОБНОВЛЕНА ==
    // ===================================================================
    function initEditor() {
        // ... (код инициализации остается)
        resetEditorView(); // Сбрасываем вид при каждой инициализации
    }

    // НОВАЯ ФУНКЦИЯ: Сброс вида редактора
    function resetEditorView() {
        const canvas = document.getElementById('deformation-canvas');
        const stage = document.getElementById('deformationStage');
        editorZoom = Math.min(stage.clientWidth / canvas.width, stage.clientHeight / canvas.height) * 0.9; // Вписать с 10% отступом
        editorPan = {
            x: (stage.clientWidth - canvas.width * editorZoom) / 2,
            y: (stage.clientHeight - canvas.height * editorZoom) / 2
        };
        document.getElementById('zoomSlider').value = editorZoom * 100;
        document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
        drawTransformedImage();
    }

    // НОВЫЕ ФУНКЦИИ: Управление видом редактора
    function handleWheelZoom(e) {
        e.preventDefault();
        const zoomIntensity = 0.1;
        const newZoom = editorZoom * (1 - Math.sign(e.deltaY) * zoomIntensity);
        editorZoom = Math.max(0.1, Math.min(newZoom, 5)); // Ограничение от 10% до 500%
        document.getElementById('zoomSlider').value = editorZoom * 100;
        document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
        drawTransformedImage();
    }
    
    function handleSliderZoom(e) {
        editorZoom = e.target.value / 100;
        document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
        drawTransformedImage();
    }

    function handlePanStart(e) {
        if (e.buttons === 1 && e.altKey) { // Панорамирование по Alt + левая кнопка мыши
            isPanning = true;
            panStart.x = e.clientX - editorPan.x;
            panStart.y = e.clientY - editorPan.y;
            e.target.classList.add('is-panning');
        }
    }

    function handlePanMove(e) {
        if (isPanning) {
            editorPan.x = e.clientX - panStart.x;
            editorPan.y = e.clientY - panStart.y;
            drawTransformedImage();
        }
    }

    function handlePanEnd(e) {
        isPanning = false;
        e.target.classList.remove('is-panning');
    }

    // ИЗМЕНЕННАЯ ФУНКЦИЯ: Конвертация координат экрана в координаты холста
    function screenToCanvasCoords(e, stage) {
        const rect = stage.getBoundingClientRect();
        const screenX = e.clientX - rect.left;
        const screenY = e.clientY - rect.top;
        return {
            x: (screenX - editorPan.x) / editorZoom,
            y: (screenY - editorPan.y) / editorZoom
        };
    }
    
    // ИЗМЕНЕННАЯ ФУНКЦИЯ: Перетаскивание маркера
    function handleDrag(e) {
        if (!activeControlPoint || isPanning) return; // Не двигаем маркеры во время панорамирования
        
        const coords = screenToCanvasCoords(e, document.getElementById('deformationStage'));
        
        activeControlPoint.element.style.left = `${e.clientX - e.target.parentElement.getBoundingClientRect().left}px`;
        activeControlPoint.element.style.top = `${e.clientY - e.target.parentElement.getBoundingClientRect().top}px`;
        
        deformationDestPoints[activeControlPoint.index] = { x: coords.x, y: coords.y };
        drawTransformedImage();
    }

    // ОБНОВЛЕННАЯ ГЛАВНАЯ ФУНКЦИЯ ОТРИСОВКИ
    function drawTransformedImage() {
        if (!userImageElement || !userImageElement.complete) return;
        const canvas = document.getElementById('deformation-canvas');
        const ctx = canvas.getContext('2d');
        
        // Масштабируем холст до реальных размеров фото для высокого качества
        const bgPhotoImg = document.getElementById('step2-photo');
        canvas.width = bgPhotoImg.naturalWidth;
        canvas.height = bgPhotoImg.naturalHeight;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. Применяем трансформации вида (зум и пан)
        ctx.save();
        ctx.translate(editorPan.x, editorPan.y);
        ctx.scale(editorZoom, editorZoom);

        // 2. Рисуем фон
        ctx.drawImage(bgPhotoImg, 0, 0);

        // 3. Рисуем деформированное изображение (логика остается прежней)
        ctx.save();
        ctx.globalAlpha = transformState.opacity;
        ctx.translate(transformState.x, transformState.y);
        ctx.rotate(transformState.rotation * Math.PI / 180);
        ctx.scale(transformState.scale, transformState.scale);
        // ... (вся остальная логика деформации с триангуляцией остается здесь)
        ctx.restore();
        
        // 4. Возвращаем трансформацию вида
        ctx.restore();
    }

    // ... (весь остальной JS код, включая экспорт, остается без изменений)

</script>
</body>
</html>
