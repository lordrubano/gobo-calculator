<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 2.0</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#5a67d8">
<style>
/* --- –°—Ç–∏–ª–∏: —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–µ, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã --- */
html,body{margin:0;padding:0;font-family:sans-serif;background:#f0f2f6}
h1{text-align:center;margin:10px 0;color:#2d3748}
#app{max-width:960px;margin:auto;padding:16px}
.step{display:none;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.step.active{display:block}
.progress{display:flex;justify-content:space-between;margin:16px 0}
.progress div{flex:1;text-align:center;font-weight:700;color:#a0aec0;position:relative}
.progress.active{color:#5a67d8}
.progress div::before{content:attr(data-n);display:block;width:32px;height:32px;margin:0 auto 4px;border-radius:50%;line-height:32px;border:2px solid currentColor}
.progress.done::before{background:#5a67d8;color:#fff}
#photoZone{border:3px dashed #cbd5e0;padding:40px;text-align:center;border-radius:10px;cursor:pointer}
#photoZone.dragover{background:#edf2f7;border-color:#5a67d8}
canvas{max-width:100%; display: block;} /* –î–æ–±–∞–≤–ª–µ–Ω–æ display: block –¥–ª—è canvas */
.point{position:absolute;width:14px;height:14px;background:#e53e3e;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);font-size:9px;line-height:10px;color:#fff;font-weight:700;user-select:none;cursor:pointer; z-index: 10;} /* –î–æ–±–∞–≤–ª–µ–Ω z-index –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ */
.layer{position:relative;display:inline-block;border:1px solid #e2e8f0;border-radius:10px; line-height: 0;} /* –î–æ–±–∞–≤–ª–µ–Ω–æ line-height: 0 –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è img –∏ canvas/svg */
#bgImg, #bgImg2 {max-width:100%;display:block;border-radius:10px}
#cv {position:absolute; top:0; left:0; max-width:100%;} /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ canvas –Ω–∞–¥ bgImg2 */
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.controls label{font-size:12px}
button{cursor:pointer; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: #f0f0f0;}
button:disabled {cursor: not-allowed; background-color: #e0e0e0;}
.hidden{display:none}
</style>
</head>
<body>
<div id="app">
  <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 2.0</h1>
  <div class="progress">
    <div id="p1" data-n="1" class="active">–§–æ—Ç–æ</div>
    <div id="p2" data-n="2">–ö–æ–Ω—Ç—É—Ä</div>
    <div id="p3" data-n="3">–ì–æ–±–æ</div>
    <div id="p4" data-n="4">–î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
    <div id="p5" data-n="5">–≠–∫—Å–ø–æ—Ä—Ç</div>
  </div>
  <section id="s1" class="step active">
    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ c ¬´–£–º–Ω–æ–π –ù–∞—Å–∞–¥–∫–∏¬ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞:</p>
    <div id="photoZone"> üì∑  –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</div>
    <input id="photoInput" type="file" accept="image/*" class="hidden">
  </section>
  <section id="s2" class="step">
    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞ (–¥–æ 12 —Ç–æ—á–µ–∫):</p>
    <div id="contourLayer" class="layer"> <img id="bgImg">
      <svg id="svg" style="position:absolute;inset:0;width:100%;height:100%;"></svg> </div>
    <div class="controls">
      <span>–¢–æ—á–µ–∫: <b id="ptCount">0</b>/12</span>
      <button id="undoBtn"> ‚ü≤  Undo</button>
      <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      <button id="toStep3" disabled>–î–∞–ª–µ–µ ‚Üí</button>
    </div>
  </section>
  <section id="s3" class="step">
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏:</p>
    <input id="goboInput" type="file" accept="image/*">
    <div id="goboPreviewContainer" style="height:200px;border:2px dashed #cbd5e0;margin:12px 0;display:flex;align-items:center;justify-content:center;border-radius:10px">
      <img id="goboPreviewImg" style="max-height:100%; max-width:100%; display:none;">
      <span id="goboPreviewPlaceholder">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ :)</span>
    </div>
    <button id="toStep4" disabled>–î–∞–ª–µ–µ ‚Üí</button>
  </section>
  <section id="s4" class="step">
    <div class="layer" id="editLayer">
      <img id="bgImg2">
      <canvas id="cv"></canvas>
    </div>
    <div class="controls">
      <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å <input type="range" id="opa" min="0" max="100" value="100"></label>
      <label>–ú–∞—Å—à—Ç–∞–± <input type="range" id="scl" min="50" max="200" value="100"></label> <label>–ü–æ–≤–æ—Ä–æ—Ç <input type="range" id="rot" min="-180" max="180" value="0"></label>
      <button id="toggleVis"> üëÅ  –°–∫—Ä—ã—Ç—å</button>
      <button id="saveBtn"> üíæ  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="loadBtn"> üìÇ  –û—Ç–∫—Ä—ã—Ç—å</button>
      <button id="helpBtn"> ‚ùî  –ü–æ–º–æ—â—å </button>
      <button id="toStep5">–î–∞–ª–µ–µ ‚Üí</button>
    </div>
  </section>
  <section id="s5" class="step">
    <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏</h3>
    <label>–ü—Ä–µ—Å–µ—Ç:
      <select id="preset">
        <option value="32,2700">32 –º–º / 2700 dpi (—Å—Ç–µ–∫–ª–æ, 3401x3401px)</option>
        <option value="37.5,600">37.5 –º–º / 600 dpi (—Å—Ç–∞–Ω–¥–∞—Ä—Ç, ~885x885px)</option>
        <option value="37.5,1200">37.5 –º–º / 1200 dpi (—Å—Ç–∞–Ω–¥–∞—Ä—Ç HQ, ~1770x1770px)</option>
        <option value="50,600">50 –º–º / 600 dpi (~1181x1181px)</option>
      </select>
    </label>
    <button id="exportPng"> üì§  PNG (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</button>
    <button id="exportTif"> üì§  TIFF (RGBA)</button>
    <p style="margin-top:10px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞ (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è):</p>
    <canvas id="prev" style="margin-top:12px;border:1px solid #e2e8f0; max-width: 300px; max-height: 300px;"></canvas>
  </section>
</div>

<script>
/* –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è tour, —É–±—Ä–∞–ª —Ä–∞–¥–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –≤ [1], –∑–¥–µ—Å—å –ø–æ–ª–Ω–∞—è */
function startTour(){
  const steps=;
  let i=0;
  const tourOverlay = document.createElement('div');
  tourOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
  
  const tourBox = document.createElement('div');
  tourBox.style.cssText = 'background:white;padding:20px;border-radius:8px;max-width:400px;text-align:center;position:relative;z-index:9999;color:black;';
  
  const tourMsg = document.createElement('p');
  const tourBtn = document.createElement('button');
  tourBtn.textContent = '–î–∞–ª—å—à–µ';
  tourBtn.style.marginTop = '10px';

  let highlightElement = null;

  function showStep() {
    if (i >= steps.length) {
      if (highlightElement) highlightElement.style.outline = 'none';
      tourOverlay.remove();
      return;
    }

    if (highlightElement) highlightElement.style.outline = 'none'; // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
    
    const currentStep = steps[i];
    const targetElement = document.querySelector(currentStep.el);
    
    if (targetElement) {
      targetElement.style.outline = '3px solid #007bff';
      targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      highlightElement = targetElement;
    }
    
    tourMsg.textContent = currentStep.msg;
    tourBtn.onclick = () => {
      i++;
      showStep();
    };
  }
  
  tourBox.appendChild(tourMsg);
  tourBox.appendChild(tourBtn);
  tourOverlay.appendChild(tourBox);
  document.body.appendChild(tourOverlay);
  showStep();
}
</script>

<script>
/* ========== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ========== */
const $ = q => document.querySelector(q);
let currentStep = 1; // –ò–∑–º–µ–Ω–µ–Ω–æ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
let points =;
let goboImg = null;
let photoData = null; // Base64 —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–≥–æ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
let originalPhotoForExport = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç —Ñ–æ–Ω–∞
let lastState = null;
let cv = $('#cv'), ctx = cv.getContext('2d');
let showOverlay = true;
let tf = { x: 0, y: 0, s: 1, r: 0, o: 1, baseS: 1 }; // transform state

/* --- –£—Ç–∏–ª–∏—Ç—ã --- */
// –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ Delaunator –∏ TIFF/UTIF
// –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ Delaunator –∏ TiffWriter (–∏–ª–∏ UTIF) –±—É–¥—É—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
// –ü—Ä–∏–º–µ—Ä: <script src="delaunator.min.js"></script> <script src="tiff.min.js"></script>
// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ UTIF.js: <script src="UTIF.js"></script>

/* --- –ü—Ä–æ–≥—Ä–µ—Å—Å --- */
function goToStep(n) {
  $('#s' + currentStep).classList.remove('active');
  $('#p' + currentStep).classList.remove('active');
  if (n > currentStep) $('#p' + currentStep).classList.add('done');
  currentStep = n;
  $('#s' + currentStep).classList.add('active');
  $('#p' + currentStep).classList.add('active');
}

/* --- –®–∞–≥ 1: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ --- */
const photoZoneEl = $('#photoZone'), photoInputEl = $('#photoInput');
photoZoneEl.onclick = () => photoInputEl.click();

['dragover', 'dragleave', 'drop'].forEach(e_type => {
  photoZoneEl.addEventListener(e_type, ev => {
    ev.preventDefault();
    if (e_type === 'dragover') photoZoneEl.classList.add('dragover');
    if (e_type === 'dragleave' |
| e_type === 'drop') photoZoneEl.classList.remove('dragover');
    if (e_type === 'drop') loadPhoto(ev.dataTransfer.files);
  });
});
photoInputEl.onchange = e => loadPhoto(photoInputEl.files);

function loadPhoto(file) {
  if (!file ||!file.type.startsWith('image/')) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ñ–æ–Ω–∞
      // originalPhotoForExport = img; // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

      const max_dim = 2000;
      let scaleFactor = 1;
      let newWidth = img.width;
      let newHeight = img.height;

      if (img.width > max_dim |
| img.height > max_dim) {
        if (img.width > img.height) {
          scaleFactor = max_dim / img.width;
          newWidth = max_dim;
          newHeight = img.height * scaleFactor;
        } else {
          scaleFactor = max_dim / img.height;
          newHeight = max_dim;
          newWidth = img.width * scaleFactor;
        }
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = newWidth;
        tempCanvas.height = newHeight;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(img, 0, 0, newWidth, newHeight);
        photoData = tempCanvas.toDataURL('image/jpeg', 0.9);
        alert('–§–æ—Ç–æ –±—ã–ª–æ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ ' + Math.round(newWidth) + '√ó' + Math.round(newHeight) + ' px –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã. ' +
              '–≠—Ç–æ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ì–û–ë–û, —Ç.–∫. –æ–Ω–æ –±—É–¥–µ—Ç –Ω–∞–ª–æ–∂–µ–Ω–æ –Ω–∞ —Ö–æ–ª—Å—Ç –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ.');
      } else {
        photoData = e.target.result; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –µ—Å–ª–∏ –æ–Ω –º–µ–Ω—å—à–µ max_dim
      }
      
      $('#bgImg').src = photoData;
      $('#bgImg2').src = photoData; // –î–ª—è —à–∞–≥–∞ 4
      
      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
      points =;
      $('#ptCount').textContent = '0';
      $('#svg').innerHTML = '';
      $('#toStep3').disabled = true;
      if (goboImg) { // –ï—Å–ª–∏ –≥–æ–±–æ —É–∂–µ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Å–±—Ä–æ—Å–∏—Ç—å –µ–≥–æ
        goboImg = null;
        $('#goboPreviewImg').style.display = 'none';
        $('#goboPreviewPlaceholder').style.display = 'inline';
        $('#toStep4').disabled = true;
      }

      goToStep(2);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/* --- –®–∞–≥ 2: –∫–æ–Ω—Ç—É—Ä --- */
const contourLayerEl = $('#contourLayer'), svgEl = $('#svg');
const bgImgEl = $('#bgImg');

contourLayerEl.addEventListener('click', e => {
  if (points.length >= 12) {
    alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (12).');
    return;
  }
  const rect = bgImgEl.getBoundingClientRect(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º bgImg –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è bgImg
  const x = (e.clientX - rect.left) * (bgImgEl.naturalWidth / rect.width);
  const y = (e.clientY - rect.top) * (bgImgEl.naturalHeight / rect.height);

  // –°–æ–∑–¥–∞–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–æ—á–∫–∏
  const pointEl = document.createElement('div');
  pointEl.className = 'point';
  pointEl.textContent = points.length + 1;
  // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç —Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ contourLayerEl, –Ω–æ —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ bgImg
  pointEl.style.left = (x / bgImgEl.naturalWidth * 100) + '%';
  pointEl.style.top = (y / bgImgEl.naturalHeight * 100) + '%';
  contourLayerEl.appendChild(pointEl);
  
  points.push({ x, y, el: pointEl }); // –°–æ—Ö—Ä–∞–Ω—è–µ–º "–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏
  $('#ptCount').textContent = points.length;
  drawPoly();
  saveHistoryState();
  if (points.length >= 3) $('#toStep3').disabled = false;
});

function drawPoly() {
  svgEl.innerHTML = '';
  if (points.length < 2) return;

  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –¥–ª—è SVG, –µ—Å–ª–∏ bgImg –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–µ –≤ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—É—é –≤–µ–ª–∏—á–∏–Ω—É
  const svgPointsStr = points.map((p, i) => {
      const displayX = p.x * (bgImgEl.offsetWidth / bgImgEl.naturalWidth);
      const displayY = p.y * (bgImgEl.offsetHeight / bgImgEl.naturalHeight);
      return `${i? 'L' : 'M'}${displayX} ${displayY}`;
  }).join(' ');
  
  const pathData = svgPointsStr + (points.length > 2? ' Z' : '');
  svgEl.innerHTML = `<path d="${pathData}" stroke="#ff69b4" stroke-width="2" fill="rgba(255,105,180,.25)" style="pointer-events:none;" />`;
}


$('#clearBtn').onclick = () => {
  points.forEach(p => p.el.remove());
  points =;
  drawPoly();
  $('#ptCount').textContent = '0';
  $('#toStep3').disabled = true;
  saveHistoryState();
};

$('#undoBtn').onclick = undoLastAction;
$('#toStep3').onclick = () => goToStep(3);

/* --- –®–∞–≥ 3: –∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–±–æ --- */
$('#goboInput').onchange = e => {
  const file = e.target.files;
  if (!file ||!file.type.startsWith('image/')) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ì–û–ë–û.');
  const reader = new FileReader();
  reader.onload = ev => {
    goboImg = new Image();
    goboImg.onload = () => {
      $('#goboPreviewImg').src = ev.target.result;
      $('#goboPreviewImg').style.display = 'block';
      $('#goboPreviewPlaceholder').style.display = 'none';
      $('#toStep4').disabled = false;
    };
    goboImg.onerror = () => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ì–û–ë–û.');
        $('#toStep4').disabled = true;
    }
    goboImg.src = ev.target.result;
  };
  reader.readAsDataURL(file);
};

$('#toStep4').onclick = () => {
  if (!goboImg) {
    alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ì–û–ë–û.");
    return;
  }
  initialiseCanvasAndMarkers();
  goToStep(4);
};

/* --- –®–∞–≥ 4: –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è --- */
const editLayerEl = $('#editLayer');
const bgImg2El = $('#bgImg2'); // –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —à–∞–≥–µ 4

function initialiseCanvasAndMarkers() {
  if (!photoData ||!goboImg) return;

  const imgForSizing = new Image();
  imgForSizing.onload = () => {
    cv.width = imgForSizing.naturalWidth;
    cv.height = imgForSizing.naturalHeight;

    const bbox = getContourBoundingBox(); // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 'points' –≤ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
    
    // –¶–µ–Ω—Ç—Ä –ì–û–ë–û —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä bbox –∫–æ–Ω—Ç—É—Ä–∞
    tf.x = bbox.cx; 
    tf.y = bbox.cy;
    
    // –ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± –ì–û–ë–û: —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã—Ç—å bbox –∫–æ–Ω—Ç—É—Ä–∞ + 20%
    const goboAspectRatio = goboImg.width / goboImg.height;
    const bboxAspectRatio = bbox.w / bbox.h;
    let scaleToFit;
    if (goboAspectRatio > bboxAspectRatio) { // –ì–û–ë–û —à–∏—Ä–µ, —á–µ–º bbox
        scaleToFit = bbox.w / goboImg.width;
    } else { // –ì–û–ë–û –≤—ã—à–µ, —á–µ–º bbox
        scaleToFit = bbox.h / goboImg.height;
    }
    tf.baseS = scaleToFit * 1.2; // 1.2 –¥–ª—è 20% –∑–∞–ø–∞—Å–∞
    tf.s = tf.baseS;
    tf.r = 0;
    tf.o = 1;

    $('#opa').value = tf.o * 100;
    $('#scl').value = 100; // 100% –æ—Ç baseS
    $('#rot').value = tf.r;
    
    drawGoboOnCanvas();
    redrawDraggableMarkers();
    saveHistoryState();
  }
  imgForSizing.src = photoData; // –ò—Å–ø–æ–ª—å–∑—É–µ–º photoData –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ —Ö–æ–ª—Å—Ç–∞
}

function getContourBoundingBox() {
  if (points.length === 0) return { cx: 0, cy: 0, w: 0, h: 0 };
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  points.forEach(p => {
    minX = Math.min(minX, p.x);
    minY = Math.min(minY, p.y);
    maxX = Math.max(maxX, p.x);
    maxY = Math.max(maxY, p.y);
  });
  return { cx: (minX + maxX) / 2, cy: (minY + maxY) / 2, w: maxX - minX, h: maxY - minY };
}

function redrawDraggableMarkers() {
  // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å editLayerEl
 .forEach(m => m.remove());

  const bgRect = bgImg2El.getBoundingClientRect(); // –î–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤ %

  points.forEach((p, i) => {
    const marker = document.createElement('div');
    marker.className = 'point';
    marker.textContent = i + 1;
    marker.dataset.index = i;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤ % –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ bgImg2El
    marker.style.left = (p.x / bgImg2El.naturalWidth * 100) + '%';
    marker.style.top = (p.y / bgImg2El.naturalHeight * 100) + '%';
    
    editLayerEl.appendChild(marker);

    let activeDrag = false;
    marker.onpointerdown = ev => {
      activeDrag = true;
      marker.setPointerCapture(ev.pointerId);
      ev.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è
      saveHistoryState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    };
    marker.onpointermove = ev => {
      if (!activeDrag) return;
      const rect = bgImg2El.getBoundingClientRect();
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –≤ "–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const newX = (ev.clientX - rect.left) * (bgImg2El.naturalWidth / rect.width);
      const newY = (ev.clientY - rect.top) * (bgImg2El.naturalHeight / rect.height);
      
      marker.style.left = (newX / bgImg2El.naturalWidth * 100) + '%';
      marker.style.top = (newY / bgImg2El.naturalHeight * 100) + '%';
      
      points[i].x = newX;
      points[i].y = newY;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º SVG –ø–æ–ª–∏–≥–æ–Ω –Ω–∞ –®–∞–≥–µ 2 (–µ—Å–ª–∏ –æ–Ω –≤–∏–¥–µ–Ω) –∏ —Ö–æ–ª—Å—Ç –Ω–∞ –®–∞–≥–µ 4
      drawPoly(); // –û–±–Ω–æ–≤–ª—è–µ—Ç SVG –Ω–∞ –®–∞–≥–µ 2
      drawGoboOnCanvas(); // –û–±–Ω–æ–≤–ª—è–µ—Ç —Ö–æ–ª—Å—Ç –Ω–∞ –®–∞–≥–µ 4
    };
    marker.onpointerup = ev => {
      if (!activeDrag) return;
      activeDrag = false;
      marker.releasePointerCapture(ev.pointerId);
      // saveHistoryState(); // –°–æ—Å—Ç–æ—è–Ω–∏–µ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ onpointerdown
    };
  });
}


$('#opa').oninput = e => { tf.o = e.target.value / 100; drawGoboOnCanvas(); saveHistoryState(); };
$('#scl').oninput = e => { tf.s = tf.baseS * (e.target.value / 100); drawGoboOnCanvas(); saveHistoryState(); };
$('#rot').oninput = e => { tf.r = +e.target.value; drawGoboOnCanvas(); saveHistoryState(); };

$('#toggleVis').onclick = () => {
  showOverlay =!showOverlay;
  cv.style.visibility = showOverlay? 'visible' : 'hidden';
  $('#toggleVis').textContent = showOverlay? ' üëÅ  –°–∫—Ä—ã—Ç—å' : ' üëÅ  –ü–æ–∫–∞–∑–∞—Ç—å';
};

$('#toStep5').onclick = () => { generateExportPreview(); goToStep(5); };
$('#saveBtn').onclick = saveProjectState;
$('#loadBtn').onclick = loadProjectState;
$('#helpBtn').onclick = startTour;

/* --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥–æ–±–æ –Ω–∞ Canvas --- */
function drawGoboOnCanvas() {
  if (!goboImg) return;
  ctx.clearRect(0, 0, cv.width, cv.height);
  if (!showOverlay) return;

  ctx.save();
  ctx.globalAlpha = tf.o;
  
  // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –ì–û–ë–û
  ctx.translate(tf.x, tf.y); // 1. –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–∞—á–∞–ª–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ü–µ–Ω—Ç—Ä bbox –∫–æ–Ω—Ç—É—Ä–∞ (–∫—É–¥–∞ –¥–æ–ª–∂–Ω–æ –ª–µ—á—å –ì–û–ë–û)
  ctx.rotate(tf.r * Math.PI / 180); // 2. –í—Ä–∞—â–∞–µ–º
  ctx.scale(tf.s, tf.s); // 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
  
  // –†–∏—Å—É–µ–º –ì–û–ë–û —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ —Ü–µ–Ω—Ç—Ä —Å–æ–≤–ø–∞–ª —Å –Ω–æ–≤—ã–º –Ω–∞—á–∞–ª–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  ctx.drawImage(goboImg, -goboImg.width / 2, -goboImg.height / 2);
  
  ctx.restore();
  // redrawDraggableMarkers(); // –ú–∞—Ä–∫–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —Ä–∏—Å—É—é—Ç—Å—è –∫–∞–∫ DOM —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
}

/* --- Undo / Redo (–æ–¥–∏–Ω —à–∞–≥) --- */
function saveHistoryState() {
  lastState = JSON.stringify({
    pts: points.map(p => ({ x: p.x, y: p.y })), // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –±–µ–∑ el
    transformState: {...tf }
  });
}

function undoLastAction() {
  if (!lastState) {
    // –ï—Å–ª–∏ —ç—Ç–æ –®–∞–≥ 2 –∏ –µ—Å—Ç—å —Ç–æ—á–∫–∏, —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
    if (currentStep === 2 && points.length > 0) {
        const lastPoint = points.pop();
        if (lastPoint.el) lastPoint.el.remove();
        $('#ptCount').textContent = points.length;
        drawPoly();
        if (points.length < 3) $('#toStep3').disabled = true;
        // –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏, lastState –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º *–¥–æ* –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
        // –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏.
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã MVP, —ç—Ç–∞ –∫–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –Ω–∞ —à–∞–≥–µ 4.
        // –ò–ª–∏, –µ—Å–ª–∏ –º—ã –Ω–∞ —à–∞–≥–µ 2, —Ç–æ lastState –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞.
        // –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è saveHistoryState() –Ω–∞ —à–∞–≥–µ 2 —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ *–ø–æ—Å–ª–µ* –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏.
        // –ü–æ—ç—Ç–æ–º—É –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏, –Ω—É–∂–Ω–æ –ª–∏–±–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å points –∏ –≤—ã–∑—ã–≤–∞—Ç—å saveHistoryState() –∑–∞–Ω–æ–≤–æ,
        // –ª–∏–±–æ –∏–º–µ—Ç—å —Å—Ç–µ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π.
        // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫: undo –Ω–∞ —à–∞–≥–µ 2 —É–¥–∞–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI.
        // –ù–∞ —à–∞–≥–µ 4 –æ–Ω –æ—Ç–∫–∞—Ç–∏—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é.
        return;
    }
    alert('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã.');
    return;
  }

  const stateToRestore = JSON.parse(lastState);
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏)
  if (stateToRestore.pts) {
    points.forEach(p => p.el.remove()); // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ—á–µ–∫
    points =;
    stateToRestore.pts.forEach((p_data, i) => {
      const pointEl = document.createElement('div');
      pointEl.className = 'point';
      pointEl.textContent = i + 1;
      
      const layerForPoints = currentStep === 2? contourLayerEl : editLayerEl;
      const bgForPoints = currentStep === 2? bgImgEl : bgImg2El;

      pointEl.style.left = (p_data.x / bgForPoints.naturalWidth * 100) + '%';
      pointEl.style.top = (p_data.y / bgForPoints.naturalHeight * 100) + '%';
      layerForPoints.appendChild(pointEl);
      points.push({ x: p_data.x, y: p_data.y, el: pointEl });
    });
    $('#ptCount').textContent = points.length;
    drawPoly(); // –û–±–Ω–æ–≤–∏—Ç—å SVG –Ω–∞ —à–∞–≥–µ 2
    if (currentStep === 4) redrawDraggableMarkers(); // –û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ —à–∞–≥–µ 4
  }

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
  if (stateToRestore.transformState) {
    Object.assign(tf, stateToRestore.transformState);
    $('#opa').value = tf.o * 100;
    $('#scl').value = (tf.s / tf.baseS) * 100; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ baseS
    $('#rot').value = tf.r;
    if (currentStep === 4) drawGoboOnCanvas();
  }
  lastState = null; // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –æ—Ç–º–µ–Ω–∏—Ç—å –¥–≤–∞–∂–¥—ã –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ
}


/* --- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å / –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç --- */
function saveProjectState() {
  if (!photoData ||!goboImg) {
    alert("–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ª–æ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ì–û–ë–û.");
    return;
  }
  const projectData = {
    photoBase64: photoData,
    goboBase64: goboImg.src, // goboImg.src —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å base64
    contourPoints: points.map(p => ({ x: p.x, y: p.y })), // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    transformState: tf
  };
  const blob = new Blob(, { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'gobo-project-' + Date.now() + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
  alert('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
}

function loadProjectState() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json';
  fileInput.onchange = e => {
    const file = e.target.files;
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.photoBase64 ||!data.goboBase64 ||!data.contourPoints ||!data.transformState) {
          throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞.");
        }

        photoData = data.photoBase64;
        $('#bgImg').src = photoData;
        $('#bgImg2').src = photoData;

        goboImg = new Image();
        goboImg.onload = () => {
          $('#goboPreviewImg').src = goboImg.src;
          $('#goboPreviewImg').style.display = 'block';
          $('#goboPreviewPlaceholder').style.display = 'none';
          $('#toStep4').disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –ì–û–ë–û —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ

          points.forEach(p => p.el.remove()); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ—á–µ–∫
          points =;
          data.contourPoints.forEach((p_data, i) => {
            // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ—á–µ–∫ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —à–∞–≥ 2 –∏–ª–∏ 4
            points.push({ x: p_data.x, y: p_data.y, el: null }); // el –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–∑–∂–µ
          });
          $('#ptCount').textContent = points.length;
          
          Object.assign(tf, data.transformState);

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞ –∫–∞–∫–æ–π —à–∞–≥ –ø–µ—Ä–µ–π—Ç–∏
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—á–∫–∏, –Ω–æ –Ω–µ—Ç –ì–û–ë–û (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏), –∏–¥–µ–º –Ω–∞ —à–∞–≥ 2
          // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Å–µ, –∏–¥–µ–º –Ω–∞ —à–∞–≥ 4
          goToStep(4); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å –ì–û–ë–û
          
          // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω—É–∂–Ω—ã–π —à–∞–≥
          if (currentStep === 2) {
             drawPoly(); // –û–±–Ω–æ–≤–∏—Ç—å SVG
             points.forEach((p, i) => { // –°–æ–∑–¥–∞—Ç—å DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ—á–µ–∫
                const pointEl = document.createElement('div');
                pointEl.className = 'point';
                pointEl.textContent = i + 1;
                pointEl.style.left = (p.x / bgImgEl.naturalWidth * 100) + '%';
                pointEl.style.top = (p.y / bgImgEl.naturalHeight * 100) + '%';
                contourLayerEl.appendChild(pointEl);
                p.el = pointEl;
             });
             if (points.length >= 3) $('#toStep3').disabled = false;
          } else if (currentStep === 4) {
             initialiseCanvasAndMarkers(); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç drawGoboOnCanvas –∏ redrawDraggableMarkers
          }
          alert('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.');
        };
        goboImg.onerror = () => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ì–û–ë–û –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞.');
        }
        goboImg.src = data.goboBase64;

      } catch (error) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç: ' + error.message);
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:", error);
      }
    };
    reader.readAsText(file);
  };
  fileInput.click();
}


/* --- –ü—Ä–µ—Å–µ—Ç—ã –ø–µ—á–∞—Ç–∏ / –ø—Ä–µ–≤—å—é --- */
$('#preset').onchange = generateExportPreview;

function generateExportPreview() {
  if (!cv |
| cv.width === 0 |
| cv.height === 0) {
      // console.warn("–•–æ–ª—Å—Ç –¥–ª—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é.");
      return;
  }
  const = $('#preset').value.split(',');
  const d_mm = parseFloat(dmmStr);
  const dpi = parseInt(dpiStr, 10);
  
  const targetPxWidth = Math.round(d_mm / 25.4 * dpi);
  const targetPxHeight = targetPxWidth; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –ì–û–ë–û

  const previewCanvas = $('#prev');
  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
  const displaySize = Math.min(300, targetPxWidth); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—å—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  previewCanvas.width = displaySize;
  previewCanvas.height = displaySize * (targetPxHeight / targetPxWidth);


  const pctx = previewCanvas.getContext('2d');
  pctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
  
  // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É –∫—Ä—É–≥–∞ (–µ—Å–ª–∏ –ì–û–ë–û –∫—Ä—É–≥–ª–æ–µ)
  pctx.beginPath();
  pctx.arc(previewCanvas.width / 2, previewCanvas.height / 2, previewCanvas.width / 2 -1, 0, 2 * Math.PI);
  pctx.strokeStyle = '#888';
  pctx.lineWidth = 1;
  pctx.stroke();
  
  // –†–∏—Å—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ö–æ–ª—Å—Ç–∞ cv, –º–∞—Å—à—Ç–∞–±–∏—Ä—É—è –µ–≥–æ –Ω–∞ –ø—Ä–µ–≤—å—é
  // –í–∞–∂–Ω–æ: –∑–¥–µ—Å—å –º—ã —Ä–∏—Å—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ cv, –∫–æ—Ç–æ—Ä–æ–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ì–û–ë–û
  pctx.drawImage(cv, 0, 0, previewCanvas.width, previewCanvas.height);
}


/* --- –≠–∫—Å–ø–æ—Ä—Ç --- */
$('#exportPng').onclick = () => downloadExport('png');
$('#exportTif').onclick = () => downloadExport('tiff');

function downloadExport(type) {
  if (!cv |
| cv.width === 0 |
| cv.height === 0) {
      alert("–•–æ–ª—Å—Ç –¥–ª—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏.");
      return;
  }
  const = $('#preset').value.split(',');
  const d_mm = parseFloat(dmmStr);
  const dpi = parseInt(dpiStr, 10);

  const finalPx = Math.round(d_mm / 25.4 * dpi);

  const outputCanvas = document.createElement('canvas');
  outputCanvas.width = finalPx;
  outputCanvas.height = finalPx; // –ì–û–ë–û –æ–±—ã—á–Ω–æ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –∏–ª–∏ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∫—Ä—É–≥
  const octx = outputCanvas.getContext('2d');
  octx.clearRect(0, 0, finalPx, finalPx);

  // --- –ù–∞—á–∞–ª–æ: –õ–æ–≥–∏–∫–∞ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ---
  // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±–µ—Ä–µ—Ç –ò–°–•–û–î–ù–û–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ì–û–ë–û (goboImg)
  // –∏ –ò–°–•–û–î–ù–´–ï —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞ (points), –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—é
  // –≤ –í–´–°–û–ö–û–ú —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ –Ω–∞ outputCanvas.
  // –í —Ç–µ–∫—É—â–µ–º MVP –∫–æ–¥–µ –∏–∑ [1], `drawGoboOnCanvas` —Ä–∏—Å—É–µ—Ç –Ω–∞ `cv` —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
  // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏, –Ω—É–∂–Ω–æ –ª–∏–±–æ:
  // 1. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å `cv` –Ω–∞ `outputCanvas` (–∫–∞–∫ —Å–µ–π—á–∞—Å). –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ—Ç–µ—Ä–µ –∫–∞—á–µ—Å—Ç–≤–∞, –µ—Å–ª–∏ `cv` –º–µ–Ω—å—à–µ `outputCanvas`.
  // 2. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –ì–û–ë–û —Å —Ç–µ–º–∏ –∂–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è–º–∏, –Ω–æ –Ω–∞ `outputCanvas` –±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∏—Å—Ö–æ–¥–Ω–æ–µ `goboImg`.
  // 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –ø–æ-—Ç—Ä–µ—É–≥–æ–ª—å–Ω—É—é –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—é (mesh warp) –Ω–∞ `outputCanvas`.

  // –í–∞—Ä–∏–∞–Ω—Ç 2 (–ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –Ω–∞ —Ö–æ–ª—Å—Ç–µ –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è):
  octx.save();
  octx.globalAlpha = tf.o; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å

  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞.
  // tf.x, tf.y - —ç—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –Ω–∞ —Ö–æ–ª—Å—Ç–µ cv. –ù—É–∂–Ω–æ –∏—Ö —Å–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å.
  const scaleToFinal = finalPx / cv.width; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç cv –∫ outputCanvas
  
  const finalTfX = tf.x * scaleToFinal;
  const finalTfY = tf.y * scaleToFinal;
  // tf.s - —ç—Ç–æ –º–∞—Å—à—Ç–∞–± –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ goboImg.width/height. –û–Ω –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ.
  // tf.baseS - —Ç–æ–∂–µ.
  // tf.r - —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞, –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ.

  octx.translate(finalTfX, finalTfY);
  octx.rotate(tf.r * Math.PI / 180);
  octx.scale(tf.s * scaleToFinal, tf.s * scaleToFinal); // –ú–∞—Å—à—Ç–∞–± –ì–û–ë–û —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω
                                                        // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω —Ä–∏—Å—É–µ—Ç—Å—è
                                                        // –Ω–∞ —Ö–æ–ª—Å—Ç–µ –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
                                                        // tf.s —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç tf.baseS, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª–µ–Ω –∫ —Ä–∞–∑–º–µ—Ä—É goboImg.
                                                        // –ï—Å–ª–∏ tf.s —ç—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –º–∞—Å—à—Ç–∞–± –¥–ª—è cv, —Ç–æ –¥–ª—è outputCanvas
                                                        // –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å tf.s * scaleToFinal.
                                                        // –û–¥–Ω–∞–∫–æ, tf.s —ç—Ç–æ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç tf.baseS, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Ä–∞—Å—Å—á–∏—Ç–∞–Ω
                                                        // –¥–ª—è cv.
                                                        // –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ –±—É–¥–µ—Ç —Ç–∞–∫:
                                                        // tf.baseS –±—ã–ª —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∫–∞–∫: Math.max(bbox.w,bbox.h)*1.2/Math.max(goboImg.width,goboImg.height);
                                                        // bbox.w –∏ bbox.h - —ç—Ç–æ —Ä–∞–∑–º–µ—Ä—ã –Ω–∞ cv.
                                                        // –î–ª—è outputCanvas, bbox.w –∏ bbox.h –±—É–¥—É—Ç –≤ scaleToFinal —Ä–∞–∑ –±–æ–ª—å—à–µ.
                                                        // –ó–Ω–∞—á–∏—Ç, tf.baseS_final = tf.baseS * scaleToFinal.
                                                        // –ê –∏—Ç–æ–≥–æ–≤—ã–π –º–∞—Å—à—Ç–∞–± tf.s_final = tf.baseS_final * ($('#scl').value / 100)
                                                        // –¢–æ –µ—Å—Ç—å, –∏—Ç–æ–≥–æ–≤—ã–π –º–∞—Å—à—Ç–∞–± = tf.s * scaleToFinal
                                                        // –≠—Ç–æ —É–∂–µ —É—á—Ç–µ–Ω–æ –≤ octx.scale(tf.s * scaleToFinal,... )

  octx.drawImage(goboImg, -goboImg.width / 2, -goboImg.height / 2);
  octx.restore();
  
  // –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–∞—Å–∫–∞ –∫—Ä—É–≥–∞ (–¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫—Ä—É–≥–ª—ã—Ö –ì–û–ë–û)
  // octx.globalCompositeOperation = 'destination-in';
  // octx.beginPath();
  // octx.arc(finalPx / 2, finalPx / 2, finalPx / 2, 0, 2 * Math.PI);
  // octx.fill();
  // octx.globalCompositeOperation = 'source-over'; // –í–µ—Ä–Ω—É—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º

  // --- –ö–æ–Ω–µ—Ü: –õ–æ–≥–∏–∫–∞ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ---

  if (type === 'png') {
    outputCanvas.toBlob(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gobo_export_' + finalPx + 'px.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }, 'image/png');
  } else if (type === 'tiff') {
    if (typeof UTIF!== 'undefined') { // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ UTIF.js
        const ifd0 = {};
        ifd0["t256"] = [outputCanvas.width];  // ImageWidth
        ifd0["t257"] = [outputCanvas.height]; // ImageLength
        ifd0["t258"] = [8,8,8,8]; // BitsPerSample (R,G,B,A)
        ifd0["t259"] = [1];      // Compression (1 = uncompressed)
        ifd0["t262"] = [2];      // PhotometricInterpretation (2 = RGB)
        ifd0["t277"] = [3];      // SamplesPerPixel (R,G,B,A)
        ifd0["t282"] = [[dpi, 1]]; // XResolution (DPI as a rational: dpi/1)
        ifd0["t283"] = [[dpi, 1]]; // YResolution (DPI as a rational: dpi/1)
        ifd0["t284"] = [1];      // PlanarConfiguration (1 = chunky)
        ifd0["t296"] = [2];      // ResolutionUnit (2 = inch)
        ifd0["t338"] = [1];      // ExtraSamples (1 = associated alpha)

        const imgData = octx.getImageData(0, 0, outputCanvas.width, outputCanvas.height);
        const arrayBuffer = UTIF.encodeImage(imgData.data.buffer, outputCanvas.width, outputCanvas.height, [ifd0]);
        
        const blob = new Blob(, {type: "image/tiff"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'gobo_export_' + finalPx + 'px.tiff';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);

    } else if (typeof TiffWriter!== 'undefined') { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è tiff.min.js –∏–∑ [1]
        // –≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –¥–ª—è RGBA –∏ DPI
        // –ö–æ–¥ –∏–∑ [1]: const blob = TiffWriter.fromCanvas(outputCanvas, { dpi: dpi });
        // –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç RGBA
        // –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç DPI.
        try {
            const blob = TiffWriter.fromCanvas(outputCanvas, { dpi: dpi, rgba: true }); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –æ–ø—Ü–∏—é rgba
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'gobo_export_' + finalPx + 'px.tiff';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        } catch (tiffError) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ TIFF —Å TiffWriter:", tiffError);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ TIFF. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ tiff.min.js –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç RGBA/DPI.");
        }
    } else {
        alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ TIFF –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ UTIF.js –∏–ª–∏ tiff.min.js.");
    }
  }
}

/* --- Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    navigator.serviceWorker.register('./sw.js')
     .then(registration => {
        console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ, scope:', registration.scope);
      })
     .catch(error => {
        console.warn('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', error);
      });
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.onload = () => {
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–≤—å—é —ç–∫—Å–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ—Å–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if ($('#preset').value) {
        // generateExportPreview(); // –í—ã–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ cv —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫
    if (typeof Delaunator === 'undefined') {
        console.warn("Delaunator.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç –Ω–µ–≥–æ, –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.");
    }
    if (typeof TiffWriter === 'undefined' && typeof UTIF === 'undefined') {
        console.warn("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ TIFF (TiffWriter –∏–ª–∏ UTIF.js) –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
    }
};

// –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ SVG –ø–æ–ª–∏–≥–æ–Ω–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏)
window.addEventListener('resize', () => {
    if (currentStep === 2 && points.length > 0) {
        drawPoly();
    }
    if (currentStep === 4 && points.length > 0) {
        // –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ—Å—á–µ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –≤ %
        redrawDraggableMarkers();
        // –ò –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ö–æ–ª—Å—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ —Ä–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–∫–Ω–∞
        // initialiseCanvasAndMarkers(); // –û—Å—Ç–æ—Ä–æ–∂–Ω–æ, —ç—Ç–æ —Å–±—Ä–æ—Å–∏—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
    }
});

</script>
</body>
</html>
