<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GOBOÂ Calculatorâ€‘ProÂ (v0.9)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<style>
/* Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ CSS â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾Ğµ */
body{margin:0;font:15px/1.4 system-ui;background:#f6f7fa;color:#2d3748}
h1{text-align:center;margin:0;padding:12px 0;background:#4c51bf;color:#fff;font-size:20px}
#app{max-width:1024px;margin:0 auto;padding:16px}
.step{display:none}
.step.active{display:block}
#photoZone{border:3px dashed #a0aec0;padding:48px;text-align:center;border-radius:12px;cursor:pointer;transition:.2s}
#photoZone.drag{background:#edf2f7;border-color:#4c51bf}
.layer{position:relative;border:1px solid #e2e8f0;border-radius:8px;display:inline-block}
.point{position:absolute;width:14px;height:14px;transform:translate(-50%,-50%);background:#e53e3e;border:2px solid #fff;border-radius:50%;font:9px/12px monospace;color:#fff;text-align:center;cursor:grab;user-select:none}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
button,input[type=range],select{padding:6px 10px;font:inherit;border-radius:6px;border:1px solid #cbd5e0;background:#fff;cursor:pointer}
button:disabled{opacity:.45;cursor:not-allowed}
canvas{max-width:100%}
#cv{position:absolute;left:0;top:0}
</style>
</head>
<body>
<h1>GOBOÂ Calculatorâ€‘Pro</h1>
<div id="app">

<!-- â”€â”€ Ğ¨ĞĞ“â€¯1 â”€â”€ -->
<section id="s1" class="step active">
 <p>1.Â ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸ <strong>ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾</strong> Ğ¸Ğ»Ğ¸ ĞºĞ»Ğ¸ĞºĞ½Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ·Ğ¾Ğ½Ñ‹:</p>
 <div id="photoZone">ğŸ“·Â DropÂ /Â Click</div>
 <input id="photoInput" type="file" accept="image/*" hidden>
</section>

<!-- â”€â”€ Ğ¨ĞĞ“â€¯2 â”€â”€ -->
<section id="s2" class="step">
 <p>2.Â ĞšĞ»Ğ¸ĞºĞ½Ğ¸ Ğ¿Ğ¾ ÑƒĞ³Ğ»Ğ°Ğ¼ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ° (Ğ´Ğ¾Â 12â€¯Ñ‚Ğ¾Ñ‡ĞµĞº).</p>
 <div id="layer" class="layer">
   <img id="bgImg" alt="">
   <canvas id="cv"></canvas>
   <svg id="poly" style="position:absolute;inset:0"></svg>
 </div>
 <div class="controls">
   <span>Ğ¢Ğ¾Ñ‡ĞµĞº:Â <b id="pCount">0</b>/12</span>
   <button id="undoBtn" disabled>âŸ²Â Undo</button>
   <button id="next2" disabled>Ğ”Ğ°Ğ»ĞµĞµÂ â†’</button>
 </div>
</section>

<!-- â”€â”€ Ğ¨ĞĞ“â€¯3 â”€â”€ -->
<section id="s3" class="step">
 <p>3.Â Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸ <strong>ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒÂ Ğ³Ğ¾Ğ±Ğ¾</strong> (PNGÂ Ñ Ğ°Ğ»ÑŒÑ„Ğ¾Ğ¹ Ğ»ÑƒÑ‡ÑˆĞµ).</p>
 <input id="goboInput" type="file" accept="image/*">
 <div id="gPrev" style="height:200px;border:2px dashed #cbd5e0;border-radius:8px;display:flex;align-items:center;justify-content:center;margin:12px 0">â€”</div>
 <button id="next3" disabled>Ğ”Ğ°Ğ»ĞµĞµÂ â†’</button>
</section>

<!-- â”€â”€ Ğ¨ĞĞ“â€¯4 â”€â”€ -->
<section id="s4" class="step">
 <p>4.Â ĞŸĞ¾Ğ´Ğ³Ğ¾Ğ½Ğ¸, Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾Ğ´Ğ²Ğ¸Ğ³Ğ°Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸.</p>
 <div class="controls">
  <label>ĞŸÑ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½.
   <input type="range" id="opa" min="0" max="100" value="100">
  </label>
  <label>ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±
   <input type="range" id="scl" min="50" max="150" value="100">
  </label>
  <label>ĞŸĞ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚
   <input type="range" id="rot" min="-180" max="180" value="0">
  </label>
  <button id="eyeBtn">ğŸ‘Â Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
  <button id="help">â”Â ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ</button>
  <button id="next4">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Â â†’</button>
 </div>
</section>

<!-- â”€â”€ Ğ¨ĞĞ“â€¯5 â”€â”€ -->
<section id="s5" class="step">
 <p>5.Â Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 32â€¯Ğ¼Ğ¼Â @2700â€¯DPI â†’Â 3401â€¯px).</p>
 <div class="controls">
  <button id="savePNG">ğŸ“¤Â PNG</button>
  <button id="saveTIF">ğŸ“¤Â TIFFÂ RGBA</button>
  <button id="saveJSON">ğŸ’¾Â Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚</button>
  <button id="loadJSON">ğŸ“‚Â ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚</button>
 </div>
 <canvas id="prev" style="border:1px solid #cbd5e0;margin-top:12px"></canvas>
</section>

</div>

<!-- â”€â”€ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ â”€â”€ -->
<script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/utif@3.0.0/UTIF.min.js"></script> <!-- Ğ´Ğ»Ñ TIFF RGBA -->
<!-- Ğ¼Ğ¸Ğ½Ğ¸â€‘ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸Ğ½Ñ‚Ñ€Ğ¾ (3Â ĞºĞ‘) -->
<script>
function intro(){
 const steps=[
  ['#photoZone','Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°'],
  ['#layer','ĞšĞ»Ğ¸ĞºĞ°Ğ¹Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°ÑÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ 3â€‘12 Ñ‚Ğ¾Ñ‡ĞµĞº'],
  ['#goboInput','Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ / Ğ³Ğ¾Ğ±Ğ¾â€‘Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ'],
  ['#opa','ĞŸĞ¾Ğ»Ğ·ÑƒĞ½ĞºĞ¸: Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ / Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ± / Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚'],
  ['#eyeBtn','ğŸ‘Â ÑĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ/Ğ¿Ğ¾ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ'],
  ['#savePNG','Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ PNG Ğ¸Ğ»Ğ¸ TIFF']
 ];
 let i=0,ov=document.createElement('div');ov.style='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.6)';
 function show(){
  if(i===steps.length){ov.remove();return}
  const [sel,msg]=steps[i],r=document.querySelector(sel).getBoundingClientRect();
  ov.innerHTML=`<div style="position:absolute;left:${r.left}px;top:${r.top}px;width:${r.width}px;height:${r.height}px;border:2px solid #fff;border-radius:6px"></div>
  <div style="position:absolute;left:${r.left}px;top:${r.bottom+8}px;background:#fff;color:#2d3748;padding:8px 12px;border-radius:6px;max-width:240px">
   ${msg}<br><button style="margin-top:6px">Ğ”Ğ°Ğ»ÑŒÑˆĞµ</button>
  </div>`;
  ov.querySelector('button').onclick=()=>{i++;show()}
 }
 document.body.append(ov);show()
}
</script>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $=s=>document.querySelector(s);
let step=1;
let bgData='',bgImg=$('#bgImg');
let gobo=null;              /* Image() Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° Ğ³Ğ¾Ğ±Ğ¾ */
let points=[];              /* {x,y,elm} */
let lastState=null;
let cv=$('#cv'),ctx=cv.getContext('2d');
let tf={x:0,y:0,s:1,r:0,o:1,base:1}; /* transform state */
let mesh=[];                /* Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¾Ğ² Ğ¿Ğ¾ÑĞ»Ğµ Delaunator */
let showOverlay=true;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function go(n){
 $('.step.active').classList.remove('active');
 step=n; $('#s'+n).classList.add('active');
}
function saveHist(){ lastState=JSON.stringify({pts:points.map(p=>({x:p.x,y:p.y})),tf:Object.assign({},tf)}); $('#undoBtn').disabled=false }
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¨ĞĞ“Â 1 â€“ Ñ„Ğ¾Ñ‚Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const zone=$('#photoZone'),pin=$('#photoInput');
zone.onclick=_=>pin.click();
pin.onchange=e=>loadPhoto(e.target.files[0]);
['dragover','dragleave','drop'].forEach(ev=>{
 zone.addEventListener(ev,e=>{
  e.preventDefault();
  if(ev==='dragover')zone.classList.add('drag');
  if(ev==='dragleave'||ev==='drop')zone.classList.remove('drag');
  if(ev==='drop')loadPhoto(e.dataTransfer.files[0]);
 });
});
function loadPhoto(f){
 if(!f||!f.type.startsWith('image/'))return alert('ĞĞµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ');
 const fr=new FileReader();
 fr.onload=e=>{
   const img=new Image();
   img.onload=_=>{
     let w=img.width,h=img.height;
     if(Math.max(w,h)>2000){
       const k=2000/Math.max(w,h),c=document.createElement('canvas');
       c.width=w*k; c.height=h*k; c.getContext('2d').drawImage(img,0,0,c.width,c.height);
       bgData=c.toDataURL('image/jpeg',0.9);
       alert(`Ğ¤Ğ¾Ñ‚Ğ¾ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¾ Ğ´Ğ¾ ${c.width}Ã—${c.height}px Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹`);
     }else bgData=e.target.result;
     bgImg.src=bgData;
     cv.width=bgImg.width; cv.height=bgImg.height;
     go(2);
   };
   img.src=e.target.result;
 };
 fr.readAsDataURL(f);
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¨ĞĞ“Â 2 â€“ Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const layer=$('#layer'),poly=$('#poly'),pCount=$('#pCount');
layer.addEventListener('click',e=>{
 if(points.length>=12)return;
 const r=layer.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
 const dot=document.createElement('div');
 dot.className='point'; dot.textContent=points.length+1;
 dot.style.left=x+'px'; dot.style.top=y+'px';
 layer.append(dot);
 points.push({x,y,elm:dot});
 pCount.textContent=points.length;
 redrawPoly();
 saveHist();
 if(points.length>=3){$('#next2').disabled=false;}
});
function redrawPoly(){
 poly.innerHTML='';
 if(points.length<2)return;
 const d=points.map((p,i)=>`${i?'L':'M'}${p.x} ${p.y}`).join(' ')+' Z';
 poly.innerHTML=`<path d="${d}" stroke="#4c51bf" stroke-width="2" fill="rgba(76,81,191,.15)"/>`;
}
$('#undoBtn').onclick=_=>{
 if(!lastState)return;
 const st=JSON.parse(lastState);
 points.forEach(p=>p.elm.remove()); points=[];
 st.pts.forEach((p,i)=>{ const el=document.createElement('div');
   el.className='point'; el.textContent=i+1; el.style.left=p.x+'px';el.style.top=p.y+'px';
   layer.append(el); points.push({x:p.x,y:p.y,elm:el});
 });
 tf=st.tf; pCount.textContent=points.length; redrawPoly();
 $('#undoBtn').disabled=true;
};
$('#next2').onclick=_=>go(3);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¨ĞĞ“Â 3 â€“ Ğ³Ğ¾Ğ±Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('#goboInput').onchange=e=>{
 const f=e.target.files[0]; if(!f)return;
 const fr=new FileReader();
 fr.onload=ev=>{
  gobo=new Image();
  gobo.onload=_=>{
   $('#gPrev').innerHTML=`<img src="${gobo.src}" style="max-height:180px">`;
   $('#next3').disabled=false;
  };
  gobo.src=ev.target.result;
 };
 fr.readAsDataURL(f);
};
$('#next3').onclick=_=>{
 initTransform(); buildMesh(); draw(); go(4);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ÑĞµÑ‚ĞºĞ° Ğ¸ Ğ´ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ : Delaunator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildMesh(){
 /* Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ â†’ [0..1]x[0..1] */
 const minX=Math.min(...points.map(p=>p.x)),maxX=Math.max(...points.map(p=>p.x));
 const minY=Math.min(...points.map(p=>p.y)),maxY=Math.max(...points.map(p=>p.y));
 const w=maxX-minX,h=maxY-minY;
 const norm=points.map(p=>[(p.x-minX)/w,(p.y-minY)/h]);
 const delaunay=Delaunator.from(norm);
 mesh=[];
 for(let i=0;i<delaunay.triangles.length;i+=3){
   const a=delaunay.triangles[i],b=delaunay.triangles[i+1],c=delaunay.triangles[i+2];
   mesh.push([points[a],points[b],points[c],
     {sx:norm[a][0]*gobo.width,sy:norm[a][1]*gobo.height},
     {sx:norm[b][0]*gobo.width,sy:norm[b][1]*gobo.height},
     {sx:norm[c][0]*gobo.width,sy:norm[c][1]*gobo.height}]);
 }
}
/* Ğ°Ñ„Ñ„Ğ¸Ğ½Ğ½Ğ°Ñ Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ° */
function drawTriangle(t){
 const [p0,p1,p2,s0,s1,s2]=t;
 ctx.save();
 ctx.beginPath();
 ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.closePath();
 ctx.clip();
 const denom=(p0.x*(p1.y-p2.y)+p1.x*(p2.y-p0.y)+p2.x*(p0.y-p1.y));
 const a=(s0.sx*(p1.y-p2.y)+s1.sx*(p2.y-p0.y)+s2.sx*(p0.y-p1.y))/denom;
 const b=(s0.sy*(p1.y-p2.y)+s1.sy*(p2.y-p0.y)+s2.sy*(p0.y-p1.y))/denom;
 const c=(s0.sx*(p2.x-p1.x)+s1.sx*(p0.x-p2.x)+s2.sx*(p1.x-p0.x))/denom;
 const d=(s0.sy*(p2.x-p1.x)+s1.sy*(p0.x-p2.x)+s2.sy*(p1.x-p0.x))/denom;
 const e=(s0.sx*(p1.x*p2.y-p2.x*p1.y)+s1.sx*(p2.x*p0.y-p0.x*p2.y)+s2.sx*(p0.x*p1.y-p1.x*p0.y))/denom;
 const f=(s0.sy*(p1.x*p2.y-p2.x*p1.y)+s1.sy*(p2.x*p0.y-p0.x*p2.y)+s2.sy*(p0.x*p1.y-p1.x*p0.y))/denom;
 ctx.transform(a,b,c,d,e,f);
 ctx.drawImage(gobo,0,0);
 ctx.restore();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initTransform(){
 /* Ñ†ĞµĞ½Ñ‚Ñ€ Ğ¿Ğ¾Ğ»Ğ¸Ğ³Ğ¾Ğ½Ğ° */
 const xs=points.map(p=>p.x),ys=points.map(p=>p.y);
 const cx=(Math.min(...xs)+Math.max(...xs))/2, cy=(Math.min(...ys)+Math.max(...ys))/2;
 tf.base=Math.max(...xs)-Math.min(...xs);
 tf.x=cx; tf.y=cy; tf.s=1; tf.r=0; tf.o=1;
 $('#opa').value=100; $('#scl').value=100; $('#rot').value=0;
}
function draw(){
 ctx.clearRect(0,0,cv.width,cv.height);
 if(!showOverlay)return;
 ctx.globalAlpha=tf.o;
 /* Ğ¾Ğ±Ğ¾Ğ¹Ğ´Ñ‘Ğ¼ Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½ÑƒÑ ÑĞµÑ‚ĞºÑƒ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ€Ğ¸ÑÑƒĞµĞ¼ Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¸ */
 ctx.save();
 ctx.translate(tf.x,tf.y);
 ctx.rotate(tf.r*Math.PI/180);
 ctx.scale(tf.s,tf.s);
 ctx.translate(-tf.x,-tf.y);
 mesh.forEach(drawTriangle);
 ctx.restore();
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½ĞºĞ¸ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ° ÑˆĞ°Ğ³Ğµâ€¯4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('#opa').oninput=e=>{tf.o=e.target.value/100;draw();}
$('#scl').oninput=e=>{tf.s=e.target.value/100;draw();}
$('#rot').oninput=e=>{tf.r=e.target.value;draw();}
$('#eyeBtn').onclick=_=>{
 showOverlay=!showOverlay; draw();
 $('#eyeBtn').textContent=showOverlay?'ğŸ‘Â Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ':'ğŸ‘Â ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ';
};
$('#help').onclick=intro;
$('#next4').onclick=_=>{renderPreview();go(5);};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PREVIEW + EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderPreview(){
 const prev=$('#prev'); const size=3401;
 prev.width=prev.height=size;
 prev.getContext('2d').drawImage(cv,0,0,size,size);
}
function download(blob,name){
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob); a.download=name; a.click();
 setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
$('#savePNG').onclick=_=>{
 cv.toBlob(b=>download(b,'gobo.png'),'image/png');
};
$('#saveTIF').onclick=_=>{
 const rgbaCtx=cv.getContext('2d');
 const imgData=rgbaCtx.getImageData(0,0,cv.width,cv.height);
 const tiff=UTIF.encodeImage(imgData.data,cv.width,cv.height,{});
 const blob=new Blob([tiff],{type:'image/tiff'});
 download(blob,'gobo.tiff');
};

/* â”€â”€â”€â”€â”€â”€â”€ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ/Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (JSON, base64 inside) â”€â”€â”€ */
$('#saveJSON').onclick=_=>{
 const obj={bg:bgData,gobo:gobo.src,pts:points.map(p=>({x:p.x,y:p.y})),tf};
 download(new Blob([JSON.stringify(obj)],{type:'application/json'}),'gobo-project.json');
};
$('#loadJSON').onclick=_=>{
 const i=document.createElement('input'); i.type='file'; i.accept='.json';
 i.onchange=e=>{
   const fr=new FileReader();
   fr.onload=ev=>{
    const d=JSON.parse(ev.target.result);
    bgData=d.bg; gobo=new Image(); gobo.src=d.gobo;
    gobo.onload=_=>{
      bgImg.src=bgData; cv.width=bgImg.width; cv.height=bgImg.height;
      points.forEach(p=>p.elm.remove()); points=[];
      d.pts.forEach((p,i)=>{
        const dot=document.createElement('div');
        dot.className='point'; dot.textContent=i+1; dot.style.left=p.x+'px';dot.style.top=p.y+'px';
        layer.append(dot); points.push({x:p.x,y:p.y,elm:dot});
      });
      pCount.textContent=points.length; redrawPoly();
      tf=d.tf; buildMesh(); draw(); go(4);
    };
   };
   fr.readAsText(e.target.files[0]);
 };
 i.click();
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PWA SW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js').catch(console.warn);
}
</script>

<!-- â”€â”€â”€ Ğ¼Ğ¸Ğ½Ğ¸â€‘manifest (Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸ Ñ€ÑĞ´Ğ¾Ğ¼ manifest.json Ğ´Ğ»Ñ PWA) â”€â”€â”€
{
 "name": "GOBO Calculatorâ€‘Pro",
 "short_name": "GOBOCalc",
 "start_url": "./",
 "display": "standalone",
 "background_color": "#4c51bf",
 "theme_color": "#4c51bf",
 "icons": [
  { "src": "icon-192.png", "sizes":"192x192", "type":"image/png" },
  { "src": "icon-512.png", "sizes":"512x512", "type":"image/png" }
 ]
}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SW.js (Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CACHE = 'goboâ€‘v1';
self.addEventListener('install', e=>{
 e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','index.html','UTIF.min.js','delaunator.min.js'])));
 self.skipWaiting();
});
self.addEventListener('fetch', e=> {
 e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});
-->
</body>
</html>
