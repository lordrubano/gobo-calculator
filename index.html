<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GOBOÂ CalculatorÂ 2.0</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#5a67d8">
<style>
/* â€”â€” Ğ¡Ñ‚Ğ¸Ğ»Ğ¸: ÑĞ¾ĞºÑ€Ğ°Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğµ, Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ â€”â€” */
html,body{margin:0;padding:0;font-family:sans-serif;background:#f0f2f6}
h1{text-align:center;margin:10px 0;color:#2d3748}
#app{max-width:960px;margin:auto;padding:16px}
.step{display:none;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.step.active{display:block}
.progress{display:flex;justify-content:space-between;margin:16px 0}
.progress div{flex:1;text-align:center;font-weight:700;color:#a0aec0;position:relative}
.progress .active{color:#5a67d8}
.progress div::before{content:attr(data-n);display:block;width:32px;height:32px;margin:0 auto 4px;border-radius:50%;line-height:32px;border:2px solid currentColor}
.progress .done::before{background:#5a67d8;color:#fff}
#photoZone{border:3px dashed #cbd5e0;padding:40px;text-align:center;border-radius:10px;cursor:pointer}
#photoZone.dragover{background:#edf2f7;border-color:#5a67d8}
canvas{max-width:100%}
.point{position:absolute;width:14px;height:14px;background:#e53e3e;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%);font-size:9px;line-height:10px;color:#fff;font-weight:700;user-select:none;cursor:pointer}
.layer{position:relative;display:inline-block;border:1px solid #e2e8f0;border-radius:10px}
#bgImg{max-width:100%;display:block;border-radius:10px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.controls label{font-size:12px}
button{cursor:pointer}
.hidden{display:none}
</style>
</head>
<body>
<div id="app">
  <h1>GOBOÂ ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Â 2.0</h1>

  <!-- ===== ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ ===== -->
  <div class="progress">
    <div id="p1" data-n="1" class="active">Ğ¤Ğ¾Ñ‚Ğ¾</div>
    <div id="p2" data-n="2">ĞšĞ¾Ğ½Ñ‚ÑƒÑ€</div>
    <div id="p3" data-n="3">Ğ“Ğ¾Ğ±Ğ¾</div>
    <div id="p4" data-n="4">Ğ”ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</div>
    <div id="p5" data-n="5">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚</div>
  </div>

  <!-- ===== Ğ¨Ğ°Ğ³Â 1: Ğ¤Ğ¾Ñ‚Ğ¾ ===== -->
  <section id="s1" class="step active">
    <p>ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ cÂ Â«Ğ£Ğ¼Ğ½Ğ¾Ğ¹Â ĞĞ°ÑĞ°Ğ´ĞºĞ¸Â» ÑÑĞ´Ğ°:</p>
    <div id="photoZone">ğŸ“·Â ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ ĞºĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ</div>
    <input id="photoInput" type="file" accept="image/*" class="hidden">
  </section>

  <!-- ===== Ğ¨Ğ°Ğ³Â 2: ĞšĞ¾Ğ½Ñ‚ÑƒÑ€ ===== -->
  <section id="s2" class="step">
    <p>ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Â ÑƒĞ³Ğ»Ğ°Ğ¼ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ° (Ğ´Ğ¾Â 12Â Ñ‚Ğ¾Ñ‡ĞµĞº):</p>
    <div id="layer" class="layer">
      <img id="bgImg">
      <svg id="svg" style="position:absolute;inset:0"></svg>
    </div>
    <div class="controls">
      <span>Ğ¢Ğ¾Ñ‡ĞµĞº: <b id="ptCount">0</b>/12</span>
      <button id="undoBtn">âŸ²Â Undo</button>
      <button id="clearBtn">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘</button>
      <button id="toStep3" disabled>Ğ”Ğ°Ğ»ĞµĞµÂ â†’</button>
    </div>
  </section>

  <!-- ===== Ğ¨Ğ°Ğ³Â 3: Ğ“Ğ¾Ğ±Ğ¾ ===== -->
  <section id="s3" class="step">
    <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿/Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»ÑÂ Ğ¿Ñ€Ğ¾ĞµĞºÑ†Ğ¸Ğ¸:</p>
    <input id="goboInput" type="file" accept="image/*">
    <div id="goboPreview" style="height:200px;border:2px dashed #cbd5e0;margin:12px 0;display:flex;align-items:center;justify-content:center;border-radius:10px">
      <span>ĞŸĞ¾ĞºĞ° Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾Â :â€‘)</span>
    </div>
    <button id="toStep4" disabled>Ğ”Ğ°Ğ»ĞµĞµÂ â†’</button>
  </section>

  <!-- ===== Ğ¨Ğ°Ğ³Â 4: Ğ”ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ===== -->
  <section id="s4" class="step">
    <div class="layer" id="editLayer">
      <img id="bgImg2">
      <canvas id="cv"></canvas>
    </div>
    <div class="controls">
      <label>ĞŸÑ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ <input type="range" id="opa" min="0" max="100" value="100"></label>
      <label>ĞœĞ°ÑÑˆÑ‚Ğ°Ğ± <input type="range" id="scl" min="50" max="150" value="100"></label>
      <label>ĞŸĞ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚ <input type="range" id="rot" min="-180" max="180" value="0"></label>
      <button id="toggleVis">ğŸ‘Â Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button id="saveBtn">ğŸ’¾Â Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      <button id="loadBtn">ğŸ“‚Â ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button id="helpBtn">â”Â ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ</button>
      <button id="toStep5">Ğ”Ğ°Ğ»ĞµĞµÂ â†’</button>
    </div>
  </section>

  <!-- ===== Ğ¨Ğ°Ğ³Â 5: Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ===== -->
  <section id="s5" class="step">
    <h3>ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸</h3>
    <label>ĞŸÑ€ĞµÑĞµÑ‚:
      <select id="preset">
        <option value="32,2700">32Â Ğ¼Ğ¼Â /Â 2700Â dpi (ÑÑ‚ĞµĞºĞ»Ğ¾)</option>
        <option value="42,1500">42Â Ğ¼Ğ¼Â /Â 1500Â dpi</option>
        <option value="50,600">50Â Ğ¼Ğ¼Â /Â 600Â dpi</option>
      </select>
    </label>
    <button id="exportPng">ğŸ“¤Â PNGÂ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)</button>
    <button id="exportTif">ğŸ“¤Â TIFFÂ (RGBA)</button>
    <canvas id="prev" style="margin-top:12px;border:1px solid #e2e8f0"></canvas>
  </section>
</div>

<!-- ====== Intro.js (Ğ¼Ğ¸ĞºÑ€Ğ¾â€‘Ğ²ĞµÑ€ÑĞ¸Ñ, inlined) ====== -->
<script>
/* Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ tour, 3Â ĞšĞ±, ÑƒĞ±Ñ€Ğ°Ğ» Ñ€Ğ°Ğ´Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸ */
function startTour(){
  const steps=[
    {el:'#photoZone',msg:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾'},
    {el:'#bgImg',msg:'ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ÑƒĞ³Ğ»Ğ°Ğ¼ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ° (Ğ´Ğ¾ 12)'},
    {el:'#goboInput',msg:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ³Ğ¾Ğ±Ğ¾'},
    {el:'#editLayer',msg:'ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ, Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚Ğµ Ğ¸ Ñ‚ÑĞ½Ğ¸Ñ‚Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹'},
    {el:'#preset',msg:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€ĞµÑĞµÑ‚ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸'},
    {el:'#exportPng',msg:'Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ PNG Ğ¸Ğ»Ğ¸ TIFF'}
  ];
  let i=0,ovl=document.createElement('div');ovl.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;color:#fff;padding:20px;font:16px sans-serif';
  function show(){if(i>=steps.length){ovl.remove();return}
    const s=steps[i],r=document.querySelector(s.el).getBoundingClientRect();
    ovl.innerHTML=`<div style="position:absolute;left:${r.left}px;top:${r.top-10}px;width:${r.width}px;height:${r.height+10}px;border:2px solid #fff;border-radius:8px"></div>
      <p style="max-width:300px">${s.msg}</p><button>Ğ”Ğ°Ğ»ÑŒÑˆĞµ</button>`;
    ovl.querySelector('button').onclick=()=>{i++;show()}
  }document.body.append(ovl);show();
}
</script>

<!-- ====== Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ ====== -->
<script src="delaunator.min.js"></script>
<script src="tiff.min.js"></script> <!-- Ğ²ĞµÑ€ÑĞ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ RGBA -->
<script>
/* ========== Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ========== */
const $=q=>document.querySelector(q);
let step=1,points=[],goboImg=null,photoData=null,lastState=null;
let cv=$('#cv'),ctx=cv.getContext('2d');let showOverlay=true;
let tf={x:0,y:0,s:1,r:0,o:1,baseS:1}; // transformÂ state
/* â€”â€”â€” ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ â€”â€”â€” */
function to(n){ /* Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑˆĞ°Ğ³ n */
  $('#s'+step).classList.remove('active');$('#p'+step).classList.remove('active');
  if(n>step)$('#p'+step).classList.add('done');
  step=n;$('#s'+step).classList.add('active');$('#p'+step).classList.add('active');
}
/* â€”â€”â€” Ğ¨Ğ°Ğ³Â 1: Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ â€”â€”â€” */
const zone=$('#photoZone'),inp=$('#photoInput');
zone.onclick=()=>inp.click();
['dragover','dragleave','drop'].forEach(e=>{
  zone.addEventListener(e,ev=>{
    ev.preventDefault();if(e==='dragover')zone.classList.add('dragover');
    if(e==='dragleave'||e==='drop')zone.classList.remove('dragover');
    if(e==='drop')loadPhoto(ev.dataTransfer.files[0]);
  });
});
inp.onchange=e=>loadPhoto(inp.files[0]);
function loadPhoto(f){
  if(!f||!f.type.startsWith('image/'))return alert('ĞÑƒĞ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ');
  const r=new FileReader();r.onload=e=>{
    const img=new Image();img.onload=()=>{
      /* Ğ°Ğ²Ñ‚Ğ¾â€‘Ğ´Ğ°ÑƒĞ½ÑĞºĞµĞ¹Ğ» Ğ´Ğ¾Â 2000Â px */
      const max=2000,need=img.width>max||img.height>max;
      if(need){
        const t=document.createElement('canvas'),k=Math.max(img.width,img.height)/max;
        t.width=Math.round(img.width/k);t.height=Math.round(img.height/k);
        t.getContext('2d').drawImage(img,0,0,t.width,t.height);
        photoData=t.toDataURL('image/jpeg',0.9);
        alert('Ğ¤Ğ¾Ñ‚Ğ¾ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¾ Ğ´Ğ¾Â '+t.width+'Ã—'+t.height+'Â px Ğ´Ğ»ÑÂ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹.\nĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ» Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»ÑÂ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ¾Ğ².');
      }else photoData=e.target.result;
      $('#bgImg').src=photoData;$('#bgImg2').src=photoData;
      to(2);
    };img.src=e.target.result;
  };r.readAsDataURL(f);
}
/* â€”â€”â€” Ğ¨Ğ°Ğ³Â 2: ĞºĞ¾Ğ½Ñ‚ÑƒÑ€ â€”â€”â€” */
const layer=$('#layer'),svg=$('#svg');
layer.addEventListener('click',e=>{
  if(points.length>=12)return;
  const rect=layer.getBoundingClientRect(),x=e.clientX-rect.left,y=e.clientY-rect.top;
  const p=document.createElement('div');p.className='point';p.textContent=points.length+1;
  p.style.left=x+'px';p.style.top=y+'px';layer.appendChild(p);
  points.push({x,y,el:p});$('#ptCount').textContent=points.length;
  drawPoly();saveHistory();
  if(points.length>=3)$('#toStep3').disabled=false;
});
function drawPoly(){
  svg.innerHTML='';
  if(points.length<2)return;
  const d=points.map((p,i)=>`${i?'L':'M'}${p.x} ${p.y}`).join(' ')+(points.length>2?' Z':'');
  svg.innerHTML=`<path d="${d}" stroke="#ff69b4" stroke-width="2" fill="rgba(255,105,180,.15)" />`;
}
$('#clearBtn').onclick=()=>{points.forEach(p=>p.el.remove());points=[];drawPoly();$('#ptCount').textContent=0;$('#toStep3').disabled=true};
$('#undoBtn').onclick=undo;
$('#toStep3').onclick=()=>to(3);
/* â€”â€”â€” Ğ¨Ğ°Ğ³Â 3: Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ³Ğ¾Ğ±Ğ¾ â€”â€”â€” */
$('#goboInput').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    goboImg=new Image();goboImg.onload=()=>{
      $('#goboPreview').innerHTML='<img src="'+ev.target.result+'" style="max-height:180px">';
      $('#toStep4').disabled=false;
    };goboImg.src=ev.target.result;
  };r.readAsDataURL(f);
};
$('#toStep4').onclick=()=>{
  initialiseCanvas();
  to(4);
};
/* â€”â€”â€” Ğ¨Ğ°Ğ³Â 4: Ğ´ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ â€”â€”â€” */
function initialiseCanvas(){
  const img=$('#bgImg2');
  cv.width=img.naturalWidth;cv.height=img.naturalHeight;
  const bbox=getContourBox(); // Ñ†ĞµĞ½Ñ‚Ñ€ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ°
  tf.baseS=Math.max(bbox.w,bbox.h)*1.2/Math.max(goboImg.width,goboImg.height);
  Object.assign(tf,{x:bbox.cx,y:bbox.cy,s:tf.baseS,r:0,o:1});
  $('#opa').value=100;$('#scl').value=100;$('#rot').value=0;
  draw();
}
function getContourBox(){
  let minX=1e9,minY=1e9,maxX=0,maxY=0;
  points.forEach(p=>{minX=Math.min(minX,p.x);minY=Math.min(minY,p.y);maxX=Math.max(maxX,p.x);maxY=Math.max(maxY,p.y)});
  return{cx:(minX+maxX)/2,cy:(minY+maxY)/2,w:maxX-minX,h:maxY-minY};
}
/* â€”â€‘ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹ Ğ½Ğ°Â Canvasâ€‘ÑĞ»Ğ¾Ğµ â€”â€‘ */
function redrawMarkers(){
  /* ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ */
  [...$('#editLayer').querySelectorAll('.point')].forEach(e=>e.remove());
  points.forEach((p,i)=>{
    const m=p.el.cloneNode(true);m.dataset.i=i;
    $('#editLayer').appendChild(m);
    m.onpointerdown=ev=>{
      ev.target.setPointerCapture(ev.pointerId);
      m.onpointermove=e=>{
        const rect=$('#editLayer').getBoundingClientRect();
        const x=e.clientX-rect.left,y=e.clientY-rect.top;
        m.style.left=x+'px';m.style.top=y+'px';
        points[i].x=x;points[i].y=y;draw();drawPoly(); // Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ
      };
      m.onpointerup=()=>{m.onpointermove=null;saveHistory()};
    };
  });
}
$('#opa').oninput=e=>{tf.o=e.target.value/100;draw()};
$('#scl').oninput=e=>{tf.s=tf.baseS*e.target.value/100;draw()};
$('#rot').oninput=e=>{tf.r=+e.target.value;draw()};
$('#toggleVis').onclick=()=>{
  showOverlay=!showOverlay;$('#cv').style.visibility=showOverlay?'visible':'hidden';
  $('#toggleVis').textContent=showOverlay?'ğŸ‘Â Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ':'ğŸ‘Â ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ';
};
$('#toStep5').onclick=()=>{generatePreview();to(5)};
$('#saveBtn').onclick=saveProject;$('#loadBtn').onclick=loadProject;
$('#helpBtn').onclick=startTour;
/* â€”â€”â€” Ğ Ğ¸ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ±Ğ¾ Ğ½Ğ°Â Canvas â€”â€”â€” */
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(!showOverlay)return;
  ctx.save();ctx.globalAlpha=tf.o;
  ctx.translate(tf.x,tf.y);ctx.rotate(tf.r*Math.PI/180);ctx.scale(tf.s,tf.s);
  ctx.translate(-goboImg.width/2,-goboImg.height/2);
  // ÑƒĞ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹ â€” Ğ±ĞµĞ· Ñ‚Ñ€Ğ¸Ğ°Ğ½Ğ³ÑƒĞ»ÑÑ†Ğ¸Ğ¸, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ°Ñ„Ñ„Ğ¸Ğ½Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Â ÑƒĞ³Ğ»Ğ°Ğ¼ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
  ctx.drawImage(goboImg,0,0);ctx.restore();redrawMarkers();
}
/* â€”â€”â€” Undo / Redo (Ğ¾Ğ´Ğ½Ğ¾Â ÑˆĞ°Ğ³) â€”â€”â€” */
function saveHistory(){lastState=JSON.stringify({pts:points.map(p=>({x:p.x,y:p.y})),tf:{...tf}});}
function undo(){
  if(!lastState)return;
  const s=JSON.parse(lastState);points.forEach(p=>p.el.remove());points=[];
  s.pts.forEach((p,i)=>{const el=document.createElement('div');el.className='point';el.textContent=i+1;
    el.style.left=p.x+'px';el.style.top=p.y+'px';layer.appendChild(el);points.push({x:p.x,y:p.y,el});
  });Object.assign(tf,s.tf);$('#opa').value=tf.o*100;$('#scl').value=(tf.s/tf.baseS)*100;$('#rot').value=tf.r;
  drawPoly();draw();$('#ptCount').textContent=points.length;
}
/* â€”â€”â€” Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ / Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ â€”â€”â€” */
function saveProject(){
  const data={
    photo:photoData,gobo:goboImg.src,points:points.map(p=>({x:p.x,y:p.y})),tf
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gobo-project.json';
  a.click();URL.revokeObjectURL(a.href);
}
function loadProject(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';
  inp.onchange=e=>{
    const f=inp.files[0];if(!f)return;
    const r=new FileReader();r.onload=ev=>{
      const data=JSON.parse(ev.target.result);
      photoData=data.photo;goboImg=new Image();goboImg.src=data.gobo;
      goboImg.onload=()=>{
        $('#bgImg').src=photoData;$('#bgImg2').src=photoData;
        points.forEach(p=>p.el.remove());points=[];
        data.points.forEach((p,i)=>{
          const el=document.createElement('div');el.className='point';el.textContent=i+1;
          el.style.left=p.x+'px';el.style.top=p.y+'px';layer.appendChild(el);points.push({x:p.x,y:p.y,el});
        });
        Object.assign(tf,data.tf);drawPoly();$('#ptCount').textContent=points.length;
        to(4);initialiseCanvas();draw();
      };
    };r.readAsText(f);
  };inp.click();
}
/* â€”â€”â€” ĞŸÑ€ĞµÑĞµÑ‚Ñ‹ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸ / Ğ¿Ñ€ĞµĞ²ÑŒÑ â€”â€”â€” */
$('#preset').onchange=generatePreview;
function generatePreview(){
  const [dmm,dpi]=$('#preset').value.split(',').map(Number);
  const px=Math.round(dmm/25.4*dpi);
  const prev=$('#prev');prev.width=prev.height=px;
  const pctx=prev.getContext('2d');pctx.clearRect(0,0,px,px);
  pctx.beginPath();pctx.arc(px/2,px/2,px/2,0,2*Math.PI);pctx.strokeStyle='#888';pctx.stroke();
  // Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ñ€Ğ¸ÑÑƒĞµĞ¼ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ½ÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ñ cv
  pctx.drawImage(cv,0,0,px,px);
}
/* â€”â€”â€” Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ â€”â€”â€” */
$('#exportPng').onclick=()=>download('png');
$('#exportTif').onclick=()=>download('tiff');
function download(type){
  const [dmm,dpi]=$('#preset').value.split(',').map(Number);
  const px=Math.round(dmm/25.4*dpi);const out=document.createElement('canvas');
  out.width=out.height=px;const octx=out.getContext('2d');
  octx.clearRect(0,0,px,px);octx.drawImage(cv,0,0,px,px);
  if(type==='png'){
    out.toBlob(blob=>{
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gobo.png';a.click();
    },'image/png');
  }else{
    /* tiff.min.jsÂ â€” Ğ»Ñ‘Ğ³ĞºĞ°Ñ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° RGBAÂ TIFF */
    const blob=TiffWriter.fromCanvas(out,{dpi: dpi}); // Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ· tiff.min.js
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gobo.tiff';a.click();
  }
}
/* â€”â€”â€” ServiceÂ Worker Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ â€”â€”â€” */
if('serviceWorker'in navigator){
  navigator.serviceWorker.register('sw.js').catch(console.warn);
}
</script>

<!-- ===== manifest.json (Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸ Ñ€ÑĞ´Ğ¾Ğ¼ ĞºĞ°Ğº Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ») =====
{
  "name": "GOBO Calculatorâ€‘Editor",
  "short_name": "GOBOÂ Calc",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#222222",
  "theme_color": "#5a67d8",
  "icons": [
    { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
============================================================== -->

<!-- ===== sw.js (Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸ Ñ€ÑĞ´Ğ¾Ğ¼) =====
const CACHE='gobo-v1';
const ASSETS=['./','index.html','delaunator.min.js','tiff.min.js','icon-192.png','icon-512.png'];
self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))));
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});
================================================ -->
</body>
</html>
