<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GOBO Calculator‑Pro (v0.9)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<style>
/* минимальный CSS — только нужное */
body{margin:0;font:15px/1.4 system-ui;background:#f6f7fa;color:#2d3748}
h1{text-align:center;margin:0;padding:12px 0;background:#4c51bf;color:#fff;font-size:20px}
#app{max-width:1024px;margin:0 auto;padding:16px}
.step{display:none}
.step.active{display:block}
#photoZone{border:3px dashed #a0aec0;padding:48px;text-align:center;border-radius:12px;cursor:pointer;transition:.2s}
#photoZone.drag{background:#edf2f7;border-color:#4c51bf}
.layer{position:relative;border:1px solid #e2e8f0;border-radius:8px;display:inline-block}
.point{position:absolute;width:14px;height:14px;transform:translate(-50%,-50%);background:#e53e3e;border:2px solid #fff;border-radius:50%;font:9px/12px monospace;color:#fff;text-align:center;cursor:grab;user-select:none}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
button,input[type=range],select{padding:6px 10px;font:inherit;border-radius:6px;border:1px solid #cbd5e0;background:#fff;cursor:pointer}
button:disabled{opacity:.45;cursor:not-allowed}
canvas{max-width:100%}
#cv{position:absolute;left:0;top:0}
</style>
</head>
<body>
<h1>GOBO Calculator‑Pro</h1>
<div id="app">

<!-- ── ШАГ 1 ── -->
<section id="s1" class="step active">
 <p>1. Перетащи <strong>эталонное фото</strong> или кликни внутри зоны:</p>
 <div id="photoZone">📷 Drop / Click</div>
 <input id="photoInput" type="file" accept="image/*" hidden>
</section>

<!-- ── ШАГ 2 ── -->
<section id="s2" class="step">
 <p>2. Кликни по углам контура (до 12 точек).</p>
 <div id="layer" class="layer">
   <img id="bgImg" alt="">
   <canvas id="cv"></canvas>
   <svg id="poly" style="position:absolute;inset:0"></svg>
 </div>
 <div class="controls">
   <span>Точек: <b id="pCount">0</b>/12</span>
   <button id="undoBtn" disabled>⟲ Undo</button>
   <button id="next2" disabled>Далее →</button>
 </div>
</section>

<!-- ── ШАГ 3 ── -->
<section id="s3" class="step">
 <p>3. Загрузи <strong>картинку гобо</strong> (PNG с альфой лучше).</p>
 <input id="goboInput" type="file" accept="image/*">
 <div id="gPrev" style="height:200px;border:2px dashed #cbd5e0;border-radius:8px;display:flex;align-items:center;justify-content:center;margin:12px 0">—</div>
 <button id="next3" disabled>Далее →</button>
</section>

<!-- ── ШАГ 4 ── -->
<section id="s4" class="step">
 <p>4. Подгони, при необходимости подвигай точки.</p>
 <div class="controls">
  <label>Прозрачн.
   <input type="range" id="opa" min="0" max="100" value="100">
  </label>
  <label>Масштаб
   <input type="range" id="scl" min="50" max="150" value="100">
  </label>
  <label>Поворот
   <input type="range" id="rot" min="-180" max="180" value="0">
  </label>
  <button id="eyeBtn">👁 Скрыть</button>
  <button id="help">❔ Помощь</button>
  <button id="next4">Экспорт →</button>
 </div>
</section>

<!-- ── ШАГ 5 ── -->
<section id="s5" class="step">
 <p>5. Экспорт (по умолчанию 32 мм @2700 DPI → 3401 px).</p>
 <div class="controls">
  <button id="savePNG">📤 PNG</button>
  <button id="saveTIF">📤 TIFF RGBA</button>
  <button id="saveJSON">💾 Сохранить проект</button>
  <button id="loadJSON">📂 Открыть проект</button>
 </div>
 <canvas id="prev" style="border:1px solid #cbd5e0;margin-top:12px"></canvas>
</section>

</div>

<!-- ── библиотеки ── -->
<script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/utif@3.0.0/UTIF.min.js"></script> <!-- для TIFF RGBA -->
<!-- мини‑скрипт интро (3 кБ) -->
<script>
function intro(){
 const steps=[
  ['#photoZone','Загрузите фото объекта'],
  ['#layer','Кликайте, чтобы расставить 3‑12 точек'],
  ['#goboInput','Добавьте логотип / гобо‑изображение'],
  ['#opa','Ползунки: прозрачность / масштаб / поворот'],
  ['#eyeBtn','👁 скройте/покажите наложение'],
  ['#savePNG','Экспортируйте PNG или TIFF']
 ];
 let i=0,ov=document.createElement('div');ov.style='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.6)';
 function show(){
  if(i===steps.length){ov.remove();return}
  const [sel,msg]=steps[i],r=document.querySelector(sel).getBoundingClientRect();
  ov.innerHTML=`<div style="position:absolute;left:${r.left}px;top:${r.top}px;width:${r.width}px;height:${r.height}px;border:2px solid #fff;border-radius:6px"></div>
  <div style="position:absolute;left:${r.left}px;top:${r.bottom+8}px;background:#fff;color:#2d3748;padding:8px 12px;border-radius:6px;max-width:240px">
   ${msg}<br><button style="margin-top:6px">Дальше</button>
  </div>`;
  ov.querySelector('button').onclick=()=>{i++;show()}
 }
 document.body.append(ov);show()
}
</script>

<script>
/* ──────────────────── Глобальные переменные ──────────────────── */
const $=s=>document.querySelector(s);
let step=1;
let bgData='',bgImg=$('#bgImg');
let gobo=null;              /* Image() объекта гобо */
let points=[];              /* {x,y,elm} */
let lastState=null;
let cv=$('#cv'),ctx=cv.getContext('2d');
let tf={x:0,y:0,s:1,r:0,o:1,base:1}; /* transform state */
let mesh=[];                /* массив треугольников после Delaunator */
let showOverlay=true;

/* ─────────────────────── NAVIGATION ─────────────────────────── */
function go(n){
 $('.step.active').classList.remove('active');
 step=n; $('#s'+n).classList.add('active');
}
function saveHist(){ lastState=JSON.stringify({pts:points.map(p=>({x:p.x,y:p.y})),tf:Object.assign({},tf)}); $('#undoBtn').disabled=false }
/* ─────────────────────── ШАГ 1 – фото ───────────────────────── */
const zone=$('#photoZone'),pin=$('#photoInput');
zone.onclick=_=>pin.click();
pin.onchange=e=>loadPhoto(e.target.files[0]);
['dragover','dragleave','drop'].forEach(ev=>{
 zone.addEventListener(ev,e=>{
  e.preventDefault();
  if(ev==='dragover')zone.classList.add('drag');
  if(ev==='dragleave'||ev==='drop')zone.classList.remove('drag');
  if(ev==='drop')loadPhoto(e.dataTransfer.files[0]);
 });
});
function loadPhoto(f){
 if(!f||!f.type.startsWith('image/'))return alert('Не изображение');
 const fr=new FileReader();
 fr.onload=e=>{
   const img=new Image();
   img.onload=_=>{
     let w=img.width,h=img.height;
     if(Math.max(w,h)>2000){
       const k=2000/Math.max(w,h),c=document.createElement('canvas');
       c.width=w*k; c.height=h*k; c.getContext('2d').drawImage(img,0,0,c.width,c.height);
       bgData=c.toDataURL('image/jpeg',0.9);
       alert(`Фото уменьшено до ${c.width}×${c.height}px для плавной работы`);
     }else bgData=e.target.result;
     bgImg.src=bgData;
     cv.width=bgImg.width; cv.height=bgImg.height;
     go(2);
   };
   img.src=e.target.result;
 };
 fr.readAsDataURL(f);
}
/* ─────────────────────── ШАГ 2 – точки ───────────────────────── */
const layer=$('#layer'),poly=$('#poly'),pCount=$('#pCount');
layer.addEventListener('click',e=>{
 if(points.length>=12)return;
 const r=layer.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
 const dot=document.createElement('div');
 dot.className='point'; dot.textContent=points.length+1;
 dot.style.left=x+'px'; dot.style.top=y+'px';
 layer.append(dot);
 points.push({x,y,elm:dot});
 pCount.textContent=points.length;
 redrawPoly();
 saveHist();
 if(points.length>=3){$('#next2').disabled=false;}
});
function redrawPoly(){
 poly.innerHTML='';
 if(points.length<2)return;
 const d=points.map((p,i)=>`${i?'L':'M'}${p.x} ${p.y}`).join(' ')+' Z';
 poly.innerHTML=`<path d="${d}" stroke="#4c51bf" stroke-width="2" fill="rgba(76,81,191,.15)"/>`;
}
$('#undoBtn').onclick=_=>{
 if(!lastState)return;
 const st=JSON.parse(lastState);
 points.forEach(p=>p.elm.remove()); points=[];
 st.pts.forEach((p,i)=>{ const el=document.createElement('div');
   el.className='point'; el.textContent=i+1; el.style.left=p.x+'px';el.style.top=p.y+'px';
   layer.append(el); points.push({x:p.x,y:p.y,elm:el});
 });
 tf=st.tf; pCount.textContent=points.length; redrawPoly();
 $('#undoBtn').disabled=true;
};
$('#next2').onclick=_=>go(3);

/* ─────────────────────── ШАГ 3 – гобо ───────────────────────── */
$('#goboInput').onchange=e=>{
 const f=e.target.files[0]; if(!f)return;
 const fr=new FileReader();
 fr.onload=ev=>{
  gobo=new Image();
  gobo.onload=_=>{
   $('#gPrev').innerHTML=`<img src="${gobo.src}" style="max-height:180px">`;
   $('#next3').disabled=false;
  };
  gobo.src=ev.target.result;
 };
 fr.readAsDataURL(f);
};
$('#next3').onclick=_=>{
 initTransform(); buildMesh(); draw(); go(4);
};

/* ────────────────── сетка и деформация : Delaunator ─────────── */
function buildMesh(){
 /* нормализуем контрольные точки → [0..1]x[0..1] */
 const minX=Math.min(...points.map(p=>p.x)),maxX=Math.max(...points.map(p=>p.x));
 const minY=Math.min(...points.map(p=>p.y)),maxY=Math.max(...points.map(p=>p.y));
 const w=maxX-minX,h=maxY-minY;
 const norm=points.map(p=>[(p.x-minX)/w,(p.y-minY)/h]);
 const delaunay=Delaunator.from(norm);
 mesh=[];
 for(let i=0;i<delaunay.triangles.length;i+=3){
   const a=delaunay.triangles[i],b=delaunay.triangles[i+1],c=delaunay.triangles[i+2];
   mesh.push([points[a],points[b],points[c],
     {sx:norm[a][0]*gobo.width,sy:norm[a][1]*gobo.height},
     {sx:norm[b][0]*gobo.width,sy:norm[b][1]*gobo.height},
     {sx:norm[c][0]*gobo.width,sy:norm[c][1]*gobo.height}]);
 }
}
/* аффинная матрица для треугольника */
function drawTriangle(t){
 const [p0,p1,p2,s0,s1,s2]=t;
 ctx.save();
 ctx.beginPath();
 ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.closePath();
 ctx.clip();
 const denom=(p0.x*(p1.y-p2.y)+p1.x*(p2.y-p0.y)+p2.x*(p0.y-p1.y));
 const a=(s0.sx*(p1.y-p2.y)+s1.sx*(p2.y-p0.y)+s2.sx*(p0.y-p1.y))/denom;
 const b=(s0.sy*(p1.y-p2.y)+s1.sy*(p2.y-p0.y)+s2.sy*(p0.y-p1.y))/denom;
 const c=(s0.sx*(p2.x-p1.x)+s1.sx*(p0.x-p2.x)+s2.sx*(p1.x-p0.x))/denom;
 const d=(s0.sy*(p2.x-p1.x)+s1.sy*(p0.x-p2.x)+s2.sy*(p1.x-p0.x))/denom;
 const e=(s0.sx*(p1.x*p2.y-p2.x*p1.y)+s1.sx*(p2.x*p0.y-p0.x*p2.y)+s2.sx*(p0.x*p1.y-p1.x*p0.y))/denom;
 const f=(s0.sy*(p1.x*p2.y-p2.x*p1.y)+s1.sy*(p2.x*p0.y-p0.x*p2.y)+s2.sy*(p0.x*p1.y-p1.x*p0.y))/denom;
 ctx.transform(a,b,c,d,e,f);
 ctx.drawImage(gobo,0,0);
 ctx.restore();
}

/* ─────────────────────── трансформация ─────────────────────── */
function initTransform(){
 /* центр полигона */
 const xs=points.map(p=>p.x),ys=points.map(p=>p.y);
 const cx=(Math.min(...xs)+Math.max(...xs))/2, cy=(Math.min(...ys)+Math.max(...ys))/2;
 tf.base=Math.max(...xs)-Math.min(...xs);
 tf.x=cx; tf.y=cy; tf.s=1; tf.r=0; tf.o=1;
 $('#opa').value=100; $('#scl').value=100; $('#rot').value=0;
}
function draw(){
 ctx.clearRect(0,0,cv.width,cv.height);
 if(!showOverlay)return;
 ctx.globalAlpha=tf.o;
 /* обойдём точечную сетку — просто рисуем треугольники */
 ctx.save();
 ctx.translate(tf.x,tf.y);
 ctx.rotate(tf.r*Math.PI/180);
 ctx.scale(tf.s,tf.s);
 ctx.translate(-tf.x,-tf.y);
 mesh.forEach(drawTriangle);
 ctx.restore();
}
/* ────────────── ползунки и кнопки на шаге 4 ─────────────────── */
$('#opa').oninput=e=>{tf.o=e.target.value/100;draw();}
$('#scl').oninput=e=>{tf.s=e.target.value/100;draw();}
$('#rot').oninput=e=>{tf.r=e.target.value;draw();}
$('#eyeBtn').onclick=_=>{
 showOverlay=!showOverlay; draw();
 $('#eyeBtn').textContent=showOverlay?'👁 Скрыть':'👁 Показать';
};
$('#help').onclick=intro;
$('#next4').onclick=_=>{renderPreview();go(5);};

/* ─────────────────────── PREVIEW + EXPORT ──────────────────── */
function renderPreview(){
 const prev=$('#prev'); const size=3401;
 prev.width=prev.height=size;
 prev.getContext('2d').drawImage(cv,0,0,size,size);
}
function download(blob,name){
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob); a.download=name; a.click();
 setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
$('#savePNG').onclick=_=>{
 cv.toBlob(b=>download(b,'gobo.png'),'image/png');
};
$('#saveTIF').onclick=_=>{
 const rgbaCtx=cv.getContext('2d');
 const imgData=rgbaCtx.getImageData(0,0,cv.width,cv.height);
 const tiff=UTIF.encodeImage(imgData.data,cv.width,cv.height,{});
 const blob=new Blob([tiff],{type:'image/tiff'});
 download(blob,'gobo.tiff');
};

/* ─────── сохранение/загрузка проекта (JSON, base64 inside) ─── */
$('#saveJSON').onclick=_=>{
 const obj={bg:bgData,gobo:gobo.src,pts:points.map(p=>({x:p.x,y:p.y})),tf};
 download(new Blob([JSON.stringify(obj)],{type:'application/json'}),'gobo-project.json');
};
$('#loadJSON').onclick=_=>{
 const i=document.createElement('input'); i.type='file'; i.accept='.json';
 i.onchange=e=>{
   const fr=new FileReader();
   fr.onload=ev=>{
    const d=JSON.parse(ev.target.result);
    bgData=d.bg; gobo=new Image(); gobo.src=d.gobo;
    gobo.onload=_=>{
      bgImg.src=bgData; cv.width=bgImg.width; cv.height=bgImg.height;
      points.forEach(p=>p.elm.remove()); points=[];
      d.pts.forEach((p,i)=>{
        const dot=document.createElement('div');
        dot.className='point'; dot.textContent=i+1; dot.style.left=p.x+'px';dot.style.top=p.y+'px';
        layer.append(dot); points.push({x:p.x,y:p.y,elm:dot});
      });
      pCount.textContent=points.length; redrawPoly();
      tf=d.tf; buildMesh(); draw(); go(4);
    };
   };
   fr.readAsText(e.target.files[0]);
 };
 i.click();
};

/* ───────────────────────── PWA SW ──────────────────────────── */
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js').catch(console.warn);
}
</script>

<!-- ─── мини‑manifest (положи рядом manifest.json для PWA) ───
{
 "name": "GOBO Calculator‑Pro",
 "short_name": "GOBOCalc",
 "start_url": "./",
 "display": "standalone",
 "background_color": "#4c51bf",
 "theme_color": "#4c51bf",
 "icons": [
  { "src": "icon-192.png", "sizes":"192x192", "type":"image/png" },
  { "src": "icon-512.png", "sizes":"512x512", "type":"image/png" }
 ]
}
─────────────── SW.js (очень простой) ────────────────
const CACHE = 'gobo‑v1';
self.addEventListener('install', e=>{
 e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','index.html','UTIF.min.js','delaunator.min.js'])));
 self.skipWaiting();
});
self.addEventListener('fetch', e=> {
 e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});
-->
</body>
</html>
