// ===================================================================
// == –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –®–ê–ë–õ–û–ù–´ ==
// ===================================================================
const STEPS_CONFIG = [
    { id: 1, title: '–§–æ—Ç–æ' }, { id: 2, title: '–¢–æ—á–∫–∏' }, { id: 3, title: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' },
    { id: 4, title: '–†–µ–¥–∞–∫—Ç–æ—Ä' }, { id: 5, title: '–≠–∫—Å–ø–æ—Ä—Ç' }
];

const STEPS_HTML = {
    1: `<h2><span class="step-number">1</span>–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h2><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —Å–¥–µ–ª–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é ¬´–£–º–Ω–æ–π –ù–∞—Å–∞–¥–∫–∏¬ª.</p><div class="photo-upload-area" id="photoUploadArea"><h3>üì∏ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</h3></div><input type="file" id="photoInput" accept="image/*" style="display: none;">`,
    2: `<h2><span class="step-number">2</span>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2><p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏).</p><div id="photo-container"><img id="step2-photo" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç—É—Ä–∞"><svg id="lines-svg"></svg></div><div style="text-align: right; margin-top: 20px;"><button class="action-button clear-points-btn" onclick="clearAllPoints()">–û—á–∏—Å—Ç–∏—Ç—å</button><button class="action-button" id="step2-next" disabled>–î–∞–ª–µ–µ</button></div>`,
    3: `<h2><span class="step-number">3</span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≥–æ–±–æ</h2><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–æ—Ç–∏–ø).</p><input type="file" id="step3-image-input" class="image-upload-input" accept="image/*"><div id="step3-image-preview"><p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</p></div>`,
    4: `<h2><span class="step-number">4</span>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2><p><b>–ö–æ–ª–µ—Å–æ –º—ã—à–∏</b> - –∑—É–º. <b>–ó–∞–∂–º–∏—Ç–µ Alt + –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞</b> - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞.</p><div class="deformation-stage-wrapper"><div class="deformation-stage" id="deformationStage"><canvas id="deformation-canvas"></canvas></div></div><div class="zoom-controls"><div class="control-group"><label>–ú–∞—Å—à—Ç–∞–± —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: <span id="zoomLevel">100</span>%</label><input type="range" id="zoomSlider" min="10" max="500" value="100"></div><button class="action-button" onclick="resetEditorView()">–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥</button></div><div class="controls-panel"><div class="control-group"><label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="opacityValue">100</span>%</label><input type="range" id="opacitySlider" min="0" max="100" value="100"></div><div class="control-group"><label>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="scaleValue">100</span>%</label><input type="range" id="scaleSlider" min="50" max="150" value="100"></div><div class="control-group"><label>–í—Ä–∞—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="rotationValue">0</span>¬∞</label><input type="range" id="rotationSlider" min="-180" max="180" value="0"></div><div class="control-group pan-controls"><label>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label><div><button onclick="panImage(0, -5)">‚Üë</button><button onclick="panImage(0, 5)">‚Üì</button><button onclick="panImage(-5, 0)">‚Üê</button><button onclick="panImage(5, 0)">‚Üí</button></div></div></div><div style="text-align: right;"><button class="action-button" id="step4-next">–î–∞–ª–µ–µ</button></div>`,
    5: `<h2><span class="step-number">5</span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2><p>–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏ –∏ —Å–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É —Ñ–∞–π–ª.</p><div class="form-row"><div class="form-group"><label for="printDPI">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (DPI):</label><input type="number" id="printDPI" value="2700"></div><div class="form-group"><label for="slideDiameter">–î–∏–∞–º–µ—Ç—Ä —Å–ª–∞–π–¥–∞ (–º–º):</label><input type="number" id="slideDiameter" value="37.5"></div><div class="form-group"><label for="printDiameter">–î–∏–∞–º–µ—Ç—Ä –ø–µ—á–∞—Ç–∏ (–º–º):</label><input type="number" id="printDiameter" value="32"></div><div class="form-group"><label for="alignMark">–ú–µ—Ç–∫–∞:</label><input type="text" id="alignMark" value="PLT"></div></div><div id="finalResult"><canvas id="result-canvas"></canvas></div><div style="text-align: right;"><button class="action-button" onclick="exportFinalGobo()">–°–∫–∞—á–∞—Ç—å .TIFF</button></div>`
};

// ===================================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ===================================================================
let state = {
    currentStep: 1,
    photoData: null,
    userImageSrc: null,
    assignedPoints: [],
    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, initialScale: 1 },
    deformationPoints: [],
    editorView: { zoom: 1, pan: { x: 0, y: 0 } }
};
let userImageElement = null;
let activeControlPoint = null, isPanning = false, panStart = {x:0, y:0};

// ===================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ===================================================================
document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–†–Ø–î–û–ö
    buildInitialUI();      // 1. –°–Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∏–º HTML-–∫–∞—Ä–∫–∞—Å. –¢–µ–ø–µ—Ä—å –≤—Å–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—Ç.
    setupEventListeners(); // 2. –¢–µ–ø–µ—Ä—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º.
    loadState();           // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º UI.
}

function buildInitialUI() {
    const stepsContainer = document.getElementById('steps-container');
    const progressBar = document.getElementById('progressBar');
    stepsContainer.innerHTML = '';
    progressBar.innerHTML = '';
    STEPS_CONFIG.forEach(step => {
        const section = document.createElement('section');
        section.className = 'step-section is-locked';
        section.id = `step${step.id}`;
        section.innerHTML = STEPS_HTML[step.id];
        stepsContainer.appendChild(section);
        const navLink = document.createElement('a');
        navLink.href = `#step${step.id}`;
        navLink.dataset.step = step.id;
        navLink.textContent = `–®–∞–≥ ${step.id}: ${step.title}`;
        progressBar.appendChild(navLink);
    });
}

// ===================================================================
//  –ö–õ–Æ–ß–ï–í–ê–Ø –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ù–ê–ß–ê–¢–¨ –ù–û–í–´–ô –ü–†–û–ï–ö–¢
// ===================================================================
function startNewProject() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.")) {
        localStorage.removeItem('goboProjectState');
        window.location.reload();
    }
}

// ===================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú
// ===================================================================
function unlockStep(stepNumber) {
    if (stepNumber > 5) return;
    const section = document.getElementById(`step${stepNumber}`);
    if (section && section.classList.contains('is-locked')) {
        section.classList.remove('is-locked');
    }
    setTimeout(() => {
        const header = document.querySelector('.header');
        const sectionTop = section.getBoundingClientRect().top + window.pageYOffset - header.offsetHeight;
        window.scrollTo({ top: sectionTop, behavior: 'smooth' });
    }, 100);
    state.currentStep = stepNumber;
    updateProgressUI(stepNumber);
    saveState();
}

function updateProgressUI(activeStep) {
    document.querySelectorAll('#progressBar a').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed', 'unlocked');
        if (stepNum <= activeStep) {
            el.classList.add('unlocked');
            if (stepNum < activeStep) el.classList.add('completed');
            else el.classList.add('active');
        }
    });
    document.querySelectorAll('.step-section').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed');
        if (stepNum < activeStep) el.classList.add('completed');
        else if (stepNum === activeStep) el.classList.add('active');
    });
}


// ===================================================================
// –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø
// ===================================================================
function saveState() {
    const stateToSave = {
        currentStep: state.currentStep,
        photoData: state.photoData,
        userImageSrc: state.userImageSrc,
        assignedPoints: state.assignedPoints.map(p => ({ x: p.x, y: p.y })),
        deformationPoints: state.deformationPoints,
        transform: state.transform
    };
    localStorage.setItem('goboProjectState', JSON.stringify(stateToSave));
}

function loadState() {
    const saved = localStorage.getItem('goboProjectState');
    if (!saved) {
        unlockStep(1); // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥
        return;
    }
    const loadedState = JSON.parse(saved);
    state = {...state, ...loadedState};
    
    let imagesToLoad = 0;
    if (state.photoData) imagesToLoad++;
    if (state.userImageSrc) imagesToLoad++;

    if (imagesToLoad === 0) {
        renderUI();
        return;
    }

    let imagesLoaded = 0;
    const onImageLoaded = () => {
        imagesLoaded++;
        if (imagesLoaded === imagesToLoad) {
            renderUI();
        }
    };

    if (state.photoData) {
        const bgImg = new Image();
        bgImg.src = state.photoData;
        bgImg.onload = onImageLoaded;
    }
    if (state.userImageSrc) {
        userImageElement = new Image();
        userImageElement.src = state.userImageSrc;
        userImageElement.onload = onImageLoaded;
    }
}

function renderUI() {
    if (state.photoData) {
        document.getElementById('photoUploadArea').innerHTML = `<img src="${state.photoData}" style="max-width:100%; border-radius:10px;">`;
        document.getElementById('step2-photo').src = state.photoData;
    }
    const photoContainer = document.getElementById('photo-container');
    while (photoContainer.querySelector('.assigned-point')) {
        photoContainer.querySelector('.assigned-point').remove();
    }
    if (state.assignedPoints && state.assignedPoints.length > 0) {
        state.assignedPoints.forEach(coord => createPointElement(coord.x, coord.y));
        document.getElementById('step2-next').disabled = state.assignedPoints.length < 3;
    }
    if (userImageElement && userImageElement.src) {
        document.getElementById('step3-image-preview').innerHTML = `<img src="${userImageElement.src}" style="max-width:100%; border-radius: 8px;">`;
    }
    for (let i = 1; i <= state.currentStep; i++) {
        document.getElementById(`step${i}`)?.classList.remove('is-locked');
    }
    updateProgressUI(state.currentStep);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (state.currentStep >= 4) setTimeout(initEditor, 100);
    if (state.currentStep === 5) setTimeout(generateFinalResultPreview, 150);

    setTimeout(() => {
        const targetEl = document.getElementById(`step${state.currentStep}`);
        if(targetEl) targetEl.scrollIntoView({ behavior: 'auto', block: 'start' });
    }, 200);
}

// ===================================================================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
// ===================================================================
function setupEventListeners() {
    document.getElementById('photoUploadArea').onclick = () => document.getElementById('photoInput').click();
    document.getElementById('photoInput').onchange = handlePhotoUpload;
    document.getElementById('step2-photo').onclick = handlePointAssignment;
    document.getElementById('step2-next').onclick = () => unlockStep(3);
    document.getElementById('step3-image-input').onchange = handleGoboImageUpload;
    document.getElementById('step4-next').onclick = () => {
        generateFinalResultPreview();
        unlockStep(5);
    };
    setupEditorControls();
}
function handlePhotoUpload(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        state.photoData = ev.target.result;
        document.getElementById('photoUploadArea').innerHTML = `<img src="${state.photoData}" style="max-width:100%; border-radius:10px;">`;
        document.getElementById('step2-photo').src = state.photoData;
        unlockStep(2);
    };
    reader.readAsDataURL(file);
}
function handlePointAssignment(event) {
    const photoElement = event.target; const rect = photoElement.getBoundingClientRect();
    const x = event.clientX - rect.left; const y = event.clientY - rect.top;
    createPointElement(x, y);
    state.assignedPoints.push({ x, y });
    document.getElementById('step2-next').disabled = state.assignedPoints.length < 3;
    saveState();
}
function createPointElement(x, y) {
    const pointEl = document.createElement('div');
    pointEl.className = 'assigned-point';
    pointEl.textContent = state.assignedPoints.length + 1;
    pointEl.style.left = `${x}px`;
    pointEl.style.top = `${y}px`;
    document.getElementById('photo-container').appendChild(pointEl);
}
function clearAllPoints() {
    document.querySelectorAll('#photo-container .assigned-point').forEach(el => el.remove());
    state.assignedPoints = [];
    document.getElementById('step2-next').disabled = true;
    saveState();
}
function handleGoboImageUpload(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        state.userImageSrc = e.target.result;
        userImageElement = new Image();
        userImageElement.src = state.userImageSrc;
        userImageElement.onload = () => {
            document.getElementById('step3-image-preview').innerHTML = `<img src="${userImageElement.src}" style="max-width:100%; border-radius: 8px;">`;
            unlockStep(4);
            setTimeout(initEditor, 50);
        };
    };
    reader.readAsDataURL(file);
}
// ... –û—Å—Ç–∞–ª—å–Ω–æ–π JS –∫–æ–¥ (–≤–µ—Å—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç) –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å ...
// –û–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å —Ü–µ–ª–∏–∫–æ–º.
// –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∞—á–∏–Ω–∞—è —Å initEditor –∏ –¥–æ –∫–æ–Ω—Ü–∞, –±—ã–ª–∏ —Ç—É—Ç.

</script>
</body>
</html>
