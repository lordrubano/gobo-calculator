<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d3748">
    <style>
        html, body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #1a202c; }
        #app { max-width: 960px; margin: 20px auto; padding: 16px; }
        h1 { text-align: center; margin: 10px 0 20px; color: #2d3748; }
        .step { display: none; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin-top: 20px; }
        .step.active { display: block; }
        .progress { display: flex; justify-content: space-between; margin-bottom: 24px; padding: 0; }
        .progress div { flex: 1; text-align: center; font-weight: 600; color: #a0aec0; position: relative; padding-top: 40px; }
        .progress div::before { content: attr(data-n); position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 32px; height: 32px; margin: 0 auto 8px; border-radius: 50%; line-height: 32px; border: 2px solid #cbd5e0; background: #fff; color: #cbd5e0; font-weight: 700; transition: all 0.3s ease; }
        .progress .active { color: #4a5568; }
        .progress .active::before { border-color: #5a67d8; color: #5a67d8; }
        .progress .done::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        #photoZone { border: 3px dashed #cbd5e0; padding: 50px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; background-color: #f7fafc; }
        #photoZone.dragover { background: #e2e8f0; border-color: #5a67d8; }
        .point { position: absolute; width: 14px; height: 14px; background: #e53e3e; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); font-size: 9px; line-height: 10px; text-align: center; color: #fff; font-weight: 700; user-select: none; cursor: grab; box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 10;}
        .point:active { cursor: grabbing; }
        .layer-container { position: relative; display: inline-block; border: 1px solid #e2e8f0; border-radius: 10px; line-height: 0; overflow: hidden; background: #eee; }
        .layer-container.points-limit-reached { cursor: not-allowed; }
        #bgImg, #bgImg2 { max-width: 100%; display: block; border-radius: 10px; }
        #deformation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #points-svg { position: absolute; inset: 0; pointer-events: none; }
        .controls { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; align-items: center; }
        .controls label { font-size: 13px; display: flex; align-items: center; gap: 6px; }
        button, input[type="file"], select { padding: 8px 14px; font-size: 14px; border-radius: 6px; border: 1px solid #cbd5e0; background-color: #fff; cursor: pointer; transition: all 0.2s; }
        button:hover, select:hover { border-color: #a0aec0; background-color: #f7fafc; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .hidden { display: none; }
        #goboPreview { height: 200px; border: 2px dashed #cbd5e0; margin: 12px 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
    </style>
</head>
<body>
<div id="app">
    <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
    <div class="progress">
        <div id="p1" data-n="1" class="active">–§–æ—Ç–æ</div>
        <div id="p2" data-n="2">–ö–æ–Ω—Ç—É—Ä</div>
        <div id="p3" data-n="3">–ü—Ä–æ–µ–∫—Ü–∏—è</div>
        <div id="p4" data-n="4">–î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div id="p5" data-n="5">–≠–∫—Å–ø–æ—Ä—Ç</div>
    </div>

    <section id="s1" class="step active">
        <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –æ–±—ä–µ–∫—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–∑–º–µ—á–µ–Ω –∫–æ–Ω—Ç—É—Ä.</p>
        <div id="photoZone">üì∑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
        <input id="photoInput" type="file" accept="image/*" class="hidden">
    </section>

    <section id="s2" class="step">
        <h2>–®–∞–≥ 2: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2>
        <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º —Ä–∞–∑–º–µ—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞ (–º–∏–Ω–∏–º—É–º 3, –º–∞–∫—Å–∏–º—É–º 12 —Ç–æ—á–µ–∫).</p>
        <div id="contour-layer" class="layer-container">
            <img id="bgImg">
            <svg id="points-svg"></svg>
        </div>
        <div class="controls">
            <span>–¢–æ—á–µ–∫: <b id="ptCount">0</b>/12</span>
            <button id="undoBtn">‚ü≤ –û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
            <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <button id="toStep3" disabled>–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </section>

    <section id="s3" class="step">
        <h2>–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–∏</h2>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø –∏–ª–∏ —Ä–∏—Å—É–Ω–æ–∫ –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º).</p>
        <input id="goboInput" type="file" accept="image/png, image/jpeg">
        <div id="goboPreview"><span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</span></div>
        <button id="toStep4" disabled>–î–∞–ª–µ–µ ‚Üí</button>
    </section>

    <section id="s4" class="step">
        <h2>–®–∞–≥ 4: –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç—É—Ä—É.</p>
        <div id="edit-layer" class="layer-container">
            <img id="bgImg2">
            <canvas id="deformation-canvas"></canvas>
        </div>
        <div class="controls">
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å <input type="range" id="opacity" min="0" max="1" step="0.01" value="0.7"></label>
            <button id="toggleVis">üëÅ –°–∫—Ä—ã—Ç—å</button>
            <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="loadBtn">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            <button id="helpBtn">‚ùî –ü–æ–º–æ—â—å</button>
            <button id="toStep5">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </section>

    <section id="s5" class="step">
        <h2>–®–∞–≥ 5: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2>
        <label>–ü—Ä–µ—Å–µ—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏:
            <select id="preset">
                <option value="32,2700,3401">–°—Ç–µ–∫–ª–æ 32 –º–º / 2700 DPI</option>
                <option value="42,1500,2480">–°–ª–∞–π–¥ 42 –º–º / 1500 DPI</option>
                <option value="50,600,1181">–°–ª–∞–π–¥ 50 –º–º / 600 DPI</option>
            </select>
        </label>
        <p>–ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: <b id="export-size">3401 x 3401 px</b></p>
        <div class="controls">
            <button id="exportPng">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ PNG</button>
            <button id="exportTif">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ TIFF (–¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–π)</button>
        </div>
        <canvas id="preview-canvas" style="margin-top:12px; border:1px solid #e2e8f0; max-width: 300px;"></canvas>
    </section>
</div>

<script>
// --- Delaunator v5.0.0 ---
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Delaunator=e()}(this,function(){"use strict";var t=Math.pow(2,-52),e=new Uint32Array(512);function r(t,e,r,n){var o=t[e].x,i=t[e].y,s=t[r].x,a=t[r].y,u=t[n].x,h=t[n].y,c=(Math.abs(i-a)+Math.abs(a-h)+Math.abs(h-i))*(Math.abs(o-s)+Math.abs(s-u)+Math.abs(u-o)),l=o-u,f=i-h,p=s-u,d=a-h,x=l*l+f*f,g=p*p+d*d,v=o-s,m=i-a,y=v*v+m*m,A=l*d-p*f,D=.5/A,b=(s-o)*(i-h)-(a-i)*(o-u),C=Math.sqrt(b*b*y*g*x);return c*A*A*(x*g*y-C)<0?(g*x+y*x-y*g)*D:(y*g+x*g-x*y)*D}var n=function(t){var n=t.length,o=new Uint32Array(n);if(n>0){for(var i=0;i<n;i++)o[i]=i;o.sort(function(e,r){return t[e].x-t[r].x||t[e].y-t[r].y})}return o};function o(t,e,r,n,o){var i,s,a;if(n-r<=20){for(var u=r+1;u<=n;u++){var h=t[u],c=e[h];i=u-1;var l=e[t[i]];for(;(s=c-l)<0||0===s&&o(t[i],h)<0;)e[t[i+1]]=l,l=e[t[--i]];e[t[i+1]]=c}}else{s=r+(a=n-r)>>1,i=r+1;var f=n;o(t,e,r,s),o(t,e,i,f),o(t,e,r,s)<o(t,e,i,f)?(u=r,s=i):(u=i,s=r);for(var p=s;u<=p&&s<=f;){var d;o(t,e,u,s)<0?(d=t[u++],console.log(d)):d=t[s++],console.log(d)}for(;u<=p;)console.log(t[u++])}}var i="function"==typeof BigInt;function s(t,e,r,n){var o=new DataView(t),i=new DataView(e),s=new DataView(r),a=new DataView(n);return function(t,e){var r=o.getFloat64(8*t,true)-o.getFloat64(8*e,true),n=i.getFloat64(8*t,true)-i.getFloat64(8*e,true);if(n>r)return n> -r;if(n<r)return n< -r;var a=s.getBigInt64(8*t,true),u=s.getBigInt64(8*e,true);return a>u}}return function t(e,r,n,o,i,s,a){var u,h,c,l,f,p,d,x,g,v,m,y,A,D,b,C,_,E,w,M,S,T,N,O,I,B,P,R=n,U=o,z=i;var L=e[n],W=r[L],F=e[o],G=r[F],J=e[i],K=r[J];if(a(L,F)>0){var q=n;n=o,o=q;var Q=L;L=F,F=Q;var X=W;W=G,G=X}if(a(F,J)>0){var Y=o;o=i,i=Y;var Z=F;F=J,J=Z;var V=G;G=K,K=V,a(L,F)>0&&(q=n,n=o,o=q,Q=L,L=F,F=Q,X=W,W=G,G=X)}var H=W,j=G-H,k=K-H;u<0||0===u&&s(F,J)<0?R=n:U=n,u>0||0===u&&s(F,L)<0?U=o:z=o,h<0||0===h&&s(J,L)<0?z=i:R=i;for(var $,tt=R;;){var et=r[e[U]],rt=r[e[z]],nt=U,ot=z;if(a(e[U],e[z])>0){var it=U;U=z,z=it}var st=r[e[U]];h=j*st+(c=k*et-j*rt-(k-j)*st),l=k*H,f=H*H+j*j,p=H*H+k*k,u=l*st+(d=f*rt-p*et-(f-p)*st),u>0?(z=U,j=k,k=r[e[U]]-H):u<0?(U=z,j=r[e[U]]-H):(g=t(e,r,nt,ot,z,s,a),x=t(e,r,nt,ot,U,s,a),g<x?z=U:x<g?U=z:(v=nt,m=ot,a(e[v],e[m])>0&&(y=v,v=m,m=y),A=t(e,r,tt,v,U,s,a),D=t(e,r,tt,m,U,s,a),A<D?U=m:D<A&&(U=v),b=t(e,r,tt,v,z,s,a),C=t(e,r,tt,m,z,s,a),b<C?z=m:C<b&&(z=v),U!==z?U=z=tt===nt?ot:nt:($=tt,tt=U,U=$,$=z,z=tt,tt=$))),h>0?(R=U,U=z,z=R):h<0?(R=z,z=U,U=R):(C_=(v=U,m=z,a(e[v],e[m])>0&&(y=v,v=m,m=y),E=t(e,r,tt,v,R,s,a)),w=t(e,r,tt,m,R,s,a),E<w?R=m:w<E&&(R=v),M=t(e,r,nt,ot,R,s,a),S=t(e,r,tt,z,R,s,a),M<S?R=z:S<M&&(R=tt),T=t(e,r,tt,U,R,s,a),N=t(e,r,nt,ot,R,s,a),T<N?R=U:N<T&&(R=nt),O=nt,I=ot,a(e[O],e[I])>0&&(B=O,O=I,I=B),U===ot?P=t(e,r,I,O,R,s,a):P=t(e,r,O,I,R,s,a),T<P?(U=R,j=r[e[U]]-H,k=r[e[tt]]-H):h<0?R=U:(R=z,U=tt)),tt=R}}var a=function(){function n(t){var n,o;if(i){var s=new BigInt64Array(t.length),a=new BigInt64Array(t.length),u=new BigInt64Array(t.length);n=s,o=a}else{var h=new Float64Array(t.length),c=new Float64Array(t.length);n=h,o=c}for(var l=0;l<t.length;l++){var f=t[l],p=f.x,d=f.y;n[l]=p,o[l]=d}var x=(n[0]-n[1])*(n[0]-n[1]);i&&(this._cx=s[0],this._cy=a[0]),this._x=n,this._y=o,this.triangles=new Uint32Array(0),this._mlen=0;var g,v,m,y;m=(g=n[0])<=(v=n[1])?g:v,y=g<=v?v:g;for(l=2;l<t.length;l++)g=n[l],v=o[l],g<m&&(m=g),g>y&&(y=g);this._minX=m,this._maxX=y,this.update()}return n.from=function(t,e,r){void 0===e&&(e=u),void 0===r&&(r=h);var o=new n(new Array(0));o._x=t,o._y=e,o.ids=r,o._cx=o._cy=null;for(var i=1/0,s=1/0,a=-1/0,c=-1/0,l=0;l<t.length;l++)t[l]<i&&(i=t[l]),e[l]<s&&(s=e[l]),t[l]>a&&(a=t[l]),e[l]>c&&(c=e[l]);return o._minX=i,o._minY=s,o._maxX=a,o._maxY=c,o.update(),o},n.prototype.update=function(){var n,o,i,s=this._x,a=this._y,u=this.ids,h=u?u.length:s.length;if(0===h)return;var c=this._minX,l=this._minY,f=this._maxX,p=this._maxY,d=f-c,x=p-l,g=d>x?d:x,v=(c+f)/2,m=(l+p)/2;if(this.triangles.length<3*h||this._mlen<3*h)this.triangles=new Uint32Array(3*h),this._mlen=3*h;var y,A=this._hash,D=this._edge_stack;A||(this._hashSize=Math.ceil(Math.sqrt(h)),this._hash=A=new Int32Array(this._hashSize),this._edge_stack=D=new Uint32Array(512));var b,C=h-1;for(b=0;b<h;b++){var _=s[b],E=a[b];if(Math.abs(_-v)>g||Math.abs(E-m)>g)y=b;else if(void 0===n||_-c<s[n]-c)n=b;else if(void 0===o||f-_<f-s[o])o=b;else if(void 0===i||E-l<a[i]-l)i=b}var w=y;for(u||(u=this.ids=new Uint32Array(h),b=0;b<h;b++)u[b]=b;var M=u[y];u[y]=u[0],u[0]=M;for(var S=[],T=1,N=0;N<h;N++){b=u[N];var O=s[b]-s[w],I=a[b]-a[w];if(O||I)S.push({i:b,x:O,y:I,t:T,d:O*O+I*I}),T++}o(S,0,S.length-1,function(t,e){return t.d-e.d});var B=S[0].i;for(S.sort(function(t,e){var r,n,o,i,s,u;return o=t.x,i=t.y,s=e.x,u=e.y,(n=i*(s*s+u*u)-u*(o*o+i*i))||(r=o*(s*s+u*u)-s*(o*o+i*i))<0?-1:r>0?1:(o*u-i*s)<0?-1:1}),N=0;N<S.length;N++)u[N+1]=S[N].i;var P=new Uint32Array(h);for(N=0;N<h;N++)P[u[N]]=N;var R=[w,B];P[w]=0,P[B]=1;var U=g*g,z=w,L=B,W=1;for(b=2;b<h;b++){var F=u[b];if(!(r(s[z],a[z],s[L],a[L],s[F],a[F])>U)){var G,J;for(G=W-1;G>=0;G--){var K=R[G];if(r(s[z],a[z],s[K],a[K],s[F],a[F])>U)break}if(!(G<0))for(J=G+1;J<W;J++)r(s[L],a[L],s[R[J]],a[R[J]],s[F],a[F])>U&&R.splice(J,1),W--,J--;if(G===W-1)R.push(F);else{var q=R.splice(G+1);R.push(F),R=R.concat(q)}W++,z=R[0],L=R[W-1]}}var Q=new Int32Array(h);for(b=0;b<W-1;b++)Q[R[b]]=R[b+1];Q[R[W-1]]=R[0];var X,Y,Z,V,H=this.triangles;b=0;var j=0,k=0;for(b=0;b<this._hashSize;b++)A[b]=-1;for(var $=0;$<W;$++){Y=R[$],Z=Q[Y];var tt=Y,et=Z;do{A[Math.floor(1e6*(s[tt]-c)/g)%this._hashSize]=tt,A[Math.floor(1e6*(s[et]-c)/g)%this._hashSize]=et,tt=et,et=Q[tt]}while(tt!==Y);var rt=s[Y],nt=a[Y],ot=s[Z],it=a[Z];D[k++]=Y,D[k++]=Z}for(X=0;k>0;){Z=D[--k],Y=D[--k];var st=s[Y],at=a[Y],ut=s[Z],ht=a[Z],ct=(st+ut)/2,lt=(at+ht)/2,ft=1/0,pt=c-st,dt=s[Y]-c,xt=s[Z]-c,gt=f-s[Y],vt=f-s[Z],mt=f-s[Z],yt=l-a[Y],At=l-a[Z],Dt=a[Y]-l,bt=a[Z]-l,Ct=p-a[Y],_t=p-a[Z],Et=p-a[Z],wt=-1;V=A[Math.floor(1e6*(ct-c)/g)%this._hashSize];var Mt=V;do{var St=s[V],Tt=a[V];if(St>ct+ft&&Tt>lt+ft&&St>st&&Tt>at&&St>ut&&Tt>ht)break;var Nt=(St-st)*(ht-at)-(Tt-at)*(ut-st);if(!(Nt<=t)){var Ot=void 0;if(St>st?dt>pt?Ot=dt:Ot=pt:xt>gt?Ot=gt:Ot=xt,Tt>at?bt>yt?Ot=bt:Ot=yt:Ct>_t?Ot=_t:Ot=Ct,Nt*Nt>Ot*(Math.pow(St-ct,2)+Math.pow(Tt-lt,2)))if((St-ct)*(St-ct)+(Tt-lt)*(Tt-lt)<ft)ft=(St-ct)*(St-ct)+(Tt-lt)*(Tt-lt),wt=V;else;}}while((V=Q[V])!==Mt)}if(wt!==-1){H[j++]=Y,H[j++]=Z,H[j++]=wt;var Tt=Q[wt];Q[Y]=wt,Q[wt]=Z,k<D.length-2&&(D[k++]=Y,D[k++]=wt),k<D.length-2&&(D[k++]=wt,D[k++]=Z)}else Q[Y]=Z}if(0===j)return this;this.triangles=H.subarray(0,j),this.trianglesLen=j,this.hull=R,this.hullLen=W},n}();return a});
// --- CanvasToTIFF v1.0.0 ---
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.CanvasToTIFF=e()}(this,function(){"use strict";var t={};t.fromCanvas=function(t,e){return i(r(t,e))};var e=12,r=function(t,r){void 0===r&&(r={});var n=t.width,o=t.height,i=n*o*4,a=e+i,s=new ArrayBuffer(a),u=new DataView(s),h=t.getContext("2d").getImageData(0,0,n,o).data,c=0;return u.setUint16(c,18761,!0),c+=2,u.setUint16(c,42,!0),c+=2,u.setUint16(c,8,!0),c+=4,u.setUint32(c,e-8,!0),c+=4,c=d(u,c,{width:n,height:o,strips:i,dpi:r.dpi}),function(t,e,r){for(var n=e;n<e+r;n+=4){t.setUint8(n,0),t.setUint8(n+1,0),t.setUint8(n+2,0),t.setUint8(n+3,255)}return e+r}(u,c,i),u},n=function(t){for(var e=[],r=0;r<t.length;r++)e.push(t.charCodeAt(r));return e},o=function(t,e,r){for(var n=0;n<r.length;n++)t.setUint8(e+n,r[n])},i=function(t){return new Blob([t],{type:"image/tiff"})},a=function(t,e){return t.setUint32(e,1,!0),e+4},s=function(t,e,r){return t.setUint32(e,r,!0),e+4},u=function(t,e,r){return t.setUint32(e,r,!0),e+4},h={width:256,height:257,bitsPerSample:258,compression:259,photometricInterpretation:262,stripOffsets:273,orientation:274,samplesPerPixel:277,rowsPerStrip:278,stripByteCounts:279,xResolution:282,yResolution:283,planarConfiguration:284,resolutionUnit:296,software:305,sampleFormat:339},c={bitsPerSample:3,bytes:4,ascii:2,long:4,rational:5,short:3},l=function(t,e,r,n){return t.setUint16(e,r,!0),e+2},f=function(t,e,r,n){var i=e+8;return t.setUint32(e,i,!0),t.setUint32(i,n[0],!0),t.setUint32(i+4,n[1],!0),e+12},p=function(t,e,r,n){var i=e+8,a=e+8;return t.setUint32(e,i,!0),t.setUint32(i,n[0],!0),t.setUint32(i+4,n[1],!0),e+12},d=function(t,e,r){var n,i=[h.width,h.height,h.bitsPerSample,h.photometricInterpretation,h.stripOffsets,h.samplesPerPixel,h.rowsPerStrip,h.stripByteCounts,h.planarConfiguration,h.resolutionUnit];r.dpi&&i.push(h.xResolution,h.yResolution),t.setUint16(e,i.length,!0),e+=2;for(var a=0;a<i.length;a++){var s=i[a];t.setUint16(e,s,!0),e+=2,t.setUint16(e,4,!0),e+=2,s===h.width?(e=u(t,e,r.width)):s===h.height?e=u(t,e,r.height):s===h.photometricInterpretation?(t.setUint32(e,2,!0),e+=4):s===h.stripOffsets?(t.setUint32(e,12,!0),e+=4):s===h.samplesPerPixel?(t.setUint32(e,4,!0),e+=4):s===h.rowsPerStrip?(e=u(t,e,r.height)):s===h.stripByteCounts?e=u(t,e,r.width*r.height*4):s===h.planarConfiguration?(t.setUint32(e,1,!0),e+=4):s===h.xResolution?e=f(t,e,[r.dpi,1]):s===h.yResolution?e=f(t,e,[r.dpi,1]):s===h.resolutionUnit?(t.setUint32(e,2,!0),e+=4):s===h.bitsPerSample&&(t.setUint16(e,4,!0),e+=2,t.setUint16(e,12,!0),e+=2,t.setUint16(e,8,!0),t.setUint16(e+2,8,!0),t.setUint16(e+4,8,!0),t.setUint16(e+6,8,!0))}return e};return t});
</script>

<script>
function startTour() {
    const steps = [
        {el: '#photoZone', msg: '–®–∞–≥ 1: –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Ñ–æ—Ç–æ –æ–±—ä–µ–∫—Ç–∞ —Å —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º.'},
        {el: '#contour-layer', msg: '–®–∞–≥ 2: –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞, —á—Ç–æ–±—ã —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ (–¥–æ 12).'},
        {el: '#goboInput', msg: '–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–æ—Ç–∏–ø).'},
        {el: '#edit-layer', msg: '–®–∞–≥ 4: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç—É—Ä—É.'},
        {el: '#preset', msg: '–®–∞–≥ 5: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–µ—Å–µ—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏.'},
        {el: '#exportPng', msg: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ.'}
    ];
    let i = 0;
    const ovl = document.createElement('div');
    ovl.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;color:#fff;padding:20px;font:16px sans-serif;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;';
    const box = document.createElement('div');
    box.style.cssText = 'position:absolute;border:3px solid #fff;border-radius:8px;box-shadow:0 0 20px #fff;transition:all 0.4s ease-in-out;pointer-events:none;';
    
    function show() {
        if (i >= steps.length) { ovl.remove(); return; }
        const s = steps[i];
        const targetEl = document.querySelector(s.el);
        if (!targetEl) { i++; show(); return; }
        
        targetEl.scrollIntoView({behavior: 'smooth', block: 'center'});
        
        setTimeout(() => {
            const r = targetEl.getBoundingClientRect();
            box.style.left = `${r.left - 5}px`;
            box.style.top = `${r.top - 5}px`;
            box.style.width = `${r.width + 10}px`;
            box.style.height = `${r.height + 10}px`;
            
            ovl.innerHTML = `<p style="max-width:350px;margin-bottom:20px;">${s.msg}</p><button>–î–∞–ª—å—à–µ</button>`;
            ovl.querySelector('button').onclick = () => { i++; show(); };
        }, 400);
    }
    
    document.body.append(ovl);
    ovl.append(box);
    show();
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = q => document.querySelector(q);
    const $$ = q => document.querySelectorAll(q);

    let currentStep = 1;
    let bgPhotoData = null;
    let projectionImage = new Image();
    let contourPoints = [];
    let controlPoints = [];
    let opacity = 0.7;
    let historyStack = [];
    const MAX_POINTS = 12;
    const canvas = $('#deformation-canvas');
    const ctx = canvas.getContext('2d');

    function goToStep(n) {
        $(`#s${currentStep}`).classList.remove('active');
        $(`#p${currentStep}`).classList.remove('active');
        if (n > currentStep) $(`#p${currentStep}`).classList.add('done');
        currentStep = n;
        $(`#s${currentStep}`).classList.add('active');
        $(`#p${currentStep}`).classList.add('active');
    }

    const photoZone = $('#photoZone');
    const photoInput = $('#photoInput');
    photoZone.onclick = () => photoInput.click();
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        photoZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
            if (eventName === 'dragover') photoZone.classList.add('dragover');
            if (eventName === 'dragleave' || eventName === 'drop') photoZone.classList.remove('dragover');
            if (eventName === 'drop') loadPhoto(e.dataTransfer.files[0]);
        });
    });
    photoInput.onchange = e => loadPhoto(e.target.files[0]);

    function loadPhoto(file) {
        if (!file || !file.type.startsWith('image/')) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.'); return; }
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const MAX_DIM = 2000;
                if (img.width > MAX_DIM || img.height > MAX_DIM) {
                    const tempCanvas = document.createElement('canvas');
                    const ratio = Math.max(img.width, img.height) / MAX_DIM;
                    tempCanvas.width = img.width / ratio;
                    tempCanvas.height = img.height / ratio;
                    tempCanvas.getContext('2d').drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                    bgPhotoData = tempCanvas.toDataURL('image/jpeg', 0.9);
                    alert(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ ${tempCanvas.width}x${tempCanvas.height}px –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.`);
                } else {
                    bgPhotoData = e.target.result;
                }
                $('#bgImg').src = bgPhotoData;
                $('#bgImg2').src = bgPhotoData;
                goToStep(2);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    const contourLayer = $('#contour-layer');
    const pointsSvg = $('#points-svg');
    contourLayer.addEventListener('click', e => {
        if (contourPoints.length >= MAX_POINTS) { alert(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_POINTS} —Ç–æ—á–µ–∫.`); return; }
        saveToHistory();
        const rect = contourLayer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const pointEl = document.createElement('div');
        pointEl.className = 'point';
        pointEl.textContent = contourPoints.length + 1;
        pointEl.style.left = `${x}px`;
        pointEl.style.top = `${y}px`;
        contourLayer.appendChild(pointEl);
        contourPoints.push({ x, y, element: pointEl });
        updateContourUI();
    });

    function updateContourUI() {
        $('#ptCount').textContent = contourPoints.length;
        $('#toStep3').disabled = contourPoints.length < 3;
        contourLayer.classList.toggle('points-limit-reached', contourPoints.length >= MAX_POINTS);
        drawPolyline();
    }
    
    function drawPolyline() {
        pointsSvg.innerHTML = '';
        if (contourPoints.length < 2) return;
        const d = contourPoints.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x} ${p.y}`).join(' ') + (contourPoints.length > 2 ? ' Z' : '');
        pointsSvg.innerHTML = `<path d="${d}" stroke="#e53e3e" stroke-width="2" fill="rgba(229, 62, 62, 0.2)" />`;
    }

    $('#clearBtn').onclick = () => {
        saveToHistory();
        contourPoints.forEach(p => p.element.remove());
        contourPoints = [];
        updateContourUI();
    };
    $('#undoBtn').onclick = restoreFromHistory;
    $('#toStep3').onclick = () => goToStep(3);

    $('#goboInput').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            projectionImage = new Image();
            projectionImage.onload = () => {
                $('#goboPreview').innerHTML = `<img src="${ev.target.result}" style="max-height:180px; max-width:100%;">`;
                $('#toStep4').disabled = false;
            };
            projectionImage.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
    $('#toStep4').onclick = () => {
        setupDeformationStep();
        goToStep(4);
    };

    function setupDeformationStep() {
        const bgImg = $('#bgImg2');
        canvas.width = bgImg.naturalWidth;
        canvas.height = bgImg.naturalHeight;

        $$('#edit-layer .point').forEach(p => p.remove());
        controlPoints = [];

        contourPoints.forEach((p, i) => {
            const controlPointEl = document.createElement('div');
            controlPointEl.className = 'point';
            controlPointEl.textContent = i + 1;
            controlPointEl.style.left = `${p.x}px`;
            controlPointEl.style.top = `${p.y}px`;
            $('#edit-layer').appendChild(controlPointEl);
            const cp = { x: p.x, y: p.y, element: controlPointEl };
            controlPoints.push(cp);

            let isDragging = false;
            controlPointEl.addEventListener('pointerdown', e => {
                isDragging = true;
                e.target.setPointerCapture(e.pointerId);
                e.target.style.cursor = 'grabbing';
            });
            controlPointEl.addEventListener('pointermove', e => {
                if (!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const newX = (e.clientX - rect.left) * scaleX;
                const newY = (e.clientY - rect.top) * scaleY;
                cp.x = newX;
                cp.y = newY;
                controlPointEl.style.left = `${newX / scaleX}px`;
                controlPointEl.style.top = `${newY / scaleY}px`;
                drawDeformedImage(canvas, ctx, projectionImage, controlPoints);
            });
            controlPointEl.addEventListener('pointerup', e => {
                isDragging = false;
                e.target.releasePointerCapture(e.pointerId);
                e.target.style.cursor = 'grab';
            });
        });
        
        $('#opacity').value = opacity;
        drawDeformedImage(canvas, ctx, projectionImage, controlPoints);
    }
    
    function drawDeformedImage(targetCanvas, targetCtx, img, destPoints, highQuality = false) {
        targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
        if (destPoints.length < 3 || !img.width) return;

        const srcPoints = [ { x: 0, y: 0 }, { x: img.width, y: 0 }, { x: img.width, y: img.height }, { x: 0, y: img.height } ];
        
        const tempDestPoints = [...destPoints];
        if (tempDestPoints.length === 4) {
             srcPoints.push({ x: img.width / 2, y: img.height / 2 });
             const destBbox = getBoundingBox(tempDestPoints);
             tempDestPoints.push({x: destBbox.cx, y: destBbox.cy });
        }

        const delaunay = Delaunator.from(tempDestPoints.map(p => [p.x, p.y]));
        const triangles = delaunay.triangles;

        targetCtx.save();
        targetCtx.globalAlpha = highQuality ? 1.0 : opacity;

        for (let i = 0; i < triangles.length; i += 3) {
            const p0_idx = triangles[i], p1_idx = triangles[i+1], p2_idx = triangles[i+2];
            const p0 = tempDestPoints[p0_idx], p1 = tempDestPoints[p1_idx], p2 = tempDestPoints[p2_idx];
            const s0 = srcPoints[p0_idx], s1 = srcPoints[p1_idx], s2 = srcPoints[p2_idx];

            if (!p0 || !p1 || !p2 || !s0 || !s1 || !s2) continue;
            
            targetCtx.save();
            targetCtx.beginPath();
            targetCtx.moveTo(p0.x, p0.y); targetCtx.lineTo(p1.x, p1.y); targetCtx.lineTo(p2.x, p2.y);
            targetCtx.closePath();
            targetCtx.clip();

            const delta = s1.x * s2.y + s0.x * s1.y + s2.x * s0.y - s1.x * s0.y - s2.x * s1.y - s0.x * s2.y;
            if (Math.abs(delta) < 1e-9) { targetCtx.restore(); continue; }

            const A = (p1.x * s2.y + p0.x * s1.y + p2.x * s0.y - p1.x * s0.y - p2.x * s1.y - p0.x * s2.y) / delta;
            const B = (p1.y * s2.y + p0.y * s1.y + p2.y * s0.y - p1.y * s0.y - p2.y * s1.y - p0.y * s2.y) / delta;
            const C = (p1.x * s0.x + p0.x * s2.x + p2.x * s1.x - p1.x * s2.x - p2.x * s0.x - p0.x * s1.x) / delta;
            const D = (p1.y * s0.x + p0.y * s2.x + p2.y * s1.x - p1.y * s2.x - p2.y * s0.x - p0.y * s1.x) / delta;
            const E = (p1.x * (s2.x * s0.y - s0.x * s2.y) + p0.x * (s1.x * s2.y - s2.x * s1.y) + p2.x * (s0.x * s1.y - s1.x * s0.y)) / delta;
            const F = (p1.y * (s2.x * s0.y - s0.x * s2.y) + p0.y * (s1.x * s2.y - s2.x * s1.y) + p2.y * (s0.x * s1.y - s1.x * s0.y)) / delta;

            targetCtx.transform(A, B, C, D, E, F);
            targetCtx.drawImage(img, 0, 0);
            targetCtx.restore();
        }
        targetCtx.restore();
    }

    function getBoundingBox(points) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        points.forEach(p => {
            minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
            maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
        });
        const w = maxX - minX, h = maxY - minY;
        return { cx: minX + w / 2, cy: minY + h / 2, w, h };
    }

    $('#opacity').oninput = e => { opacity = +e.target.value; drawDeformedImage(canvas, ctx, projectionImage, controlPoints); };
    $('#toggleVis').onclick = () => {
        const isVisible = canvas.style.visibility !== 'hidden';
        canvas.style.visibility = isVisible ? 'hidden' : 'visible';
        $('#toggleVis').textContent = isVisible ? 'üëÅ –ü–æ–∫–∞–∑–∞—Ç—å' : 'üëÅ –°–∫—Ä—ã—Ç—å';
    };
    $('#toStep5').onclick = () => { generatePreview(); goToStep(5); };
    $('#saveBtn').onclick = saveProject;
    $('#loadBtn').onclick = loadProject;
    $('#helpBtn').onclick = startTour;

    function saveToHistory() {
        historyStack.push(JSON.stringify(contourPoints.map(p => ({ x: p.x, y: p.y }))));
    }
    function restoreFromHistory() {
        if (historyStack.length === 0) return;
        const lastState = JSON.parse(historyStack.pop());
        contourPoints.forEach(p => p.element.remove());
        contourPoints = [];
        lastState.forEach((p, i) => {
            const pointEl = document.createElement('div');
            pointEl.className = 'point';
            pointEl.textContent = i + 1;
            pointEl.style.left = `${p.x}px`; pointEl.style.top = `${p.y}px`;
            contourLayer.appendChild(pointEl);
            contourPoints.push({ x: p.x, y: p.y, element: pointEl });
        });
        updateContourUI();
    }

    function saveProject() {
        const projectData = { bgPhoto: bgPhotoData, projectionSrc: projectionImage.src, contour: contourPoints.map(p => ({ x: p.x, y: p.y })) };
        const blob = new Blob([JSON.stringify(projectData)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'gobo-project.json';
        a.click();
        URL.revokeObjectURL(a.href);
    }
    function loadProject() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const data = JSON.parse(ev.target.result);
                bgPhotoData = data.bgPhoto;
                projectionImage.src = data.projectionSrc;
                contourPoints = data.contour.map(p => ({...p}));
                projectionImage.onload = () => {
                    $('#bgImg').src = bgPhotoData; $('#bgImg2').src = bgPhotoData;
                    $('#goboPreview').innerHTML = `<img src="${projectionImage.src}" style="max-height:180px; max-width:100%;">`;
                    $('#toStep4').disabled = false;
                    goToStep(4);
                    setupDeformationStep();
                };
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    const presetSelect = $('#preset');
    presetSelect.onchange = generatePreview;

    function generatePreview() {
        const [, , size] = presetSelect.value.split(',').map(Number);
        $('#export-size').textContent = `${size} x ${size} px`;
        const previewCanvas = $('#preview-canvas');
        const pctx = previewCanvas.getContext('2d');
        const previewSize = Math.min(300, size);
        previewCanvas.width = previewSize; previewCanvas.height = previewSize;
        pctx.fillStyle = '#000';
        pctx.fillRect(0, 0, previewSize, previewSize);
        pctx.drawImage(canvas, 0, 0, previewSize, previewSize);
        pctx.globalCompositeOperation = 'destination-in';
        pctx.beginPath();
        pctx.arc(previewSize / 2, previewSize / 2, previewSize / 2, 0, 2 * Math.PI);
        pctx.fill();
        pctx.globalCompositeOperation = 'source-over';
    }

    $('#exportPng').onclick = () => exportFinalImage('png');
    $('#exportTif').onclick = () => exportFinalImage('tiff');

    function exportFinalImage(format) {
        const [dmm, dpi, px] = presetSelect.value.split(',').map(Number);
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = px; exportCanvas.height = px;
        const exportCtx = exportCanvas.getContext('2d');
        const scaleFactor = px / $('#bgImg2').naturalWidth;
        const scaledControlPoints = controlPoints.map(p => ({ x: p.x * scaleFactor, y: p.y * scaleFactor }));

        drawDeformedImage(exportCanvas, exportCtx, projectionImage, scaledControlPoints, true);

        exportCtx.globalCompositeOperation = 'destination-in';
        exportCtx.fillStyle = '#000';
        exportCtx.beginPath();
        exportCtx.arc(px / 2, px / 2, px / 2, 0, 2 * Math.PI);
        exportCtx.fill();
        exportCtx.globalCompositeOperation = 'source-over';
        
        const filename = `projection_${dmm}mm_${dpi}dpi`;
        if (format === 'png') {
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${filename}.png`;
                a.click();
                URL.revokeObjectURL(url);
            }, 'image/png');
        } else if (format === 'tiff') {
            const tiffBlob = CanvasToTIFF.toBlob(exportCanvas, { dpi });
            const url = URL.createObjectURL(tiffBlob);
            const a = document.createElement('a');
            a.href = url; a.download = `${filename}.tiff`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
    
    // –î–ª—è PWA, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
    /*
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => {
                console.error('Service Worker registration failed: ', err);
            });
        });
    }
    */
});
</script>

</body>
</html>
