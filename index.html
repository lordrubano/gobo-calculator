<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–§–∏–Ω–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #1a202c; line-height: 1.5; }
        #app { max-width: 960px; margin: 20px auto; padding: 16px; }
        h1 { text-align: center; margin: 10px 0 20px; color: #2d3748; }
        h2 { margin-top: 0; }
        .step { display: none; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin-top: 20px; }
        .step.active { display: block; }
        .progress { display: flex; justify-content: space-between; margin-bottom: 24px; padding: 0; }
        .progress div { flex: 1; text-align: center; font-weight: 600; color: #a0aec0; position: relative; padding-top: 40px; }
        .progress div::before { content: attr(data-n); position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 32px; height: 32px; margin: 0 auto 8px; border-radius: 50%; line-height: 32px; border: 2px solid #cbd5e0; background: #fff; color: #cbd5e0; font-weight: 700; transition: all 0.3s ease; }
        .progress .active { color: #4a5568; }
        .progress .active::before { border-color: #5a67d8; color: #5a67d8; }
        .progress .done::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        #photoZone { border: 3px dashed #cbd5e0; padding: 50px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; background-color: #f7fafc; }
        #photoZone.dragover { background: #e2e8f0; border-color: #5a67d8; }
        .point { position: absolute; width: 14px; height: 14px; background: #e53e3e; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); font-size: 9px; line-height: 10px; text-align: center; color: #fff; font-weight: 700; user-select: none; cursor: grab; box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 10;}
        .point:active { cursor: grabbing; }
        .layer-container { position: relative; display: inline-block; border: 1px solid #e2e8f0; border-radius: 10px; line-height: 0; overflow: hidden; background: #eee; }
        .layer-container.points-limit-reached { cursor: not-allowed; }
        #bgImg, #bgImg2 { max-width: 100%; display: block; border-radius: 10px; }
        #deformation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #points-svg { position: absolute; inset: 0; pointer-events: none; }
        .controls { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; align-items: center; }
        .controls label { font-size: 13px; display: flex; align-items: center; gap: 6px; }
        button, input[type="file"], select { padding: 8px 14px; font-size: 14px; border-radius: 6px; border: 1px solid #cbd5e0; background-color: #fff; cursor: pointer; transition: all 0.2s; }
        button:hover, select:hover { border-color: #a0aec0; background-color: #f7fafc; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .hidden { display: none; }
        #goboPreview { height: 200px; border: 2px dashed #cbd5e0; margin: 12px 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
    </style>
</head>
<body>
<div id="app">
    <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
    <div class="progress">
        <div id="p1" data-n="1" class="active">–§–æ—Ç–æ</div>
        <div id="p2" data-n="2">–ö–æ–Ω—Ç—É—Ä</div>
        <div id="p3" data-n="3">–ü—Ä–æ–µ–∫—Ü–∏—è</div>
        <div id="p4" data-n="4">–î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div id="p5" data-n="5">–≠–∫—Å–ø–æ—Ä—Ç</div>
    </div>

    <section id="s1" class="step active">
        <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –æ–±—ä–µ–∫—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–∑–º–µ—á–µ–Ω –∫–æ–Ω—Ç—É—Ä.</p>
        <div id="photoZone">üì∑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
        <input id="photoInput" type="file" accept="image/*" class="hidden">
    </section>

    <section id="s2" class="step">
        <h2>–®–∞–≥ 2: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2>
        <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º —Ä–∞–∑–º–µ—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞ (–º–∏–Ω–∏–º—É–º 3, –º–∞–∫—Å–∏–º—É–º 12 —Ç–æ—á–µ–∫).</p>
        <div id="contour-layer" class="layer-container">
            <img id="bgImg">
            <svg id="points-svg"></svg>
        </div>
        <div class="controls">
            <span>–¢–æ—á–µ–∫: <b id="ptCount">0</b>/12</span>
            <button id="undoBtn">‚ü≤ –û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
            <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <button id="toStep3" disabled>–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </section>

    <section id="s3" class="step">
        <h2>–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–∏</h2>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø –∏–ª–∏ —Ä–∏—Å—É–Ω–æ–∫ –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º).</p>
        <input id="goboInput" type="file" accept="image/png, image/jpeg">
        <div id="goboPreview"><span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</span></div>
        <button id="toStep4" disabled>–î–∞–ª–µ–µ ‚Üí</button>
    </section>

    <section id="s4" class="step">
        <h2>–®–∞–≥ 4: –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç—É—Ä—É.</p>
        <div id="edit-layer" class="layer-container">
            <img id="bgImg2">
            <canvas id="deformation-canvas"></canvas>
        </div>
        <div class="controls">
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å <input type="range" id="opacity" min="0" max="1" step="0.01" value="0.7"></label>
            <button id="toggleVis">üëÅ –°–∫—Ä—ã—Ç—å</button>
            <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="loadBtn">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            <button id="toStep5">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </section>

    <section id="s5" class="step">
        <h2>–®–∞–≥ 5: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2>
        <label>–ü—Ä–µ—Å–µ—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏:
            <select id="preset">
                <option value="32,2700,3401">–°—Ç–µ–∫–ª–æ 32 –º–º / 2700 DPI</option>
                <option value="42,1500,2480">–°–ª–∞–π–¥ 42 –º–º / 1500 DPI</option>
                <option value="50,600,1181">–°–ª–∞–π–¥ 50 –º–º / 600 DPI</option>
            </select>
        </label>
        <p>–ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: <b id="export-size">3401 x 3401 px</b></p>
        <div class="controls">
            <button id="exportPng">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ PNG</button>
            <button id="exportTif">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ TIFF (–¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–π)</button>
        </div>
        <canvas id="preview-canvas" style="margin-top:12px; border:1px solid #e2e8f0; max-width: 300px;"></canvas>
    </section>
</div>

<script>
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Delaunator=e()}(this,function(){"use strict";var t=Math.pow(2,-52);function e(t,e,r,n){var o=t[e],i=t[r],s=t[n],a=o.x,h=o.y,u=i.x,c=i.y,l=s.x,f=s.y,p=Math.abs(h-c),d=Math.abs(c-f),x=Math.abs(f-h),g=a-l,v=h-f,m=u-l,y=c-f,A=g*g+v*v,b=m*m+y*y,D=a-u,E=h-c,_=D*D+E*E,w=(p+d+x)*(Math.abs(g)+Math.abs(m)+Math.abs(D)),M=(a-u)*(h-f)-(c-h)*(a-l),S=Math.sqrt(M*M*_*b*A);return w*(g*y-m*v)*2*(A*b*_-S)<0?(b*A+_*A-_*b)/(2*(g*y-m*v)):(_*b+A*b-A*_)/(2*(g*y-m*v))}var r=new Uint32Array(512);return function(){function n(e){var n=e.length;this.coords=e,this.hull=new Uint32Array(n);var o=1/0,i=1/0,s=-1/0,a=-1/0;this.triangles=new Uint32Array(3*(n-2)+3);var h=r;h||(h=r=new Uint32Array(512));var u,c,l,f,p,d,x;for(u=0;u<n;u++){var g=e[u],v=g.x,m=g.y;v<o&&(o=v),m<i&&(i=m),v>s&&(s=v),m>a&&(a=m),g.i=u}var y,A,b=Math.max(s-o,a-i);for(A=(o+s)/2,y=(i+a)/2,u=0;u<n;u++){var D=e[u];if(Math.max(Math.abs(D.x-A),Math.abs(D.y-y))===b){f=D;break}}for(e.sort(function(t,e){return Math.sqrt(Math.pow(t.x-f.x,2)+Math.pow(t.y-f.y,2))-Math.sqrt(Math.pow(e.x-f.x,2)+Math.pow(e.y-f.y,2))}),u=0;u<n;u++)e[u].prev=e[u>0?u-1:n-1],e[u].next=e[u<n-1?u+1:0];var E=e[0];if(this.hull[0]=E.i,c=1,l=0,p=E;;)if(d=p.next,x=d.next,e(p,d,x)>t)this.triangles[l]=p.i,this.triangles[l+1]=d.i,this.triangles[l+2]=x.i,l+=3,p.next=x,x.prev=p,c--,this.hull[c-1]=p.i,p=x;else{if(p===E&&c>1)break;this.hull[c++]=d.i,p=d}}return n.prototype.update=function(){},n}();!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.CanvasToTIFF=e()}(this,function(){"use strict";var t={};t.fromCanvas=function(t,e){return i(r(t,e))};var e=12,r=function(t,r){void 0===r&&(r={});var n=t.width,o=t.height,i=n*o*4,a=e+i,s=new ArrayBuffer(a),u=new DataView(s),h=t.getContext("2d").getImageData(0,0,n,o).data,c=0;return u.setUint16(c,18761,!0),c+=2,u.setUint16(c,42,!0),c+=2,u.setUint16(c,8,!0),c+=4,u.setUint32(c,e-8,!0),c+=4,c=d(u,c,{width:n,height:o,strips:i,dpi:r.dpi}),function(t,e,r){for(var n=e;n<e+r;n+=4){t.setUint8(n,0),t.setUint8(n+1,0),t.setUint8(n+2,0),t.setUint8(n+3,255)}return e+r}(u,c,i),u},n=function(t){for(var e=[],r=0;r<t.length;r++)e.push(t.charCodeAt(r));return e},o=function(t,e,r){for(var n=0;n<r.length;n++)t.setUint8(e+n,r[n])},i=function(t){return new Blob([t],{type:"image/tiff"})},a=function(t,e){return t.setUint32(e,1,!0),e+4},s=function(t,e,r){return t.setUint32(e,r,!0),e+4},u=function(t,e,r){return t.setUint32(e,r,!0),e+4},h={width:256,height:257,bitsPerSample:258,compression:259,photometricInterpretation:262,stripOffsets:273,orientation:274,samplesPerPixel:277,rowsPerStrip:278,stripByteCounts:279,xResolution:282,yResolution:283,planarConfiguration:284,resolutionUnit:296,software:305,sampleFormat:339},c={bitsPerSample:3,bytes:4,ascii:2,long:4,rational:5,short:3},l=function(t,e,r,n){return t.setUint16(e,r,!0),e+2},f=function(t,e,r,n){var i=e+8;return t.setUint32(e,i,!0),t.setUint32(i,n[0],!0),t.setUint32(i+4,n[1],!0),e+12},p=function(t,e,r,n){var i=e+8,a=e+8;return t.setUint32(e,i,!0),t.setUint32(i,n[0],!0),t.setUint32(i+4,n[1],!0),e+12},d=function(t,e,r){var n,i=[h.width,h.height,h.bitsPerSample,h.photometricInterpretation,h.stripOffsets,h.samplesPerPixel,h.rowsPerStrip,h.stripByteCounts,h.planarConfiguration,h.resolutionUnit];r.dpi&&i.push(h.xResolution,h.yResolution),t.setUint16(e,i.length,!0),e+=2;for(var a=0;a<i.length;a++){var s=i[a];t.setUint16(e,s,!0),e+=2,t.setUint16(e,4,!0),e+=2,s===h.width?(e=u(t,e,r.width)):s===h.height?e=u(t,e,r.height):s===h.photometricInterpretation?(t.setUint32(e,2,!0),e+=4):s===h.stripOffsets?(t.setUint32(e,12,!0),e+=4):s===h.samplesPerPixel?(t.setUint32(e,4,!0),e+=4):s===h.rowsPerStrip?(e=u(t,e,r.height)):s===h.stripByteCounts?e=u(t,e,r.width*r.height*4):s===h.planarConfiguration?(t.setUint32(e,1,!0),e+=4):s===h.xResolution?e=f(t,e,[r.dpi,1]):s===h.yResolution?e=f(t,e,[r.dpi,1]):s===h.resolutionUnit?(t.setUint32(e,2,!0),e+=4):s===h.bitsPerSample&&(t.setUint16(e,4,!0),e+=2,t.setUint16(e,12,!0),e+=2,t.setUint16(e,8,!0),t.setUint16(e+2,8,!0),t.setUint16(e+4,8,!0),t.setUint16(e+6,8,!0))}return e};return t});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = q => document.querySelector(q);
    const $$ = q => document.querySelectorAll(q);

    let currentStep = 1;
    let bgPhotoData = null;
    let projectionImage = new Image();
    let contourPoints = [];
    let controlPoints = [];
    let opacity = 0.7;
    let historyStack = [];
    const MAX_POINTS = 12;
    const canvas = $('#deformation-canvas');
    const ctx = canvas.getContext('2d');

    function goToStep(n) {
        $(`#s${currentStep}`).classList.remove('active');
        $(`#p${currentStep}`).classList.remove('active');
        if (n > currentStep) $(`#p${currentStep}`).classList.add('done');
        currentStep = n;
        $(`#s${currentStep}`).classList.add('active');
        $(`#p${currentStep}`).classList.add('active');
    }

    const photoZone = $('#photoZone');
    const photoInput = $('#photoInput');
    photoZone.onclick = () => photoInput.click();
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        photoZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
            if (eventName === 'dragover') photoZone.classList.add('dragover');
            if (eventName === 'dragleave' || eventName === 'drop') photoZone.classList.remove('dragover');
            if (eventName === 'drop') loadPhoto(e.dataTransfer.files[0]);
        });
    });
    photoInput.onchange = e => loadPhoto(e.target.files[0]);

    function loadPhoto(file) {
        if (!file || !file.type.startsWith('image/')) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.'); return; }
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const MAX_DIM = 2000;
                if (img.width > MAX_DIM || img.height > MAX_DIM) {
                    const tempCanvas = document.createElement('canvas');
                    const ratio = Math.max(img.width, img.height) / MAX_DIM;
                    tempCanvas.width = img.width / ratio;
                    tempCanvas.height = img.height / ratio;
                    tempCanvas.getContext('2d').drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                    bgPhotoData = tempCanvas.toDataURL('image/jpeg', 0.9);
                    alert(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ ${tempCanvas.width}x${tempCanvas.height}px –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.`);
                } else {
                    bgPhotoData = e.target.result;
                }
                $('#bgImg').src = bgPhotoData;
                $('#bgImg2').src = bgPhotoData;
                goToStep(2);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    const contourLayer = $('#contour-layer');
    const pointsSvg = $('#points-svg');
    contourLayer.addEventListener('click', e => {
        if (contourPoints.length >= MAX_POINTS) { alert(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ ${MAX_POINTS} —Ç–æ—á–µ–∫.`); return; }
        saveToHistory();
        const rect = contourLayer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const pointEl = document.createElement('div');
        pointEl.className = 'point';
        pointEl.textContent = contourPoints.length + 1;
        pointEl.style.left = `${x}px`;
        pointEl.style.top = `${y}px`;
        contourLayer.appendChild(pointEl);
        contourPoints.push({ x, y, element: pointEl });
        updateContourUI();
    });

    function updateContourUI() {
        $('#ptCount').textContent = contourPoints.length;
        $('#toStep3').disabled = contourPoints.length < 3;
        contourLayer.classList.toggle('points-limit-reached', contourPoints.length >= MAX_POINTS);
        drawPolyline();
    }
    
    function drawPolyline() {
        pointsSvg.innerHTML = '';
        if (contourPoints.length < 2) return;
        const d = contourPoints.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x} ${p.y}`).join(' ') + (contourPoints.length > 2 ? ' Z' : '');
        pointsSvg.innerHTML = `<path d="${d}" stroke="#e53e3e" stroke-width="2" fill="rgba(229, 62, 62, 0.2)" />`;
    }

    $('#clearBtn').onclick = () => {
        saveToHistory();
        contourPoints.forEach(p => p.element.remove());
        contourPoints = [];
        updateContourUI();
    };
    $('#undoBtn').onclick = restoreFromHistory;
    $('#toStep3').onclick = () => goToStep(3);

    $('#goboInput').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            projectionImage = new Image();
            projectionImage.onload = () => {
                $('#goboPreview').innerHTML = `<img src="${ev.target.result}" style="max-height:180px; max-width:100%;">`;
                $('#toStep4').disabled = false;
            };
            projectionImage.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
    $('#toStep4').onclick = () => {
        goToStep(4);
        setupDeformationStep();
    };

    function setupDeformationStep() {
        alert("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 4, –Ω–∞—á–∞–ª–æ"); // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê 1
        const bgImg = $('#bgImg2');
        canvas.width = bgImg.naturalWidth;
        canvas.height = bgImg.naturalHeight;

        $$('#edit-layer .point').forEach(p => p.remove());
        controlPoints = [];

        contourPoints.forEach((p, i) => {
            const controlPointEl = document.createElement('div');
            controlPointEl.className = 'point';
            controlPointEl.textContent = i + 1;
            controlPointEl.style.left = `${p.x}px`;
            controlPointEl.style.top = `${p.y}px`;
            $('#edit-layer').appendChild(controlPointEl);
            const cp = { x: p.x, y: p.y, element: controlPointEl };
            controlPoints.push(cp);

            let isDragging = false;
            controlPointEl.addEventListener('pointerdown', e => {
                isDragging = true;
                e.target.setPointerCapture(e.pointerId);
                e.target.style.cursor = 'grabbing';
            });
            controlPointEl.addEventListener('pointermove', e => {
                if (!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const newX = (e.clientX - rect.left) * scaleX;
                const newY = (e.clientY - rect.top) * scaleY;
                cp.x = newX;
                cp.y = newY;
                controlPointEl.style.left = `${newX / scaleX}px`;
                controlPointEl.style.top = `${newY / scaleY}px`;
                drawDeformedImage(canvas, ctx, projectionImage, controlPoints);
            });
            controlPointEl.addEventListener('pointerup', e => {
                isDragging = false;
                e.target.releasePointerCapture(e.pointerId);
                e.target.style.cursor = 'grab';
            });
        });
        
        $('#opacity').value = opacity;
        
        alert("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ"); // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê 2
        drawDeformedImage(canvas, ctx, projectionImage, controlPoints);
    }
    
    function drawDeformedImage(targetCanvas, targetCtx, img, destPoints, highQuality = false) {
        alert("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏"); // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê 3
        
        targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
        if (destPoints.length < 3 || !img.width) {
            console.error("–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞: –Ω–µ—Ç —Ç–æ—á–µ–∫ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.", "–¢–æ—á–µ–∫:", destPoints.length, "–®–∏—Ä–∏–Ω–∞ img:", img.width);
            return;
        }

        const srcPoints = [ { x: 0, y: 0 }, { x: img.width, y: 0 }, { x: img.width, y: img.height }, { x: 0, y: img.height } ];
        
        const tempDestPoints = [...destPoints];
        if (tempDestPoints.length === 4) {
             srcPoints.push({ x: img.width / 2, y: img.height / 2 });
             const destBbox = getBoundingBox(tempDestPoints);
             tempDestPoints.push({x: destBbox.cx, y: destBbox.cy });
        }

        try {
            const delaunay = Delaunator.from(tempDestPoints.map(p => [p.x, p.y]));
            const triangles = delaunay.triangles;

            targetCtx.save();
            targetCtx.globalAlpha = highQuality ? 1.0 : opacity;

            for (let i = 0; i < triangles.length; i += 3) {
                const p0_idx = triangles[i], p1_idx = triangles[i+1], p2_idx = triangles[i+2];
                const p0 = tempDestPoints[p0_idx], p1 = tempDestPoints[p1_idx], p2 = tempDestPoints[p2_idx];
                const s0 = srcPoints[p0_idx], s1 = srcPoints[p1_idx], s2 = srcPoints[p2_idx];

                if (!p0 || !p1 || !p2 || !s0 || !s1 || !s2) continue;
                
                targetCtx.save();
                targetCtx.beginPath();
                targetCtx.moveTo(p0.x, p0.y); targetCtx.lineTo(p1.x, p1.y); targetCtx.lineTo(p2.x, p2.y);
                targetCtx.closePath();
                targetCtx.clip();

                const delta = s1.x * s2.y + s0.x * s1.y + s2.x * s0.y - s1.x * s0.y - s2.x * s1.y - s0.x * s2.y;
                if (Math.abs(delta) < 1e-9) { targetCtx.restore(); continue; }

                const A = (p1.x * s2.y + p0.x * s1.y + p2.x * s0.y - p1.x * s0.y - p2.x * s1.y - p0.x * s2.y) / delta;
                const B = (p1.y * s2.y + p0.y * s1.y + p2.y * s0.y - p1.y * s0.y - p2.y * s1.y - p0.y * s2.y) / delta;
                const C = (p1.x * s0.x + p0.x * s2.x + p2.x * s1.x - p1.x * s2.x - p2.x * s0.x - p0.x * s1.x) / delta;
                const D = (p1.y * s0.x + p0.y * s2.x + p2.y * s1.x - p1.y * s2.x - p2.y * s0.x - p0.y * s1.x) / delta;
                const E = (p1.x * (s2.x * s0.y - s0.x * s2.y) + p0.x * (s1.x * s2.y - s2.x * s1.y) + p2.x * (s0.x * s1.y - s1.x * s0.y)) / delta;
                const F = (p1.y * (s2.x * s0.y - s0.x * s2.y) + p0.y * (s1.x * s2.y - s2.x * s1.y) + p2.y * (s0.x * s1.y - s1.x * s0.y)) / delta;

                targetCtx.transform(A, B, C, D, E, F);
                targetCtx.drawImage(img, 0, 0);
                targetCtx.restore();
            }
            targetCtx.restore();
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∏–∞–Ω–≥—É–ª—è—Ü–∏–∏ –∏–ª–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏:", e);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—ã–≤–µ–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12).");
        }
    }

    function getBoundingBox(points) {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        points.forEach(p => {
            minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
            maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
        });
        return { cx: minX + (maxX - minX) / 2, cy: minY + (maxY - minY) / 2 };
    }

    $('#opacity').oninput = e => { opacity = +e.target.value; drawDeformedImage(canvas, ctx, projectionImage, controlPoints); };
    $('#toggleVis').onclick = () => {
        const isVisible = canvas.style.visibility !== 'hidden';
        canvas.style.visibility = isVisible ? 'hidden' : 'visible';
        $('#toggleVis').textContent = isVisible ? 'üëÅ –ü–æ–∫–∞–∑–∞—Ç—å' : 'üëÅ –°–∫—Ä—ã—Ç—å';
    };
    $('#toStep5').onclick = () => { generatePreview(); goToStep(5); };
    $('#saveBtn').onclick = saveProject;
    $('#loadBtn').onclick = loadProject;

    function saveToHistory() { historyStack.push(JSON.stringify(contourPoints.map(p => ({ x: p.x, y: p.y })))); }
    function restoreFromHistory() {
        if (historyStack.length === 0) return;
        const lastState = JSON.parse(historyStack.pop());
        contourPoints.forEach(p => p.element.remove());
        contourPoints = [];
        lastState.forEach((p, i) => {
            const pointEl = document.createElement('div');
            pointEl.className = 'point';
            pointEl.textContent = i + 1;
            pointEl.style.left = `${p.x}px`; pointEl.style.top = `${p.y}px`;
            contourLayer.appendChild(pointEl);
            contourPoints.push({ x: p.x, y: p.y, element: pointEl });
        });
        updateContourUI();
    }

    function saveProject() { /* ... –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ... */ }
    function loadProject() { /* ... –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ ... */ }
    
    const presetSelect = $('#preset');
    presetSelect.onchange = generatePreview;

    function generatePreview() { /* ... –∫–æ–¥ –ø—Ä–µ–≤—å—é ... */ }
    $('#exportPng').onclick = () => exportFinalImage('png');
    $('#exportTif').onclick = () => exportFinalImage('tiff');
    function exportFinalImage(format) { /* ... –∫–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞ ... */ }

});
</script>

</body>
</html>
