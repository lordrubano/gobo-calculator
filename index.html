<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOBO –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-—Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
    
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-to-tiff@1.1.1/dist/canvas-to-tiff.min.js"></script>
    
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        
        /* –®–∞–ø–∫–∞ */
        .header { background: rgba(255, 255, 255, 0.98); padding: 20px 30px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header h1 { color: #5a67d8; margin-bottom: 10px; }
        .header p { color: #555; font-size: 16px; max-width: 600px; margin: 0 auto; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .progress-bar { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; }
        .progress-step { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s ease; border: 2px solid transparent; }
        .progress-step.active { background: #48bb78; transform: scale(1.1); box-shadow: 0 0 15px rgba(72, 187, 120, 0.5); border-color: rgba(255,255,255,0.5); }
        .progress-step.completed { background: #38a169; }
        
        /* –û–∫–Ω–∞ —à–∞–≥–æ–≤ */
        .step-content { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); margin-bottom: 20px; display: none; }
        .step-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-content h2 { color: #5a67d8; margin-bottom: 10px; font-size: 26px; }
        .step-content > p { color: #666; margin-bottom: 25px; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: all 0.2s ease; background: #f7fafc; }
        .form-group input:focus { outline: none; border-color: #5a67d8; background: #fff; box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.2); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ */
        .photo-upload-area { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 40px; text-align: center; background: #f7fafc; transition: all 0.3s ease; cursor: pointer; }
        .photo-upload-area:hover { border-color: #5a67d8; background: #edf2f7; }
        #photo-container { position: relative; display: inline-block; margin: 20px 0; user-select: none; }
        #step3-photo { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .assigned-point { position: absolute; width: 14px; height: 14px; background: #e53e3e; color: white; border-radius: 50%; text-align: center; line-height: 14px; font-size: 9px; font-weight: bold; cursor: pointer; z-index: 10; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s ease; user-select: none; transform: translate(-50%, -50%); }
        .assigned-point:hover { transform: translate(-50%, -50%) scale(1.2); }
        #lines-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .points-info { background: #e6fffa; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #38b2ac; }
        .clear-points-btn { background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 0 15px 0 0; }
        .image-upload-input { display: block; margin: 20px 0; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (–®–∞–≥ 5) */
        .deformation-stage-wrapper { text-align: center; }
        .deformation-stage { position: relative; margin: 20px auto; border: 2px solid #e2e8f0; border-radius: 10px; overflow: hidden; display: inline-block; background-color: #eee; }
        #deformation-canvas { display: block; max-width: 100%; height: auto; }
        .control-point { position: absolute; width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; background: #e53e3e; cursor: grab; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.3); touch-action: none; transform: translate(-50%, -50%); }
        .control-point:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); background: #c53030; }
        .controls-panel { background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center; border: 1px solid #e2e8f0; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .control-group input[type="range"] { width: 100%; }
        .pan-controls button { width: 40px; height: 40px; font-size: 20px; line-height: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer;}
        .pan-controls button:hover { background: #eee; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .step-navigation { display: flex; justify-content: space-between; margin-top: 30px; }
        .step-navigation button { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .step-navigation button:first-child { background: #718096; color: white; }
        .step-navigation button:last-child { background: #48bb78; color: white; }
        .step-navigation button:disabled { background: #cbd5e0; color: #a0aec0; cursor: not-allowed; }
        
        /* –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç */
        #finalResult { text-align: center; padding: 10px; background: #f7fafc; border-radius: 10px; border: 1px solid #e2e8f0; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #result-canvas { max-width: 100%; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); background: black; }
    </style>
</head>
<body>

    <div class="header">
        <h1>GOBO –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-—Ä–µ–¥–∞–∫—Ç–æ—Ä</h1>
        <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥—ã—Å–∫–∞–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≥–æ–±–æ-–ø—Ä–æ–µ–∫—Ü–∏–∏.</p>
    </div>

    <div class="container">
        <div class="progress-bar">
            <div class="progress-step active" id="progress1">1</div>
            <div class="progress-step" id="progress2">2</div>
            <div class="progress-step" id="progress3">3</div>
            <div class="progress-step" id="progress4">4</div>
            <div class="progress-step" id="progress5">5</div>
            <div class="progress-step" id="progress6">6</div>
        </div>

        <div class="step-content active" id="step1">
            <h2>–®–∞–≥ 1: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ü–∏–∏ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)</h2>
            <p>–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –∏–ª–∏ –±—É–¥—É—â–∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤.</p>
            <div class="form-row">
                <div class="form-group"><label>–®–∏—Ä–∏–Ω–∞ –ø—Ä–æ–µ–∫—Ü–∏–∏ (–º–º):</label><input type="number" id="projectionWidth" value="2000"></div>
                <div class="form-group"><label>–í—ã—Å–æ—Ç–∞ –ø—Ä–æ–µ–∫—Ü–∏–∏ (–º–º):</label><input type="number" id="projectionHeight" value="1500"></div>
            </div>
             <div class="step-navigation">
                <button disabled>–ù–∞–∑–∞–¥</button>
                <button onclick="showStep(2)">–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step-content" id="step2">
            <h2>–®–∞–≥ 2: –≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —Å–¥–µ–ª–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é ¬´–£–º–Ω–æ–π –ù–∞—Å–∞–¥–∫–∏¬ª –∏–∑ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞.</p>
            <div class="photo-upload-area" id="photoUploadArea">
                <div id="uploadPrompt"><h3>üì∏ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3></div>
                <div id="photoPreview" style="display: none;"><img id="uploadedPhoto" style="max-width: 100%; height: auto; border-radius: 10px;"></div>
                <input type="file" id="photoInput" accept="image/*" style="display: none;">
            </div>
            <div class="step-navigation">
                <button onclick="showStep(1)">–ù–∞–∑–∞–¥</button>
                <button onclick="showStep(3)" id="step2Next" disabled>–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step-content" id="step3">
            <h2>–®–∞–≥ 3: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2>
            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –µ–≥–æ. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.</p>
            <div class="points-info">
                <button class="clear-points-btn" onclick="clearAllPoints()">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ—á–∫–∏</button>
                <span>–¢–æ—á–µ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ: <strong id="pointCounter">0</strong></span>
            </div>
            <div id="photo-container">
                <img id="step3-photo" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç—É—Ä–∞">
                <svg id="lines-svg"></svg>
            </div>
            <div class="step-navigation">
                <button onclick="showStep(2)">–ù–∞–∑–∞–¥</button>
                <button onclick="showStep(4)" id="step3Next" disabled>–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step-content" id="step4">
            <h2>–®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≥–æ–±–æ</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–æ—Ç–∏–ø –∏–ª–∏ –∑–Ω–∞–∫), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–æ–µ—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è. –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ–Ω–æ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ–≤–µ—Ä—Ö –≤–∞—à–µ–≥–æ —Ñ–æ—Ç–æ.</p>
            <input type="file" id="step4-image-input" class="image-upload-input" accept="image/*">
            <div id="step4-image-preview" style="min-height: 200px; border: 2px dashed #cbd5e0; padding: 20px; text-align: center; background: #f9f9f9; border-radius: 10px; margin: 20px 0;">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
            </div>
            <div class="step-navigation">
                <button onclick="showStep(3)">–ù–∞–∑–∞–¥</button>
                <button onclick="showStep(5)" id="step4Next" disabled>–î–∞–ª–µ–µ</button>
            </div>
        </div>
        
        <div class="step-content" id="step5">
            <h2>–®–∞–≥ 5: –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <p>–°–Ω–∞—á–∞–ª–∞ —Å–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–º–µ—â–µ–Ω–∏—è —Å –∫–æ–Ω—Ç—É—Ä–æ–º.</p>
            <div class="deformation-stage-wrapper">
                <div class="deformation-stage" id="deformationStage">
                    <canvas id="deformation-canvas"></canvas>
                </div>
            </div>
            <div class="controls-panel">
                <div class="control-group">
                    <label for="opacitySlider">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacityValue">100</span>%</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100">
                </div>
                <div class="control-group">
                    <label for="scaleSlider">–ú–∞—Å—à—Ç–∞–±: <span id="scaleValue">100</span>%</label>
                    <input type="range" id="scaleSlider" min="50" max="150" value="100">
                </div>
                <div class="control-group">
                    <label for="rotationSlider">–í—Ä–∞—â–µ–Ω–∏–µ: <span id="rotationValue">0</span>¬∞</label>
                    <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                </div>
                <div class="control-group pan-controls">
                    <label>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label>
                    <div>
                        <button onclick="panImage(0, -5)">‚Üë</button>
                        <button onclick="panImage(0, 5)">‚Üì</button>
                        <button onclick="panImage(-5, 0)">‚Üê</button>
                        <button onclick="panImage(5, 0)">‚Üí</button>
                    </div>
                </div>
            </div>
            <div class="step-navigation">
                <button onclick="showStep(4)">–ù–∞–∑–∞–¥</button>
                <button onclick="showStep(6)">–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step-content" id="step6">
            <h2>–®–∞–≥ 6: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2>
            <p>–§–∏–Ω–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –≥–æ–±–æ-—Å–ª–∞–π–¥–∞, –≥–æ—Ç–æ–≤—ã–π –∫ –ø–µ—á–∞—Ç–∏. –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .TIFF.</p>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group"><label for="printDPI">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (DPI):</label><input type="number" id="printDPI" value="2700"></div>
                <div class="form-group"><label for="slideDiameter">–î–∏–∞–º–µ—Ç—Ä —Å–ª–∞–π–¥–∞ (–º–º):</label><input type="number" id="slideDiameter" value="37.5"></div>
                <div class="form-group"><label for="printDiameter">–î–∏–∞–º–µ—Ç—Ä –ø–µ—á–∞—Ç–∏ (–º–º):</label><input type="number" id="printDiameter" value="32"></div>
                <div class="form-group"><label for="alignMark">–ú–µ—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label><input type="text" id="alignMark" value="PLT"></div>
            </div>
            <div id="finalResult">
                <canvas id="result-canvas"></canvas>
            </div>
            <div class="step-navigation">
                <button onclick="showStep(5)">–ù–∞–∑–∞–¥</button>
                <button onclick="exportFinalGobo()">–°–∫–∞—á–∞—Ç—å .TIFF</button>
            </div>
        </div>

    </div>

<script>
// ===================================================================
// == –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==
// ===================================================================
let currentStep = 1;
let assignedPoints = [];      // –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫, –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –Ω–∞ –®–∞–≥–µ 3. –§–æ—Ä–º–∞—Ç: {x, y, element}
let photoData = null;           // –î–∞–Ω–Ω—ã–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Base64
let userImageElement = null;    // HTML —ç–ª–µ–º–µ–Ω—Ç <img> –¥–ª—è –≥–æ–±–æ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
let controlPointElements = [];  // –ú–∞—Å—Å–∏–≤ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫—Ä–∞—Å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤

// –û–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–∞ –®–∞–≥–µ 5
let transformState = {
    x: 0, y: 0,         // –ü–æ–∑–∏—Ü–∏—è –≥–æ–±–æ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    scale: 1,           // –ú–∞—Å—à—Ç–∞–±
    rotation: 0,        // –í—Ä–∞—â–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    opacity: 1,         // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
    initialScale: 1     // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –º–∞—Å—à—Ç–∞–±
};
// –ú–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –≤–µ—Ä—à–∏–Ω –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
let deformationDestPoints = []; 
let activeControlPoint = null;

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', initCalculator);

function initCalculator() {
    setupStep2Listeners();
    setupStep4Listeners();
}


// ===================================================================
// == –û–°–ù–û–í–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø –ú–ï–ñ–î–£ –®–ê–ì–ê–ú–ò ==
// ===================================================================
function showStep(stepNumber) {
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`step${i}`).classList.remove('active');
        const progress = document.getElementById(`progress${i}`);
        progress.classList.remove('active', 'completed');
        if (i < stepNumber) {
            progress.classList.add('completed');
        }
    }

    document.getElementById(`step${stepNumber}`).classList.add('active');
    document.getElementById(`progress${stepNumber}`).classList.add('active');
    currentStep = stepNumber;

    if (stepNumber === 3) setupStep3();
    if (stepNumber === 5) initStep5();
    if (stepNumber === 6) generateFinalResultPreview();
}


// ===================================================================
// == –õ–û–ì–ò–ö–ê –®–ê–ì–ê 2: –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û –û–ë–™–ï–ö–¢–ê ==
// ===================================================================
function setupStep2Listeners() {
    const uploadArea = document.getElementById('photoUploadArea');
    const fileInput = document.getElementById('photoInput');
    uploadArea.addEventListener('click', () => fileInput.click());
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (eventName === 'dragover') uploadArea.classList.add('dragover');
            if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('dragover');
            if (eventName === 'drop') handlePhotoFile(e.dataTransfer.files[0]);
        });
    });
    fileInput.addEventListener('change', (e) => handlePhotoFile(e.target.files[0]));
}

function handlePhotoFile(file) {
    if (!file || !file.type.startsWith('image/')) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
        photoData = e.target.result;
        document.getElementById('uploadedPhoto').src = photoData;
        document.getElementById('uploadPrompt').style.display = 'none';
        document.getElementById('photoPreview').style.display = 'block';
        document.getElementById('step2Next').disabled = false;
    };
    reader.readAsDataURL(file);
}


// ===================================================================
// == –õ–û–ì–ò–ö–ê –®–ê–ì–ê 3: –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –¢–û–ß–ï–ö –ö–û–ù–¢–£–†–ê ==
// ===================================================================
function setupStep3() {
    if (!photoData) { showStep(2); return; }
    const step3Photo = document.getElementById('step3-photo');
    step3Photo.src = photoData;
    step3Photo.onload = () => {
        clearAllPoints();
        step3Photo.removeEventListener('click', handlePhotoClick);
        step3Photo.addEventListener('click', handlePhotoClick);
    }
}

function handlePhotoClick(event) {
    const photoElement = event.target;
    const rect = photoElement.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    const pointEl = document.createElement('div');
    pointEl.className = 'assigned-point';
    pointEl.textContent = assignedPoints.length + 1;
    pointEl.style.left = `${x}px`;
    pointEl.style.top = `${y}px`;

    photoElement.parentElement.appendChild(pointEl);
    assignedPoints.push({ x, y, element: pointEl });
    updatePointCounterAndLines();
}

function clearAllPoints() {
    assignedPoints.forEach(p => p.element.remove());
    assignedPoints = [];
    document.getElementById('lines-svg').innerHTML = '';
    updatePointCounterAndLines();
}

function updatePointCounterAndLines() {
    document.getElementById('pointCounter').textContent = assignedPoints.length;
    document.getElementById('step3Next').disabled = assignedPoints.length < 3;
    drawConnectingLines();
}

function drawConnectingLines() {
    const svg = document.getElementById('lines-svg');
    const photo = document.getElementById('step3-photo');
    svg.innerHTML = '';
    svg.setAttribute('viewBox', `0 0 ${photo.offsetWidth} ${photo.offsetHeight}`);
    if (assignedPoints.length < 2) return;
    const pathData = assignedPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
    const closingPath = assignedPoints.length > 2 ? ' Z' : '';
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData + closingPath);
    path.setAttribute('stroke', '#ff69b4');
    path.setAttribute('stroke-width', '2');
    path.setAttribute('fill', 'rgba(255, 105, 180, 0.2)');
    path.setAttribute('stroke-dasharray', '5,5');
    svg.appendChild(path);
}


// ===================================================================
// == –õ–û–ì–ò–ö–ê –®–ê–ì–ê 4: –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ì–û–ë–û –° –£–õ–£–ß–®–ï–ù–ù–´–ú –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–û–ú ==
// ===================================================================
function setupStep4Listeners() {
    document.getElementById('step4-image-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            userImageElement = new Image();
            userImageElement.src = e.target.result;
            userImageElement.onload = () => {
                const previewContainer = document.getElementById('step4-image-preview');
                previewContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º
                
                const previewCanvas = document.createElement('canvas');
                const pCtx = previewCanvas.getContext('2d');
                previewCanvas.style.maxWidth = '100%';
                previewCanvas.style.height = 'auto';
                previewContainer.appendChild(previewCanvas);
                
                const bgPhotoImg = document.getElementById('step3-photo');
                previewCanvas.width = bgPhotoImg.naturalWidth;
                previewCanvas.height = bgPhotoImg.naturalHeight;
                
                pCtx.globalAlpha = 0.6;
                pCtx.drawImage(bgPhotoImg, 0, 0);
                pCtx.globalAlpha = 1.0;
                
                const scale = Math.min(previewCanvas.width / userImageElement.width, previewCanvas.height / userImageElement.height) * 0.5;
                const w = userImageElement.width * scale;
                const h = userImageElement.height * scale;
                pCtx.drawImage(userImageElement, (previewCanvas.width - w) / 2, (previewCanvas.height - h) / 2, w, h);

                document.getElementById('step4Next').disabled = false;
            };
        };
        reader.readAsDataURL(file);
    });
}


// ===================================================================
// == –õ–û–ì–ò–ö–ê –®–ê–ì–ê 5: –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –†–ï–î–ê–ö–¢–û–† ==
// ===================================================================
function initStep5() {
    if (!userImageElement || !userImageElement.complete || assignedPoints.length < 3) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –æ–±–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –æ—Ç–º–µ—á–µ–Ω—ã –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏ –Ω–∞ –∫–æ–Ω—Ç—É—Ä–µ.");
        showStep(4);
        return;
    }

    const canvas = document.getElementById('deformation-canvas');
    const stage = document.getElementById('deformationStage');
    const bgPhoto = document.getElementById('step3-photo');

    canvas.width = bgPhoto.offsetWidth;
    canvas.height = bgPhoto.offsetHeight;

    calculateInitialTransform();
    setupControlPoints(stage);
    setupStep5Controls();
    drawTransformedImage();
}

function calculateInitialTransform() {
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    assignedPoints.forEach(p => {
        minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
        maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
    });
    const contourWidth = maxX - minX;
    const contourHeight = maxY - minY;
    const contourCenterX = minX + contourWidth / 2;
    const contourCenterY = minY + contourHeight / 2;

    const targetSize = Math.max(contourWidth, contourHeight) * 1.2;
    const imgMaxDim = Math.max(userImageElement.naturalWidth, userImageElement.naturalHeight);
    
    transformState.initialScale = targetSize / imgMaxDim;
    transformState.scale = transformState.initialScale;
    transformState.x = contourCenterX;
    transformState.y = contourCenterY;
    transformState.rotation = 0;
    transformState.opacity = 1;
}
    
function setupControlPoints(stage) {
    controlPointElements.forEach(p => p.remove());
    controlPointElements = [];
    deformationDestPoints = [];

    assignedPoints.forEach((p, i) => {
        const point = { x: p.x, y: p.y };
        deformationDestPoints.push(point);
        const pointElement = document.createElement('div');
        pointElement.className = 'control-point';
        pointElement.dataset.index = i;
        pointElement.style.left = `${point.x}px`;
        pointElement.style.top = `${point.y}px`;
        stage.appendChild(pointElement);
        controlPointElements.push(pointElement);
        pointElement.addEventListener('mousedown', (e) => { e.preventDefault(); activeControlPoint = { index: i, element: pointElement }; });
    });

    document.removeEventListener('mousemove', handleDrag);
    document.removeEventListener('mouseup', stopDrag);
    document.addEventListener('mousemove', handleDrag);
    document.addEventListener('mouseup', stopDrag);
}
    
function setupStep5Controls() {
    const sliders = { opacity: 100, scale: 100, rotation: 0 };
    for (const type in sliders) {
        const slider = document.getElementById(`${type}Slider`);
        const valueEl = document.getElementById(`${type}Value`);
        if(type === 'scale') slider.value = 100;
        else if (type === 'rotation') slider.value = 0;
        else slider.value = 100;
        valueEl.textContent = slider.value;
        slider.oninput = () => {
            valueEl.textContent = slider.value;
            if (type === 'opacity') transformState.opacity = slider.value / 100;
            if (type === 'rotation') transformState.rotation = parseInt(slider.value);
            if (type === 'scale') transformState.scale = transformState.initialScale * (slider.value / 100);
            drawTransformedImage();
        };
    }
}

window.panImage = (dx, dy) => { transformState.x += dx; transformState.y += dy; drawTransformedImage(); };
function handleDrag(e) {
    if (!activeControlPoint) return;
    const stageRect = document.getElementById('deformationStage').getBoundingClientRect();
    const x = e.clientX - stageRect.left;
    const y = e.clientY - stageRect.top;
    activeControlPoint.element.style.left = `${x}px`;
    activeControlPoint.element.style.top = `${y}px`;
    deformationDestPoints[activeControlPoint.index] = { x, y };
    drawTransformedImage();
}
function stopDrag() { activeControlPoint = null; }

function drawTransformedImage() {
    const canvas = document.getElementById('deformation-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const bgPhotoImg = document.getElementById('step3-photo');
    ctx.drawImage(bgPhotoImg, 0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.globalAlpha = transformState.opacity;
    ctx.translate(transformState.x, transformState.y);
    ctx.rotate(transformState.rotation * Math.PI / 180);
    ctx.scale(transformState.scale, transformState.scale);
    const imgW = userImageElement.naturalWidth;
    const imgH = userImageElement.naturalHeight;
    ctx.translate(-imgW / 2, -imgH / 2);
    let sourcePoints = [];
    const numPoints = deformationDestPoints.length;
    for(let i=0; i<numPoints; i++) {
        const angle = (i / numPoints) * 2 * Math.PI - (Math.PI / 2);
        sourcePoints.push({
            x: imgW / 2 + (imgW / 2) * Math.cos(angle),
            y: imgH / 2 + (imgH / 2) * Math.sin(angle)
        });
    }
    let localDestPoints = deformationDestPoints.map(p => {
        const dx = p.x - transformState.x;
        const dy = p.y - transformState.y;
        const angle = -transformState.rotation * Math.PI / 180;
        const s = transformState.scale;
        return {
            x: (dx * Math.cos(angle) - dy * Math.sin(angle)) / s + imgW/2,
            y: (dx * Math.sin(angle) + dy * Math.cos(angle)) / s + imgH/2,
        };
    });
    const delaunay = Delaunator.from(localDestPoints.map(p => [p.x, p.y]));
    for (let i = 0; i < delaunay.triangles.length; i += 3) {
        const t = [delaunay.triangles[i], delaunay.triangles[i+1], delaunay.triangles[i+2]];
        const src = t.map(p => sourcePoints[p]);
        const dst = t.map(p => localDestPoints[p]);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(dst[0].x, dst[0].y); ctx.lineTo(dst[1].x, dst[1].y); ctx.lineTo(dst[2].x, dst[2].y);
        ctx.closePath();
        ctx.clip();
        const det = src[0].x * (src[1].y - src[2].y) + src[1].x * (src[2].y - src[0].y) + src[2].x * (src[0].y - src[1].y);
        if (Math.abs(det) < 1e-9) { ctx.restore(); continue; }
        const a = (dst[0].x * (src[1].y - src[2].y) + dst[1].x * (src[2].y - src[0].y) + dst[2].x * (src[0].y - src[1].y)) / det;
        const b = (dst[0].y * (src[1].y - src[2].y) + dst[1].y * (src[2].y - src[0].y) + dst[2].y * (src[0].y - src[1].y)) / det;
        const c = (dst[0].x * (src[2].x - src[1].x) + dst[1].x * (src[0].x - src[2].x) + dst[2].x * (src[1].x - src[0].x)) / det;
        const d = (dst[0].y * (src[2].x - src[1].x) + dst[1].y * (src[0].x - src[2].x) + dst[2].y * (src[1].x - src[0].x)) / det;
        const e = dst[0].x - a * src[0].x - c * src[0].y;
        const f = dst[0].y - b * src[0].x - d * src[0].y;
        ctx.transform(a, b, c, d, e, f);
        ctx.drawImage(userImageElement, 0, 0);
        ctx.restore();
    }
    ctx.restore();
}

// ===================================================================
// == –õ–û–ì–ò–ö–ê –®–ê–ì–ê 6: –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ò –≠–ö–°–ü–û–†–¢ –í TIFF ==
// ===================================================================
function generateFinalResultPreview() {
    const previewCanvas = document.getElementById('result-canvas');
    const pCtx = previewCanvas.getContext('2d');
    const previewSize = Math.min(previewCanvas.parentElement.clientWidth, 400);
    previewCanvas.width = previewSize;
    previewCanvas.height = previewSize;

    const slideDiameter = parseFloat(document.getElementById('slideDiameter').value) || 37.5;
    const printDiameter = parseFloat(document.getElementById('printDiameter').value) || 32;
    const printRadiusRatio = printDiameter / slideDiameter;

    // –†–∏—Å—É–µ–º –º–∞–∫–µ—Ç —Å–ª–∞–π–¥–∞
    pCtx.fillStyle = 'black';
    pCtx.beginPath();
    pCtx.arc(previewSize / 2, previewSize / 2, previewSize / 2, 0, 2 * Math.PI);
    pCtx.fill();
    pCtx.fillStyle = '#1a1a1a'; // –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
    pCtx.beginPath();
    pCtx.arc(previewSize / 2, previewSize / 2, (previewSize / 2) * printRadiusRatio, 0, 2 * Math.PI);
    pCtx.fill();

    const cleanImage = getCleanDistortedImage();
    if (!cleanImage) return;

    // –í–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–∫–∞–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–µ—á–∞—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    const fitSize = previewSize * printRadiusRatio;
    const scale = fitSize / Math.max(cleanImage.width, cleanImage.height);
    const w = cleanImage.width * scale;
    const h = cleanImage.height * scale;
    pCtx.drawImage(cleanImage, (previewSize - w) / 2, (previewSize - h) / 2, w, h);
}

function exportFinalGobo() {
    const DPI = parseInt(document.getElementById('printDPI').value);
    const slideMM = parseFloat(document.getElementById('slideDiameter').value);
    const printMM = parseFloat(document.getElementById('printDiameter').value);
    const markText = document.getElementById('alignMark').value;

    if (!DPI || !slideMM || !printMM) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏."); return; }

    const slidePX = (slideMM / 25.4) * DPI;
    const printPX = (printMM / 25.4) * DPI;

    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = Math.round(slidePX);
    finalCanvas.height = Math.round(slidePX);
    const ctx = finalCanvas.getContext('2d');
    const centerX = finalCanvas.width / 2;
    const centerY = finalCanvas.height / 2;
    
    // –†–∏—Å—É–µ–º —á–µ—Ä–Ω—É—é –º–∞—Å–∫—É
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(centerX, centerY, printPX / 2, 0, 2 * Math.PI);
    ctx.fill();

    // –ü–æ–ª—É—á–∞–µ–º "—á–∏—Å—Ç–æ–µ" –∏—Å–∫–∞–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const cleanDistortedImage = getCleanDistortedImage();
    if (!cleanDistortedImage) { alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞."); return; }
    
    // –í–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –≤ –ø–µ—á–∞—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    const scaleToFit = printPX / Math.max(cleanDistortedImage.width, cleanDistortedImage.height);
    const w = cleanDistortedImage.width * scaleToFit;
    const h = cleanDistortedImage.height * scaleToFit;
    ctx.drawImage(cleanDistortedImage, centerX - w / 2, centerY - h / 2, w, h);

    // –†–∏—Å—É–µ–º –º–µ—Ç–∫—É –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if (markText) {
        ctx.fillStyle = 'white';
        ctx.font = `bold ${Math.round(printPX * 0.04)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const markRadius = (printPX / 2) + ((slidePX - printPX) / 4);
        ctx.fillText(markText, centerX, centerY + markRadius);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ TIFF —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    CanvasToTIFF.toTiff(finalCanvas, { dpi: DPI, compression: 'lzw' });
}

// –§–∏–Ω–∞–ª—å–Ω–∞—è, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å—Ç–æ–≥–æ –∏—Å–∫–∞–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function getCleanDistortedImage() {
    if (!userImageElement || !userImageElement.complete) return null;
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const deformationCanvas = document.getElementById('deformation-canvas');
    canvas.width = deformationCanvas.width;
    canvas.height = deformationCanvas.height;

    ctx.save();
    ctx.translate(transformState.x, transformState.y);
    ctx.rotate(transformState.rotation * Math.PI / 180);
    ctx.scale(transformState.scale, transformState.scale);
    
    const imgW = userImageElement.naturalWidth;
    const imgH = userImageElement.naturalHeight;
    ctx.translate(-imgW / 2, -imgH / 2);
    
    let sourcePoints = [];
    const numPoints = deformationDestPoints.length;
    for(let i=0; i<numPoints; i++) {
        const angle = (i / numPoints) * 2 * Math.PI - (Math.PI / 2);
        sourcePoints.push({ x: imgW / 2 + (imgW / 2) * Math.cos(angle), y: imgH / 2 + (imgH / 2) * Math.sin(angle) });
    }
    
    let localDestPoints = deformationDestPoints.map(p => {
        const dx = p.x - transformState.x;
        const dy = p.y - transformState.y;
        const angle = -transformState.rotation * Math.PI / 180;
        const s = transformState.scale;
        return { x: (dx * Math.cos(angle) - dy * Math.sin(angle)) / s + imgW/2, y: (dx * Math.sin(angle) + dy * Math.cos(angle)) / s + imgH/2 };
    });

    const delaunay = Delaunator.from(localDestPoints.map(p => [p.x, p.y]));
    
    for (let i = 0; i < delaunay.triangles.length; i += 3) {
        const t = [delaunay.triangles[i], delaunay.triangles[i+1], delaunay.triangles[i+2]];
        const src = t.map(p => sourcePoints[p]);
        const dst = t.map(p => localDestPoints[p]);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(dst[0].x, dst[0].y); ctx.lineTo(dst[1].x, dst[1].y); ctx.lineTo(dst[2].x, dst[2].y);
        ctx.closePath();
        ctx.clip();
        const det = src[0].x * (src[1].y - src[2].y) + src[1].x * (src[2].y - src[0].y) + src[2].x * (src[0].y - src[1].y);
        if (Math.abs(det) < 1e-9) { ctx.restore(); continue; }
        const a = (dst[0].x * (src[1].y - src[2].y) + dst[1].x * (src[2].y - src[0].y) + dst[2].x * (src[0].y - src[1].y)) / det;
        const b = (dst[0].y * (src[1].y - src[2].y) + dst[1].y * (src[2].y - src[0].y) + dst[2].y * (src[0].y - src[1].y)) / det;
        const c = (dst[0].x * (src[2].x - src[1].x) + dst[1].x * (src[0].x - src[2].x) + dst[2].x * (src[1].x - src[0].x)) / det;
        const d = (dst[0].y * (src[2].x - src[1].x) + dst[1].y * (src[0].x - src[2].x) + dst[2].y * (src[1].x - src[0].x)) / det;
        const e = dst[0].x - a * src[0].x - c * src[0].y;
        const f = dst[0].y - b * src[0].x - d * src[0].y;
        ctx.transform(a, b, c, d, e, f);
        ctx.drawImage(userImageElement, 0, 0);
        ctx.restore();
    }
    ctx.restore();
    return canvas;
}

</script>
</body>
</html>
