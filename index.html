<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-–†–µ–¥–∞–∫—Ç–æ—Ä 2.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5a67d8">
    <style>
        html, body { margin: 0; padding: 0; font-family: sans-serif; background: #f0f2f6; color: #333; }
        h1, h2, h3 { text-align: center; margin: 10px 0; color: #2d3748; }
        #app { max-width: 960px; margin: 20px auto; padding: 16px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
   .step { display: none; padding: 24px; border-radius: 12px; }
   .step.active { display: block; }
   .progress { display: flex; justify-content: space-between; margin: 16px 0 24px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
   .progress div { flex: 1; text-align: center; font-weight: 700; color: #a0aec0; position: relative; padding: 5px; cursor: default; }
   .progress div::before { content: attr(data-n); display: block; width: 32px; height: 32px; margin: 0 auto 8px; border-radius: 50%; line-height: 32px; border: 2px solid currentColor; background: #fff; }
   .progress div.active { color: #5a67d8; }
   .progress div.done::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        
        #photoZone { border: 3px dashed #cbd5e0; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; background: #f7fafc; margin-bottom: 16px; }
        #photoZone.dragover { background: #edf2f7; border-color: #5a67d8; }
        
   .image-container { position: relative; display: inline-block; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; max-width: 100%; margin: 0 auto; display: block; }
        #bgImg, #bgImgDeform { display: block; max-width: 100%; max-height: 60vh; border-radius: 9px; margin: 0 auto;}
        #deformation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #svgOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
   .point-marker { position: absolute; width: 14px; height: 14px; background: #e53e3e; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); font-size: 9px; line-height: 10px; text-align: center; color: #fff; font-weight: 700; user-select: none; cursor: grab; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 10; } /* –î–æ–±–∞–≤–ª–µ–Ω z-index */
   .point-marker:active { cursor: grabbing; }

   .controls,.export-controls { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
   .controls label,.export-controls label { font-size: 14px; display: flex; flex-direction: column; gap: 4px; }
   .controls input[type="range"] { width: 150px; }
   .controls input[type="number"] { width: 60px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
        
        button { padding: 10px 15px; background-color: #5a67d8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        button:hover { background-color: #434190; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        /* input[type="file"] —Ç–µ–ø–µ—Ä—å —Å–∫—Ä—ã—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è photoZone */
        #goboPreview { min-height: 100px; border: 2px dashed #cbd5e0; margin: 12px 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: #f7fafc; }
        #goboPreview img { max-height: 180px; max-width: 100%; }
   .hidden { display: none; }
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; }
   .introjs-tooltip { font-family: sans-serif; } 
    </style>
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.1/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/transformation-matrix-js@2.7.6/matrix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-to-tiff@1.0.0/canvasToTIFF.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-–†–µ–¥–∞–∫—Ç–æ—Ä 2.1</h1>
        <div class="progress">
            <div id="pStep1" data-n="1" class="active">1. –§–æ—Ç–æ</div>
            <div id="pStep2" data-n="2">2. –ö–æ–Ω—Ç—É—Ä</div>
            <div id="pStep3" data-n="3">3. –ì–æ–±–æ</div>
            <div id="pStep4" data-n="4">4. –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div id="pStep5" data-n="5">5. –≠–∫—Å–ø–æ—Ä—Ç</div>
        </div>

        <section id="step1" class="step active">
            <h2>–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ</h2>
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –æ–±—ä–µ–∫—Ç–∞ (—Å —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–º –∏–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º) –≤ –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.</p>
            <div id="photoZone">üì∑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <input id="photoInput" type="file" accept="image/*" class="hidden">
            <button id="setupAppFiles" style="margin-top: 15px; background-color: #f0ad4e;">–°–∫–∞—á–∞—Ç—å manifest.json –∏ sw.js (–¥–ª—è GitHub Pages)</button>
        </section>

        <section id="step2" class="step">
            <h2>–®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2>
            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–º–∏–Ω–∏–º—É–º 3, –º–∞–∫—Å–∏–º—É–º 12 —Ç–æ—á–µ–∫). –¢–æ—á–∫–∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.</p>
            <div class="image-container" id="contourImageContainer">
                <img id="bgImg" alt="–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
                <svg id="svgOverlay" xmlns="http://www.w3.org/2000/svg"></svg>
                </div>
            <div class="controls">
                <span>–¢–æ—á–µ–∫: <b id="pointCount">0</b>/12</span>
                <button id="undoLastPoint">‚¨ÖÔ∏è –û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
                <button id="clearPoints">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏</button>
                <button id="goToStep3" disabled>–î–∞–ª–µ–µ &rarr;</button>
            </div>
        </section>

        <section id="step3" class="step">
            <h2>–®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–æ–±–æ</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–æ—Ç–∏–ø), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–æ–µ—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º.</p>
            <input id="goboInput" type="file" accept="image/*"> <div id="goboPreview"><span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ–±–æ</span></div>
            <button id="goToStep4" disabled>–î–∞–ª–µ–µ &rarr;</button>
        </section>

        <section id="step4" class="step">
            <h2>–®–∞–≥ 4: –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –≥–æ–±–æ</h2>
            <p>–ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–º–µ—â–µ–Ω–∏—è –≥–æ–±–æ —Å –∫–æ–Ω—Ç—É—Ä–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –æ–±—â–µ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.</p>
            <div class="image-container" id="deformationContainer">
                <img id="bgImgDeform" alt="–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –¥–ª—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏">
                <canvas id="deformation-canvas"></canvas>
                </div>
            <div class="controls">
                <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <input type="range" id="opacitySlider" min="0" max="100" value="100"> <span id="opacityValue">100%</span></label>
                <label>–ú–∞—Å—à—Ç–∞–±: <input type="range" id="scaleSlider" min="10" max="300" value="100"> <span id="scaleValue">100%</span></label>
                <label>–ü–æ–≤–æ—Ä–æ—Ç: <input type="range" id="rotationSlider" min="-180" max="180" value="0"> <span id="rotationValue">0¬∞</span></label>
            </div>
             <div class="controls">
                <button id="toggleGoboVisibility">üëÅÔ∏è –°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å –ì–æ–±–æ</button>
                <button id="undoTransform">‚¨ÖÔ∏è –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
                <button id="resetTransform">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏</button>
                <button id="saveProject">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                <button id="loadProjectInputLabel" onclick="document.getElementById('loadProjectInput').click();">üìÇ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                <input type="file" id="loadProjectInput" class="hidden" accept=".json">
                <button id="runTour">‚ùì –ü–æ–º–æ—â—å</button>
                <button id="goToStep5">–î–∞–ª–µ–µ &rarr;</button>
            </div>
        </section>

        <section id="step5" class="step">
            <h2>–®–∞–≥ 5: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
            <div class="export-controls">
                <label>–ü—Ä–µ—Å–µ—Ç –ø–µ—á–∞—Ç–∏:
                    <select id="printPreset">
                        <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</option>
                        <option value="32,2700,3401">–°—Ç–µ–∫–ª–æ: 32–º–º @ 2700 DPI (3401px)</option>
                        <option value="37.5,600,886">–°–ª–∞–π–¥ 35–º–º: D=37.5–º–º @ 600 DPI (886px)</option>
                        <option value="37.5,1200,1772">–°–ª–∞–π–¥ 35–º–º: D=37.5–º–º @ 1200 DPI (1772px)</option>
                        <option value="50,600,1181">–°–ª–∞–π–¥ 50–º–º: D=50–º–º @ 600 DPI (1181px)</option>
                    </select>
                </label>
                <label>–î–∏–∞–º–µ—Ç—Ä –ø–µ—á–∞—Ç–∏ (–º–º): <input type="number" id="printDiameter" value="32" step="0.1"></label>
                <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (DPI): <input type="number" id="printDPI" value="2700" step="50"></label>
                <label>–†–∞–∑–º–µ—Ä –≤ –ø–∏–∫—Å–µ–ª—è—Ö: <input type="text" id="pixelSize" readonly></label>
            </div>
            <div class="controls">
                <button id="exportPNG">–≠–∫—Å–ø–æ—Ä—Ç –≤ PNG</button>
                <button id="exportTIFF">–≠–∫—Å–ø–æ—Ä—Ç –≤ TIFF (RGBA)</button>
            </div>
            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
            <canvas id="exportPreviewCanvas" style="border:1px solid #ccc; margin-top:10px; max-width: 100%;"></canvas>
        </section>
    </div>

    <div id="notification"></div>

    <script type="text/plain" id="manifest-data">
    {
      "name": "GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-–†–µ–¥–∞–∫—Ç–æ—Ä",
      "short_name": "GOBO–†–µ–¥–∞–∫—Ç–æ—Ä",
      "description": "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–π –≥–æ–±–æ.",
      "start_url": "./index.html?source=pwa", /* –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ PWA */
      "display": "standalone",
      "background_color": "#ffffff",
      "theme_color": "#5a67d8",
      "icons": [
        { "src": "icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
        { "src": "icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
      ]
    }
    </script>

    <script type="text/plain" id="sw-data">
    const CACHE_NAME = 'gobo-calculator-cache-v2.1.3'; // –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –∫–µ—à–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const assetsToCache =;

    self.addEventListener('install', event => {
        event.waitUntil(
            caches.open(CACHE_NAME)
           .then(cache => {
                    console.log('Service Worker: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤');
                    const requests = assetsToCache.map(url => new Request(url, {cache: 'reload'}));
                    return cache.addAll(requests);
                })
           .catch(err => console.error('Service Worker: –û—à–∏–±–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:', err))
        );
        self.skipWaiting(); 
    });

    self.addEventListener('activate', event => {
        event.waitUntil(
            caches.keys().then(cacheNames => {
                return Promise.all(
                    cacheNames.map(cacheName => {
                        if (cacheName!== CACHE_NAME) {
                            console.log('Service Worker: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–µ—à–∞:', cacheName);
                            return caches.delete(cacheName);
                        }
                    })
                );
            })
        );
        return self.clients.claim(); 
    });

    self.addEventListener('fetch', event => {
        event.respondWith(
            caches.match(event.request)
           .then(response => {
                    if (response) { return response; }
                    return fetch(event.request).then(
                        networkResponse => {
                            if(!networkResponse |
| networkResponse.status!== 200 |
| (networkResponse.type!== 'basic' && networkResponse.type!== 'cors')) {
                                return networkResponse; 
                            }
                            const responseToCache = networkResponse.clone();
                            caches.open(CACHE_NAME)
                           .then(cache => { cache.put(event.request, responseToCache); });
                            return networkResponse;
                        }
                    ).catch(() => {
                        // if (event.request.mode === 'navigate' && assetsToCache.includes('./fallback.html')) {
                        //     return caches.match('./fallback.html');
                        // }
                    });
                })
        );
    });
    </script>
    
    <script>
        function startTour(stepsConfig) {
            const defaultTourSteps =;
            const steps = stepsConfig |
| defaultTourSteps;
            //... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ startTour –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞)
            let currentStepIndex = 0;
            let overlay = document.createElement('div');
            let tooltip = document.createElement('div');
            let highlightBox = document.createElement('div');

            function setupOverlay() {
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9998;';
                highlightBox.style.cssText = 'position:absolute;border:3px solid #5a67d8;border-radius:5px;box-shadow:0 0 0 9999px rgba(0,0,0,.7);pointer-events:none;transition:all 0.3s ease-out;';
                tooltip.style.cssText = 'position:absolute;background:#fff;color:#333;padding:15px;border-radius:5px;max-width:300px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.2);';
                overlay.appendChild(highlightBox); 
                document.body.appendChild(overlay);
                document.body.appendChild(tooltip);
                overlay.onclick = endTour; 
            }

            function showStep() {
                if (currentStepIndex >= steps.length) { endTour(); return; }
                const stepData = steps; 
                const targetElement = document.querySelector(stepData.el);
                if (!targetElement) { console.warn('Intro.js: Element not found for step', stepData); currentStepIndex++; showStep(); return; }
                const rect = targetElement.getBoundingClientRect();
                highlightBox.style.left = `${rect.left - 4}px`; highlightBox.style.top = `${rect.top - 4}px`;
                highlightBox.style.width = `${rect.width + 8}px`; highlightBox.style.height = `${rect.height + 8}px`;
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                tooltip.innerHTML = `<p>${stepData.msg}</p><button id="introNextBtn">–î–∞–ª–µ–µ</button> <button id="introSkipBtn" style="float:right;background:transparent;color:#777;border:none;padding:5px;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>`;
                let tooltipTop = rect.bottom + 15; let tooltipLeft = rect.left;
                if (tooltipTop + tooltip.offsetHeight > window.innerHeight) { tooltipTop = rect.top - tooltip.offsetHeight - 15; }
                if (tooltipLeft + tooltip.offsetWidth > window.innerWidth) { tooltipLeft = window.innerWidth - tooltip.offsetWidth - 15; }
                tooltip.style.top = `${tooltipTop}px`; tooltip.style.left = `${tooltipLeft < 0? 15 : tooltipLeft}px`;
                tooltip.querySelector('#introNextBtn').onclick = () => { currentStepIndex++; showStep(); };
                tooltip.querySelector('#introSkipBtn').onclick = endTour;
            }
            function endTour() { if(overlay.parentNode) overlay.remove(); if(tooltip.parentNode) tooltip.remove(); }
            setupOverlay(); showStep();
        }
    </script>

    <script type="text/javascript">
    // (–í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –∫–æ–¥, –Ω–∞—á–∏–Ω–∞—è —Å "–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"
    // –∏ –¥–æ –∫–æ–Ω—Ü–∞, –≤–∫–ª—é—á–∞—è –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è handlePhotoUpload, handleGoboUpload, loadProjectState,
    // setupStep2UI, drawPoly, setupStep4UI, drawDeformedGobo –∏ —Ç.–¥., –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ
    // ID: a1b2c3d4-e5f6-7890-1234-567890abcdef, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å.)
    // –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã–ª–∏ –≤ handlePhotoUpload, sw-data –∏ startTour.
    // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ (ID: a1b2c3d4-e5f6-7890-1234-567890abcdef)
    // –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∫–∞—Å–∞–ª–∏—Å—å —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤—ã—à–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.
    // –Ø –ø—Ä–æ–¥—É–±–ª–∏—Ä—É—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é `handlePhotoUpload` –∏ `setupStep2UI` –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏.

    const $ = q => document.querySelector(q);
    //... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ ID: a1b2c3d4-e5f6-7890-1234-567890abcdef)
    //... –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–µ—Å—å JS –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å `const $$ =...` –∏ –¥–æ –∫–æ–Ω—Ü–∞ `window.onload =...`
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ –ø–æ—è—Å–Ω–µ–Ω–∏—è—Ö –∫ —ç—Ç–æ–º—É –æ—Ç–≤–µ—Ç—É, –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.
    // –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã handlePhotoUpload, setupStep2UI, –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

    // –ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π handlePhotoUpload –∏ setupStep2UI (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ—Ä–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞)
    let currentStep = 1;
    let assignedPoints =;
    let initialGoboContourPoints =;
    let deformationDestPoints =;
    let bgPhoto = { dataURL: null, originalWidth: 0, originalHeight: 0, displayWidth: 0, displayHeight: 0 };
    let goboImage = { img: null, dataURL: null, originalWidth: 0, originalHeight: 0 };
    let transformState = { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, centerX: 0, centerY: 0, baseScale: 1 };
    let historyStack =;
    let contourImageContainer, bgImgElement, svgOverlayElement;
    let deformationContainer, bgImgDeformElement, deformationCanvas, dCtx;
    let exportPreviewCanvas, epCtx;
    const MAX_CONTOUR_POINTS = 12;
    const MAX_PHOTO_DIMENSION = 2000;

    function showNotification(message, duration = 3000) {
        const notification = $('#notification');
        if (!notification) { console.error("–≠–ª–µ–º–µ–Ω—Ç #notification –Ω–µ –Ω–∞–π–¥–µ–Ω!"); return; }
        notification.textContent = message;
        notification.style.display = 'block';
        setTimeout(() => { notification.style.display = 'none'; }, duration);
    }
     function calculateBoundingBox(pointsArray) { /*... –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ... */ 
        if (!pointsArray |
| pointsArray.length === 0) return { minX: 0, minY: 0, maxX: 0, maxY: 0, width: 0, height: 0, cx: 0, cy: 0 };
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        pointsArray.forEach(p => {
            minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
            maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
        });
        const width = maxX - minX; const height = maxY - minY;
        return { minX, minY, maxX, maxY, width, height, cx: minX + width / 2, cy: minY + height / 2 };
    }
    function goToStep(nextStep) { /*... –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ... */ 
        if (nextStep === currentStep) return;
        const csEl = $(`#step${currentStep}`); if(csEl) csEl.classList.remove('active');
        const cpEl = $(`#pStep${currentStep}`); if(cpEl) cpEl.classList.remove('active');
        if (nextStep > currentStep && cpEl) cpEl.classList.add('done');
        currentStep = nextStep;
        const nsEl = $(`#step${currentStep}`); if(nsEl) nsEl.classList.add('active');
        const npEl = $(`#pStep${currentStep}`); if(npEl) npEl.classList.add('active');
        if (currentStep === 2) setupStep2UI(); if (currentStep === 4) setupStep4UI(); if (currentStep === 5) setupStep5UI();
    }

    function initStep1() { /*... –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ... */ 
        const pz = $('#photoZone'), pi = $('#photoInput'); if (!pz ||!pi) return;
        pz.onclick = () => pi.click();
        ['dragover', 'dragleave', 'drop'].forEach(evt => pz.addEventListener(evt, e => {
            e.preventDefault(); e.stopPropagation();
            if (evt === 'dragover') pz.classList.add('dragover'); else pz.classList.remove('dragover');
            if (evt === 'drop') handlePhotoUpload(e.dataTransfer.files);
        }));
        pi.onchange = e => handlePhotoUpload(e.target.files);
        $('#setupAppFiles')?.addEventListener('click', () => { /*... */ });
    }

    function handlePhotoUpload(files) {
        if (!files |
| files.length === 0) { showNotification('–û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.'); return; }
        const file = files;
        if (!file.type.startsWith('image/')) { showNotification('–û—à–∏–±–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.'); return; }
        
        const reader = new FileReader();
        reader.onload = function(e_reader) {
            const img = new Image();
            img.onload = function() {
                bgPhoto.originalWidth = img.width; bgPhoto.originalHeight = img.height;
                let finalDataURL = e_reader.target.result;
                if (img.width > MAX_PHOTO_DIMENSION |
| img.height > MAX_PHOTO_DIMENSION) {
                    const sf = Math.min(MAX_PHOTO_DIMENSION / img.width, MAX_PHOTO_DIMENSION / img.height);
                    const tc = document.createElement('canvas'); tc.width = Math.round(img.width * sf); tc.height = Math.round(img.height * sf);
                    const tctx = tc.getContext('2d'); if (!tctx) { showNotification("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è."); return; }
                    tctx.drawImage(img, 0, 0, tc.width, tc.height);
                    finalDataURL = tc.toDataURL('image/jpeg', 0.9);
                    showNotification(`–§–æ—Ç–æ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ ${tc.width}x${tc.height}px.`);
                }
                bgPhoto.dataURL = finalDataURL;
                assignedPoints =; if ($('#pointCount')) $('#pointCount').textContent = '0';
                const svgO = $('#svgOverlay'); if(svgO) svgO.innerHTML = '';
                const gts3 = $('#goToStep3'); if(gts3) gts3.disabled = true;
                goboImage = { img: null, dataURL: null, originalWidth: 0, originalHeight: 0 };
                const gp = $('#goboPreview'); if(gp) gp.innerHTML = '<span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ–±–æ</span>';
                const gts4 = $('#goToStep4'); if(gts4) gts4.disabled = true;
                historyStack =;
                goToStep(2);
            };
            img.onerror = () => showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Image. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
            img.src = e_reader.target.result;
        };
        reader.onerror = () => showNotification('–û—à–∏–±–∫–∞ FileReader. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        reader.readAsDataURL(file);
    }

    function setupStep2UI() {
        contourImageContainer = $('#contourImageContainer'); bgImgElement = $('#bgImg'); svgOverlayElement = $('#svgOverlay');
        if (!bgImgElement ||!bgPhoto.dataURL ||!contourImageContainer ||!svgOverlayElement) {
            showNotification("–û—à–∏–±–∫–∞ UI –®–∞–≥–∞ 2 –∏–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ."); goToStep(1); return;
        }
        const existingMarkers = contourImageContainer.querySelectorAll('.point-marker');
        existingMarkers.forEach(marker => marker.remove());
        assignedPoints =; 

        bgImgElement.onload = () => {
            bgPhoto.displayWidth = bgImgElement.offsetWidth; bgPhoto.displayHeight = bgImgElement.offsetHeight;
            contourImageContainer.style.width = `${bgPhoto.displayWidth}px`; contourImageContainer.style.height = `${bgPhoto.displayHeight}px`;
            svgOverlayElement.setAttribute('viewBox', `0 0 ${bgPhoto.displayWidth} ${bgPhoto.displayHeight}`);
            updatePointCountAndProceedButton(); drawContourPolygon();
        };
        bgImgElement.onerror = () => { showNotification("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ –Ω–∞ –®–∞–≥–µ 2."); goToStep(1); };
        bgImgElement.src = bgPhoto.dataURL;
        if (bgImgElement.complete && bgImgElement.naturalWidth > 0) bgImgElement.onload();
    }

    // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ü–û–õ–ù–´–ô –û–°–¢–ê–í–®–ò–ô–°–Ø JavaScript –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
    // (ID: a1b2c3d4-e5f6-7890-1234-567890abcdef), –Ω–∞—á–∏–Ω–∞—è —Å —Ñ—É–Ω–∫—Ü–∏–∏ `initStep2()`
    // –∏ –¥–æ –∫–æ–Ω—Ü–∞, –≤–∫–ª—é—á–∞—è `registerServiceWorker()` –∏ `window.onload`.
    // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ –ø–æ—è—Å–Ω–µ–Ω–∏—è—Ö –∫ —ç—Ç–æ–º—É –æ—Ç–≤–µ—Ç—É, –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.
    //... (–ø–æ–ª–Ω—ã–π JS –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)...
    //...
    // –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ JS –∫–æ–¥–∞
    // –ü—Ä–∏–º–µ—Ä window.onload
     window.onload = () => {
        initStep1(); initStep2(); initStep3(); 
        // initStep4Controls –∏ initStep5Controls –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –ø–æ–ª–Ω–æ–º –∫–æ–¥–µ
        if(typeof initStep4Controls === 'function') initStep4Controls(); else console.error("initStep4Controls –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞");
        if(typeof initStep5Controls === 'function') initStep5Controls(); else console.error("initStep5Controls –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞");
        registerServiceWorker();
    };
    </script>
</body>
</html>
