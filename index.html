<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>GOBO Calculator PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D3748">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #222;
    }
    header {
      background: #2D3748;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 960px;
      margin: auto;
      padding: 1rem;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    canvas {
      border: 1px solid #ccc;
      max-width: 100%;
      display: block;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
    }
    .controls label {
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
    }
    .actions {
      margin: 1rem 0;
    }
    .actions button {
      margin-right: 0.5rem;
    }
    .point {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: red;
      position: absolute;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }
    #canvasWrapper {
      position: relative;
    }
    #photo {
      display: block;
      max-width: 100%;
      height: auto;
    }
    #editorCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 5;
    }
  </style>
</head>
<body>
  <header>
    <h1>GOBO Calculator PRO + PDF</h1>
    <p>–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ç–æ—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
  </header>
  <div class="container">
    <input type="file" id="photoInput" accept="image/*">
    <input type="file" id="goboInput" accept="image/*">

    <div id="canvasWrapper">
      <img id="photo" alt="–§–æ—Ç–æ" />
      <canvas id="editorCanvas"></canvas>
    </div>

    <div class="controls">
      <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
        <input type="range" id="opacitySlider" min="0" max="100" value="100">
      </label>
      <label>–ú–∞—Å—à—Ç–∞–±
        <input type="range" id="scaleSlider" min="10" max="300" value="100">
      </label>
      <label>–ü–æ–≤–æ—Ä–æ—Ç
        <input type="range" id="rotateSlider" min="-180" max="180" value="0">
      </label>
      <label>–î–∏–∞–º–µ—Ç—Ä —Å–ª–∞–π–¥–∞ (–º–º)
        <input type="number" id="slideDiameter" min="10" max="100" value="32">
      </label>
    </div>

    <div class="actions">
      <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      <button id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      <button id="exportPNG">üì§ PNG</button>
      <button id="exportTIFF">üì§ TIFF</button>
      <button id="exportPDF">üìÑ PDF</button>
    </div>

    <div>
      <p>–î–æ–±–∞–≤—å—Ç–µ –¥–æ 32 —Ç–æ—á–µ–∫, —â—ë–ª–∫–∞—è –ø–æ —Ñ–æ—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—ã—à—å –∏–ª–∏ –∫–∞—Å–∞–Ω–∏–µ.</p>
      <button id="undo">‚Ü∂ Undo</button>
      <button id="redo">‚Ü∑ Redo</button>
      <button id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
  <script>
    let photo = document.getElementById("photo");
    let canvas = document.getElementById("editorCanvas");
    let ctx = canvas.getContext("2d");
    let points = [];
    let project = { x: 0, y: 0, scale: 1, rotate: 0, opacity: 1 };
    let goboImg = null;
    let history = [], future = [];

    function resizeCanvasToImage() {
      canvas.width = photo.naturalWidth;
      canvas.height = photo.naturalHeight;
      canvas.style.width = photo.clientWidth + "px";
      canvas.style.height = photo.clientHeight + "px";
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!goboImg) return;
      ctx.save();
      ctx.globalAlpha = project.opacity;
      ctx.translate(project.x, project.y);
      ctx.rotate(project.rotate * Math.PI / 180);
      ctx.scale(project.scale, project.scale);
      ctx.translate(-goboImg.width / 2, -goboImg.height / 2);
      ctx.drawImage(goboImg, 0, 0);
      ctx.restore();
    }

    function updateControls() {
      project.opacity = opacitySlider.value / 100;
      project.scale = scaleSlider.value / 100;
      project.rotate = +rotateSlider.value;
      draw();
    }

    document.getElementById("photoInput").onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        photo.src = ev.target.result;
        photo.onload = () => {
          resizeCanvasToImage();
          draw();
        };
      };
      reader.readAsDataURL(file);
    };

    document.getElementById("goboInput").onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        goboImg = new Image();
        goboImg.onload = () => draw();
        goboImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    };

    opacitySlider.oninput = updateControls;
    scaleSlider.oninput = updateControls;
    rotateSlider.oninput = updateControls;

    canvas.addEventListener("click", e => {
      if (points.length >= 32) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      points.push({ x, y });
      const div = document.createElement("div");
      div.className = "point";
      div.style.left = e.clientX + "px";
      div.style.top = e.clientY + "px";
      document.getElementById("canvasWrapper").appendChild(div);
      saveState();
    });

    function saveState() {
      history.push(JSON.stringify({ points, project }));
      if (history.length > 100) history.shift();
      future = [];
    }

    undo.onclick = () => {
      if (history.length > 0) {
        future.push(JSON.stringify({ points, project }));
        let state = JSON.parse(history.pop());
        points = state.points;
        project = state.project;
        draw();
      }
    };

    redo.onclick = () => {
      if (future.length > 0) {
        history.push(JSON.stringify({ points, project }));
        let state = JSON.parse(future.pop());
        points = state.points;
        project = state.project;
        draw();
      }
    };

    clear.onclick = () => {
      points = [];
      draw();
      document.querySelectorAll(".point").forEach(p => p.remove());
      saveState();
    };

    saveBtn.onclick = () => {
      const blob = new Blob(
        [JSON.stringify({ points, project, gobo: goboImg?.src, photo: photo.src })],
        { type: "application/json" }
      );
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "gobo-project.json";
      a.click();
    };

    loadBtn.onclick = () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const data = JSON.parse(ev.target.result);
          points = data.points;
          project = data.project;
          photo.src = data.photo;
          goboImg = new Image();
          goboImg.src = data.gobo;
          goboImg.onload = () => {
            photo.onload = () => {
              resizeCanvasToImage();
              draw();
            };
          };
        };
        reader.readAsText(file);
      };
      input.click();
    };

    function mmToPx(mm, dpi = 2700) {
      return Math.round((mm / 25.4) * dpi);
    }

    exportPNG.onclick = () => {
      const px = mmToPx(+slideDiameter.value);
      const temp = document.createElement("canvas");
      temp.width = temp.height = px;
      const ctx2 = temp.getContext("2d");
      ctx2.fillStyle = "black";
      ctx2.beginPath();
      ctx2.arc(px / 2, px / 2, px / 2, 0, 2 * Math.PI);
      ctx2.fill();
      ctx2.drawImage(canvas, 0, 0, px, px);
      temp.toBlob(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "gobo.png";
        a.click();
      });
    };

    exportPDF.onclick = async () => {
      const px = mmToPx(+slideDiameter.value);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: [px * 0.75, px * 0.75]
      });
      const temp = document.createElement("canvas");
      temp.width = temp.height = px;
      const ctx2 = temp.getContext("2d");
      ctx2.fillStyle = "black";
      ctx2.beginPath();
      ctx2.arc(px / 2, px / 2, px / 2, 0, 2 * Math.PI);
      ctx2.fill();
      ctx2.drawImage(canvas, 0, 0, px, px);
      const dataUrl = temp.toDataURL("image/png");
      pdf.addImage(dataUrl, 'PNG', 0, 0, px * 0.75, px * 0.75);
      pdf.save("gobo.pdf");
    };

    exportTIFF.onclick = () => {
      alert("TIFF-—ç–∫—Å–ø–æ—Ä—Ç –ø–æ–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω (–≤—Å—Ç—Ä–æ—é –ø–æ –∑–∞–ø—Ä–æ—Å—É). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PNG –∏–ª–∏ PDF.");
    };
  </script>
</body>
</html>
