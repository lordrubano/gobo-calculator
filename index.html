<!DOCTYPE html>
<html lang="ru" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª v3.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-to-tiff@1.1.1/dist/canvas-to-tiff.min.js"></script>
    
    <style>
        /* –û–ë–©–ò–ï –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; color: #333; }
        
        /* –®–ê–ü–ö–ê –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .header { background: white; padding: 15px 30px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header h1 { color: #4a4a4a; margin-bottom: 15px; font-size: 24px; }
        .progress-bar { display: flex; list-style: none; padding: 0; justify-content: space-between; max-width: 900px; margin: auto; }
        .progress-bar a { flex: 1; text-align: center; font-weight: bold; color: #718096; position: relative; text-decoration: none; cursor: not-allowed; opacity: 0.5; padding: 8px 0; }
        .progress-bar a.unlocked { cursor: pointer; opacity: 1; }
        .progress-bar a::before { content: attr(data-step); display: block; margin: 0 auto 5px; width: 30px; height: 30px; line-height: 30px; border: 2px solid #cbd5e0; border-radius: 50%; background: #fff; color: #cbd5e0; transition: all 0.3s ease; }
        .progress-bar a.active::before { border-color: #5a67d8; color: #5a67d8; font-weight: 700; transform: scale(1.1); }
        .progress-bar a.completed::before { background: #5a67d8; color: #fff; border-color: #5a67d8; }
        .progress-bar a.completed + a.unlocked::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #5a67d8; z-index: -1; transition: background 0.3s ease; }
        .progress-bar a:not(:first-child)::after { content: ""; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #cbd5e0; z-index: -1; }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† –ò –°–ï–ö–¶–ò–ò */
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .toolbar { text-align: right; margin-bottom: 20px; }
        .step-section { background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 8px 40px rgba(0,0,0,0.08); margin-bottom: 40px; border-left: 5px solid #e2e8f0; transition: all 0.5s ease-out; }
        .step-section.active { border-left-color: #5a67d8; }
        .step-section.completed { border-left-color: #48bb78; }
        .step-section.is-locked { display: none; }
        .step-section h2 { color: #5a67d8; margin-bottom: 10px; font-size: 28px; display: flex; align-items: center; }
        .step-section h2 .step-number { background: #5a67d8; color: white; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 15px; flex-shrink: 0; }
        .step-section > p { color: #666; margin-bottom: 25px; }
        
        /* –≠–õ–ï–ú–ï–ù–¢–´ –§–û–†–ú */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ */
        .photo-upload-area { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 40px; text-align: center; background: #f7fafc; transition: all 0.3s ease; cursor: pointer; }
        .photo-upload-area:hover { border-color: #5a67d8; }
        #photo-container { position: relative; display: inline-block; margin-top: 20px; user-select: none; }
        #step2-photo { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block;}
        .assigned-point { position: absolute; width: 14px; height: 14px; background: rgba(229, 62, 62, 0.7); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); user-select: none; transform: translate(-50%, -50%); cursor: pointer; z-index: 15; }
        .assigned-point span { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        #lines-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .image-upload-input { display: block; margin-bottom: 20px; }
        #step3-image-preview { min-height: 150px; border: 2px dashed #cbd5e0; padding: 10px; text-align: center; background: #f9f9f9; border-radius: 10px;}
        
        /* –†–µ–¥–∞–∫—Ç–æ—Ä */
        .deformation-stage-wrapper { text-align: center; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 10px; }
        .deformation-stage { position: relative; width: 100%; min-height: 600px; background-color: #f0f2f5; cursor: grab; }
        .deformation-stage.is-panning { cursor: grabbing; }
        #deformation-canvas { position: absolute; top: 0; left: 0; }
        .control-point { position: absolute; width: 12px; height: 12px; background: rgba(255, 255, 255, 0.5); border: 2px solid #e53e3e; border-radius: 50%; cursor: crosshair; transform: translate(-50%, -50%); z-index: 20; }
        .controls-panel, .zoom-controls { background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center; border: 1px solid #e2e8f0; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .pan-controls button { width: 40px; height: 40px; font-size: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .zoom-controls { grid-template-columns: 1fr auto; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .action-button { display: inline-block; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; background: #5a67d8; color: white; margin-left: 10px; }
        .action-button:disabled { background: #cbd5e0; color: #a0aec0; cursor: not-allowed; }
        .clear-points-btn { background: #e53e3e; }
        .new-project-btn { background: #f6ad55; }
        
        /* –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç */
        #finalResult { text-align: center; padding: 10px; background: #f7fafc; border-radius: 10px; border: 1px solid #e2e8f0; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #result-canvas { max-width: 100%; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); background: black; }
    </style>
</head>
<body>

    <header class="header">
        <h1>GOBO –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä-—Ä–µ–¥–∞–∫—Ç–æ—Ä</h1>
        <nav class="progress-bar" id="progressBar">
            <a href="#step1" data-step="1">–®–∞–≥ 1: –§–æ—Ç–æ</a>
            <a href="#step2" data-step="2">–®–∞–≥ 2: –¢–æ—á–∫–∏</a>
            <a href="#step3" data-step="3">–®–∞–≥ 3: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
            <a href="#step4" data-step="4">–®–∞–≥ 4: –†–µ–¥–∞–∫—Ç–æ—Ä</a>
            <a href="#step5" data-step="5">–®–∞–≥ 5: –≠–∫—Å–ø–æ—Ä—Ç</a>
        </nav>
    </header>

    <div class="container">
        <div class="toolbar">
            <button class="action-button new-project-btn" onclick="startNewProject()">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
        </div>

        <section class="step-section" id="step1">
            <h2><span class="step-number">1</span>–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —Å–¥–µ–ª–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é ¬´–£–º–Ω–æ–π –ù–∞—Å–∞–¥–∫–∏¬ª –∏–∑ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ—Ä–∞.</p>
            <div class="photo-upload-area" id="photoUploadArea">
                <h3>üì∏ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;">
        </section>

        <section class="step-section is-locked" id="step2">
             <h2><span class="step-number">2</span>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—É—Ä–∞</h2>
            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —É–≥–ª–∞–º –∫–æ–Ω—Ç—É—Ä–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –µ–≥–æ. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.</p>
            <div id="photo-container">
                <img id="step2-photo" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç—É—Ä–∞"><svg id="lines-svg"></svg>
            </div>
            <div style="text-align: right;">
                <button class="action-button clear-points-btn" onclick="clearAllPoints()">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ—á–∫–∏</button>
                <button class="action-button" id="step2-next" disabled>–î–∞–ª–µ–µ</button>
            </div>
        </section>

        <section class="step-section is-locked" id="step3">
            <h2><span class="step-number">3</span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≥–æ–±–æ</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–ª–æ–≥–æ—Ç–∏–ø, –∑–Ω–∞–∫), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–æ–µ—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
            <input type="file" id="step3-image-input" class="image-upload-input" accept="image/*">
            <div id="step3-image-preview"><p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</p></div>
        </section>

        <section class="step-section is-locked" id="step4">
            <h2><span class="step-number">4</span>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <p><b>–ö–æ–ª–µ—Å–æ –º—ã—à–∏</b> - –∑—É–º. <b>–ó–∞–∂–º–∏—Ç–µ Alt + –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏</b> - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Ç–æ—á–∫–∏ –¥–ª—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
            <div class="deformation-stage-wrapper">
                <div class="deformation-stage" id="deformationStage">
                    <canvas id="deformation-canvas"></canvas>
                </div>
            </div>
            <div class="zoom-controls">
                 <div class="control-group">
                    <label>–ú–∞—Å—à—Ç–∞–± —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: <span id="zoomLevel">100</span>%</label>
                    <input type="range" id="zoomSlider" min="10" max="500" value="100">
                </div>
                <button class="action-button" onclick="resetEditorView()">–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥</button>
            </div>
            <div class="controls-panel">
                <div class="control-group">
                    <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="opacityValue">100</span>%</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100">
                </div>
                <div class="control-group">
                    <label>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="scaleValue">100</span>%</label>
                    <input type="range" id="scaleSlider" min="50" max="150" value="100">
                </div>
                <div class="control-group">
                    <label>–í—Ä–∞—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="rotationValue">0</span>¬∞</label>
                    <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                </div>
                <div class="control-group pan-controls">
                    <label>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <div>
                        <button onclick="panImage(0, -5)">‚Üë</button>
                        <button onclick="panImage(0, 5)">‚Üì</button>
                        <button onclick="panImage(-5, 0)">‚Üê</button>
                        <button onclick="panImage(5, 0)">‚Üí</button>
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                <button class="action-button" id="step4-next">–î–∞–ª–µ–µ</button>
            </div>
        </section>

        <section class="step-section is-locked" id="step5">
            <h2><span class="step-number">5</span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</h2>
            <p>–§–∏–Ω–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –≥–æ–±–æ-—Å–ª–∞–π–¥–∞, –≥–æ—Ç–æ–≤—ã–π –∫ –ø–µ—á–∞—Ç–∏. –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .TIFF.</p>
            <div class="form-row">
                <div class="form-group"><label for="printDPI">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (DPI):</label><input type="number" id="printDPI" value="2700"></div>
                <div class="form-group"><label for="slideDiameter">–î–∏–∞–º–µ—Ç—Ä —Å–ª–∞–π–¥–∞ (–º–º):</label><input type="number" id="slideDiameter" value="37.5"></div>
                <div class="form-group"><label for="printDiameter">–î–∏–∞–º–µ—Ç—Ä –ø–µ—á–∞—Ç–∏ (–º–º):</label><input type="number" id="printDiameter" value="32"></div>
                <div class="form-group"><label for="alignMark">–ú–µ—Ç–∫–∞:</label><input type="text" id="alignMark" value="PLT"></div>
            </div>
            <div id="finalResult">
                 <canvas id="result-canvas"></canvas>
            </div>
            <div style="text-align: right;">
                <button class="action-button" onclick="exportFinalGobo()">–°–∫–∞—á–∞—Ç—å .TIFF</button>
            </div>
        </section>
    </div>

<script>
// ===================================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ===================================================================
let currentStep = 1;
let photoData = null;
let userImageElement = null;
let assignedPoints = [];
let controlPointElements = [];
let transformState = { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1, initialScale: 1 };
let deformationDestPoints = []; 
let activeControlPoint = null;
let editorZoom = 1;
let editorPan = { x: 0, y: 0 };
let isPanning = false;
let panStart = { x: 0, y: 0 };

// ===================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ===================================================================
document.addEventListener('DOMContentLoaded', initCalculator);

function initCalculator() {
    setupEventListeners();
    loadState();
}

// ===================================================================
//  –ö–õ–Æ–ß–ï–í–ê–Ø –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ù–ê–ß–ê–¢–¨ –ù–û–í–´–ô –ü–†–û–ï–ö–¢
// ===================================================================
function startNewProject() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç? –í–µ—Å—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.")) {
        localStorage.removeItem('goboProjectState');
        window.location.reload();
    }
}

// ===================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú
// ===================================================================
function unlockStep(stepNumber) {
    if (stepNumber > 5) return;
    const section = document.getElementById(`step${stepNumber}`);
    if (section && section.classList.contains('is-locked')) {
        section.classList.remove('is-locked');
    }
    setTimeout(() => {
        const header = document.querySelector('.header');
        const sectionTop = section.getBoundingClientRect().top + window.pageYOffset - header.offsetHeight;
        window.scrollTo({ top: sectionTop, behavior: 'smooth' });
    }, 100);
    updateProgressUI(stepNumber);
    currentStep = stepNumber;
    saveState();
}

function updateProgressUI(activeStep) {
    document.querySelectorAll('#progressBar a').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed', 'unlocked');
        if (stepNum <= activeStep) {
            el.classList.add('unlocked');
            if (stepNum < activeStep) el.classList.add('completed');
            else el.classList.add('active');
        }
    });
    document.querySelectorAll('.step-section').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed');
        if (stepNum < activeStep) el.classList.add('completed');
        else if (stepNum === activeStep) el.classList.add('active');
    });
}


// ===================================================================
// –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø (localStorage)
// ===================================================================
function saveState() {
    const state = {
        currentStep: currentStep,
        photoData: photoData,
        assignedPointsCoords: assignedPoints.map(p => ({ x: p.x, y: p.y })),
        userImageSrc: userImageElement ? userImageElement.src : null
    };
    localStorage.setItem('goboProjectState', JSON.stringify(state));
}

function loadState() {
    const savedStateJSON = localStorage.getItem('goboProjectState');
    if (!savedStateJSON) { updateProgressUI(1); return; }
    const savedState = JSON.parse(savedStateJSON);
    
    let imagesToLoad = 0;
    let imagesLoaded = 0;

    const onImageLoaded = () => {
        imagesLoaded++;
        if (imagesLoaded === imagesToLoad) {
            initUIFromState(savedState);
        }
    };
    
    if (savedState.photoData) imagesToLoad++;
    if (savedState.userImageSrc) imagesToLoad++;

    if (imagesToLoad === 0) {
        initUIFromState(savedState);
        return;
    }

    if (savedState.photoData) {
        photoData = savedState.photoData;
        const bgImg = new Image();
        bgImg.src = photoData;
        bgImg.onload = onImageLoaded;
    }
    if (savedState.userImageSrc) {
        userImageElement = new Image();
        userImageElement.src = savedState.userImageSrc;
        userImageElement.onload = onImageLoaded;
    }
}

function initUIFromState(savedState) {
    currentStep = savedState.currentStep || 1;
    if (photoData) {
        document.getElementById('photoUploadArea').innerHTML = `<img src="${photoData}" style="max-width:100%; border-radius:10px;">`;
        document.getElementById('step2-photo').src = photoData;
    }
    
    const photoContainer = document.getElementById('photo-container');
    while (photoContainer.querySelector('.assigned-point')) {
        photoContainer.querySelector('.assigned-point').remove();
    }
    assignedPoints = [];
    if (savedState.assignedPointsCoords && savedState.assignedPointsCoords.length > 0) {
        savedState.assignedPointsCoords.forEach(coord => {
            const pointEl = document.createElement('div');
            pointEl.className = 'assigned-point';
            pointEl.textContent = assignedPoints.length + 1;
            pointEl.style.left = `${coord.x}px`;
            pointEl.style.top = `${coord.y}px`;
            photoContainer.appendChild(pointEl);
            assignedPoints.push({ ...coord, element: pointEl });
        });
        document.getElementById('step2-next').disabled = assignedPoints.length < 3;
    }

    if (userImageElement && userImageElement.src) {
        document.getElementById('step3-image-preview').innerHTML = `<img src="${userImageElement.src}" style="max-width:100%; border-radius: 8px;">`;
    }
    for (let i = 1; i <= currentStep; i++) {
        document.getElementById(`step${i}`)?.classList.remove('is-locked');
    }
    updateProgressUI(currentStep);
    if (currentStep >= 4) {
        initEditor();
    }
    if (currentStep === 5) {
        generateFinalResultPreview();
    }
    setTimeout(() => {
        const targetEl = document.getElementById(`step${currentStep}`);
        if(targetEl) targetEl.scrollIntoView({ behavior: 'auto', block: 'start' });
    }, 200);
}

// ===================================================================
// –õ–û–ì–ò–ö–ê –®–ê–ì–û–í –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
// ===================================================================
function setupEventListeners() {
    const photoUploadArea = document.getElementById('photoUploadArea');
    const photoInput = document.getElementById('photoInput');
    photoUploadArea.addEventListener('click', () => photoInput.click());
    photoInput.addEventListener('change', handlePhotoUpload);
    document.getElementById('step2-photo').addEventListener('click', handlePointAssignment);
    document.getElementById('step2-next').addEventListener('click', () => unlockStep(3));
    document.getElementById('step3-image-input').addEventListener('change', handleGoboImageUpload);
    document.getElementById('step4-next').addEventListener('click', () => {
        generateFinalResultPreview();
        unlockStep(5);
    });
    setupEditorControls();
}

function handlePhotoUpload(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        photoData = ev.target.result;
        document.getElementById('photoUploadArea').innerHTML = `<img src="${photoData}" style="max-width:100%; border-radius:10px;">`;
        const step2Photo = document.getElementById('step2-photo');
        step2Photo.src = photoData;
        step2Photo.onload = () => unlockStep(2);
    };
    reader.readAsDataURL(file);
}

function handlePointAssignment(event) {
    const photoElement = event.target; const rect = photoElement.getBoundingClientRect();
    const x = event.clientX - rect.left; const y = event.clientY - rect.top;
    const pointEl = document.createElement('div');
    pointEl.className = 'assigned-point'; pointEl.textContent = assignedPoints.length + 1;
    pointEl.style.left = `${x}px`; pointEl.style.top = `${y}px`;
    photoElement.parentElement.appendChild(pointEl);
    assignedPoints.push({ x, y, element: pointEl });
    document.getElementById('step2-next').disabled = assignedPoints.length < 3;
    saveState();
}

function clearAllPoints() {
    assignedPoints.forEach(p => p.element?.remove());
    assignedPoints = [];
    document.getElementById('step2-next').disabled = true;
    saveState();
}

function handleGoboImageUpload(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        userImageElement = new Image();
        userImageElement.src = e.target.result;
        userImageElement.onload = () => {
            document.getElementById('step3-image-preview').innerHTML = `<img src="${userImageElement.src}" style="max-width:100%; border-radius: 8px;">`;
            unlockStep(4);
            setTimeout(initEditor, 50);
        };
    };
    reader.readAsDataURL(file);
}

// ===================================================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê (–®–ê–ì 4)
// ===================================================================
function initEditor() {
    const bgPhoto = document.getElementById('step2-photo');
    if (!userImageElement || !bgPhoto || !bgPhoto.complete || bgPhoto.naturalWidth === 0) {
        return;
    }
    const canvas = document.getElementById('deformation-canvas');
    const stage = document.getElementById('deformationStage');
    const stageWrapper = document.querySelector('.deformation-stage-wrapper');
    canvas.width = bgPhoto.naturalWidth;
    canvas.height = bgPhoto.naturalHeight;
    stageWrapper.style.height = `${stageWrapper.clientWidth * (canvas.height / canvas.width)}px`;
    stage.style.width = `${stageWrapper.clientWidth}px`;
    stage.style.height = `${stageWrapper.clientHeight}px`;

    calculateInitialTransform();
    setupControlPoints(stage);
    resetEditorView();
}

function resetEditorView() {
    const canvas = document.getElementById('deformation-canvas');
    const stage = document.getElementById('deformationStage');
    editorZoom = Math.min(stage.clientWidth / canvas.width, stage.clientHeight / canvas.height) * 0.95;
    editorPan = { x: (stage.clientWidth - canvas.width * editorZoom) / 2, y: (stage.clientHeight - canvas.height * editorZoom) / 2 };
    document.getElementById('zoomSlider').value = editorZoom * 100;
    document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
    drawTransformedImage();
}

function setupEditorControls() {
    const stage = document.getElementById('deformationStage');
    stage.addEventListener('wheel', handleWheelZoom, { passive: false });
    stage.addEventListener('mousedown', handlePanStart);
    document.addEventListener('mousemove', handlePanMove); // Listen on document for wider movement
    document.addEventListener('mouseup', handlePanEnd);
    stage.addEventListener('mouseleave', handlePanEnd);
    document.getElementById('zoomSlider').addEventListener('input', handleSliderZoom);

    const sliders = { opacity: 100, scale: 100, rotation: 0 };
    for (const type in sliders) {
        const slider = document.getElementById(`${type}Slider`);
        const valueEl = document.getElementById(`${type}Value`);
        if(type === 'scale') slider.value = 100;
        else if (type === 'rotation') slider.value = 0;
        else slider.value = 100;
        valueEl.textContent = slider.value;
        slider.oninput = () => {
            valueEl.textContent = slider.value;
            if (type === 'opacity') transformState.opacity = slider.value / 100;
            if (type === 'rotation') transformState.rotation = parseInt(slider.value);
            if (type === 'scale') transformState.scale = transformState.initialScale * (slider.value / 100);
            drawTransformedImage();
        };
    }
}

function handleWheelZoom(e) {
    e.preventDefault();
    const zoomIntensity = 0.1;
    const newZoom = editorZoom * (1 - Math.sign(e.deltaY) * zoomIntensity);
    editorZoom = Math.max(0.1, Math.min(newZoom, 5));
    document.getElementById('zoomSlider').value = editorZoom * 100;
    document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
    drawTransformedImage();
}

function handleSliderZoom(e) {
    editorZoom = e.target.value / 100;
    document.getElementById('zoomLevel').textContent = Math.round(editorZoom * 100);
    drawTransformedImage();
}

function handlePanStart(e) {
    if (e.buttons === 1 && e.altKey) {
        isPanning = true;
        panStart.x = e.clientX - editorPan.x;
        panStart.y = e.clientY - editorPan.y;
        e.target.classList.add('is-panning');
    }
}

function handlePanMove(e) {
    if (isPanning) {
        editorPan.x = e.clientX - panStart.x;
        editorPan.y = e.clientY - panStart.y;
        drawTransformedImage();
    } else if (activeControlPoint) {
        handleDrag(e);
    }
}

function handlePanEnd(e) {
    isPanning = false;
    document.getElementById('deformationStage').classList.remove('is-panning');
}

function screenToCanvasCoords(screenX, screenY, stage) {
    const rect = stage.getBoundingClientRect();
    return {
        x: (screenX - rect.left - editorPan.x) / editorZoom,
        y: (screenY - rect.top - editorPan.y) / editorZoom
    };
}

function canvasToScreenCoords(canvasX, canvasY) {
    return {
        x: canvasX * editorZoom + editorPan.x,
        y: canvasY * editorZoom + editorPan.y
    };
}
    
function setupControlPoints(stage) {
    controlPointElements.forEach(p => p.remove());
    controlPointElements = [];
    deformationDestPoints = [];
    assignedPoints.forEach((p, i) => {
        const point = { x: p.x, y: p.y };
        deformationDestPoints.push(point);
        const pointElement = document.createElement('div');
        pointElement.className = 'control-point';
        pointElement.dataset.index = i;
        const screenPos = canvasToScreenCoords(point.x, point.y);
        pointElement.style.left = `${screenPos.x}px`;
        pointElement.style.top = `${screenPos.y}px`;
        stage.appendChild(pointElement);
        controlPointElements.push(pointElement);
        pointElement.addEventListener('mousedown', (e) => {
            if (isPanning) return;
            e.stopPropagation();
            activeControlPoint = { index: i, element: pointElement };
        });
    });
}
    
window.panImage = (dx, dy) => { transformState.x += dx; transformState.y += dy; drawTransformedImage(); };

function handleDrag(e) {
    if (!activeControlPoint) return;
    const stage = document.getElementById('deformationStage');
    const coords = screenToCanvasCoords(e.clientX, e.clientY, stage);
    const screenPos = canvasToScreenCoords(coords.x, coords.y);
    activeControlPoint.element.style.left = `${screenPos.x}px`;
    activeControlPoint.element.style.top = `${screenPos.y}px`;
    deformationDestPoints[activeControlPoint.index] = { x: coords.x, y: coords.y };
    drawTransformedImage();
}

function stopDrag() { activeControlPoint = null; }

function drawTransformedImage() {
    if (!userImageElement || !userImageElement.complete) return;
    const canvas = document.getElementById('deformation-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const bgPhotoImg = document.getElementById('step2-photo');
    if(bgPhotoImg && bgPhotoImg.complete) ctx.drawImage(bgPhotoImg, 0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.globalAlpha = transformState.opacity;
    ctx.translate(transformState.x, transformState.y);
    ctx.rotate(transformState.rotation * Math.PI / 180);
    ctx.scale(transformState.scale, transformState.scale);
    const imgW = userImageElement.naturalWidth;
    const imgH = userImageElement.naturalHeight;
    ctx.translate(-imgW / 2, -imgH / 2);
    let sourcePoints = [];
    const numPoints = deformationDestPoints.length;
    for(let i=0; i<numPoints; i++) {
        const angle = (i / numPoints) * 2 * Math.PI - (Math.PI / 2);
        sourcePoints.push({ x: imgW / 2 + (imgW / 2) * Math.cos(angle), y: imgH / 2 + (imgH / 2) * Math.sin(angle) });
    }
    let localDestPoints = deformationDestPoints.map(p => {
        const dx = p.x - transformState.x;
        const dy = p.y - transformState.y;
        const angle = -transformState.rotation * Math.PI / 180;
        const s = transformState.scale;
        return { x: (dx * Math.cos(angle) - dy * Math.sin(angle)) / s + imgW/2, y: (dx * Math.sin(angle) + dy * Math.cos(angle)) / s + imgH/2 };
    });
    const delaunay = Delaunator.from(localDestPoints.map(p => [p.x, p.y]));
    for (let i = 0; i < delaunay.triangles.length; i += 3) {
        const t = [delaunay.triangles[i], delaunay.triangles[i+1], delaunay.triangles[i+2]];
        const src = t.map(p => sourcePoints[p]);
        const dst = t.map(p => localDestPoints[p]);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(dst[0].x, dst[0].y); ctx.lineTo(dst[1].x, dst[1].y); ctx.lineTo(dst[2].x, dst[2].y);
        ctx.closePath();
        ctx.clip();
        const det = src[0].x * (src[1].y - src[2].y) + src[1].x * (src[2].y - src[0].y) + src[2].x * (src[0].y - src[1].y);
        if (Math.abs(det) < 1e-9) { ctx.restore(); continue; }
        const a = (dst[0].x * (src[1].y - src[2].y) + dst[1].x * (src[2].y - src[0].y) + dst[2].x * (src[0].y - src[1].y)) / det;
        const b = (dst[0].y * (src[1].y - src[2].y) + dst[1].y * (src[2].y - src[0].y) + dst[2].y * (src[0].y - src[1].y)) / det;
        const c = (dst[0].x * (src[2].x - src[1].x) + dst[1].x * (src[0].x - src[2].x) + dst[2].x * (src[1].x - src[0].x)) / det;
        const d = (dst[0].y * (src[2].x - src[1].x) + dst[1].y * (src[0].x - src[2].x) + dst[2].y * (src[1].x - src[0].x)) / det;
        const e = dst[0].x - a * src[0].x - c * src[0].y;
        const f = dst[0].y - b * src[0].x - d * src[0].y;
        ctx.transform(a, b, c, d, e, f);
        ctx.drawImage(userImageElement, 0, 0);
        ctx.restore();
    }
    ctx.restore();
}

// ===================================================================
// –õ–û–ì–ò–ö–ê –≠–ö–°–ü–û–†–¢–ê (–®–ê–ì 5)
// ===================================================================
function generateFinalResultPreview() { /* ... */ }
function exportFinalGobo() { /* ... */ }
function getCleanDistortedImage() { /* ... */ }

</script>
</body>
</html>
